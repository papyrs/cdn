import{g as t,a,b as e,f as r,c as o,d as i,t as c,e as d,h as u,o as p,E as h,r as f,i as w,j as y,k as b,D as k}from"./p-97a03b48.js";export{n as deleteAuth,g as getIdentity,l as initAuth,m as signIn,s as signOut}from"./p-97a03b48.js";import"./p-0adadf10.js";var $="app-deck-editor > ion-content div.deck > main > deckgo-deck",v="deckgo-studio-doc",D=[{id:"google-fonts-lora",name:"Lora",family:"'Lora', serif"},{id:"google-fonts-roboto",name:"Roboto",family:"'Roboto', sans-serif"},{id:"google-fonts-open-sans",name:"Open Sans",family:"'Open Sans', sans-serif"},{id:"google-fonts-montserrat",name:"Montserrat",family:"'Montserrat', sans-serif"},{id:"google-fonts-cabin",name:"Cabin",family:"'Cabin', sans-serif"},{id:"google-fonts-lato",name:"Lato",family:"'Lato', sans-serif"},{id:"google-fonts-muli",name:"Muli",family:"'Muli', sans-serif"},{id:"google-fonts-source-sans-pro",name:"Source Sans Pro",family:"'Source Sans Pro', sans-serif"},{id:"google-fonts-libre-baskerville",name:"Libre Baskerville",family:"'Libre Baskerville', serif"},{id:"google-fonts-oswald",name:"Oswald",family:"'Oswald', sans-serif"},{id:"google-fonts-jura",name:"Jura",family:"'Jura', sans-serif"},{id:"google-fonts-fjord-one",name:"Fjord One",family:"'Fjord One', serif"},{id:"google-fonts-josefin-slab",name:"Josefin Slab",family:"'Josefin Slab', serif"}],U=["id","hydrated","contenteditable","editable","spellcheck","highlighted","custom-loader","class","placeholder","data-gramm","data-gramm_id","data-gramm_editor","data-gr-id"],_=({node:t,deep:a=!0,attributes:e=U})=>{if(x(t))return t;if(j(t)){let n=t.cloneNode(a);O({element:n,attributes:e});let r=n.querySelectorAll(e.map((t=>`[${t}]`)).join(","));for(let t of Array.from(r))O({element:t,attributes:e});return n}return null},O=({element:t,attributes:a})=>{for(let e of a)t.removeAttribute(e)},x=t=>t?.nodeType===Node.TEXT_NODE||t?.nodeType===Node.COMMENT_NODE,j=t=>t?.nodeType===Node.ELEMENT_NODE,C=async({meta:t,fallbackName:a,fallbackAuthor:e,selector:n})=>{let r=[A(),I({meta:t})].filter((t=>void 0!==t)),o=P({selector:n}),i=await T(),s=(t?.title||a)?.trim();return{title:s,description:(t?.description||a)?.trim(),author:t?.author?.name||e,bio:t?.author?.bio,photo_url:t?.author?.photo_url,head_extra:r.length>0?r.join(""):void 0,attributes:o,social_image_name:encodeURI(s).toLowerCase(),social_image_value:i}},A=()=>{let t=document.querySelector($)?.style.fontFamily;if(!t)return;let a=D.find((a=>t===a.family.replace(/\'/g,"")));return a?`<link rel="stylesheet" href="${(({font:t})=>`https://fonts.googleapis.com/css?display=swap&amp;family=${t.name.replace(" ","+")}`)({font:a})}">`:void 0},I=({meta:t})=>{if(t&&t.canonical)return`<link rel="canonical" href="${t.canonical}">`},P=({selector:t})=>{let a=document.querySelector(t)?.attributes;if(a)return Array.from(a).filter((({name:t})=>!["id","hydrated","class","contenteditable"].includes(t))).reduce(((t,{name:a,value:e})=>(t[a]=e,t)),{})},F=()=>{let t=document.querySelectorAll(`${$} > *[slide_id]`),a=({slide:t,custom:a})=>{if(t.hasAttribute(`custom-${a}`))return;let e=t.querySelector(`div[slot="${a}"]`);!e||t.removeChild(e)};return Array.from(t).map((t=>{let e=_({node:t,deep:!1});return Array.from(t.childNodes).forEach((t=>{j(t)&&t.hasAttribute("slot")&&(e.appendChild(_({node:t})),a({slide:e,custom:"background"}),a({slide:e,custom:"header"}),a({slide:e,custom:"footer"}))})),e})).map((t=>t.outerHTML))},E=()=>{let t=document.querySelectorAll(`${v} > article *[paragraph_id]`);return Array.from(t).map((t=>_({node:t,deep:!0}))).map((t=>t.outerHTML))},T=async()=>document.querySelector("deckgo-social-img")?.toBlob("image/png");const S=async()=>{const n=t();if(!n)throw new Error("No internet identity to get the canisters status");const[r,o]=await Promise.all([a({identity:n}),e({identity:n})]),{actor:i,bucketId:s}=r,{actor:c,bucketId:l}=o,[d,u]=await Promise.all([i.cyclesBalance(),c.cyclesBalance()]);return{data:{bucketId:s,balance:d},storage:{bucketId:l,balance:u}}},K=async({startsWith:e,notContains:n})=>{const r=t();if(!r)return[];const{actor:o}=await a({identity:r});if(!o)return[];const i=(await o.list(u({startsWith:u(e),notContains:u(n)}))).map((([,t])=>N({data:t,identity:r})));return await Promise.all(i)},N=async({data:t,identity:a})=>{const e=await o(t.data);return{id:t.id,data:Object.assign(Object.assign({},e),{owner_id:a.getPrincipal().toText(),created_at:i(t.created_at),updated_at:i(t.updated_at)})}},L=async({key:t,actor:a,log:e})=>{if(!t)return;null==e||e({msg:`[delete][start] ${t}`});const n=performance.now(),r=a||await G();await r.del(t);const o=performance.now();null==e||e({msg:`[delete][done] ${t}`,duration:o-n})},z=({key:t,actor:a})=>new Promise((async(e,n)=>{try{const n=a||await G(),s=r(await n.get(t));if(!s)return void e(void 0);const c=await o(s.data);e({id:s.id,data:Object.assign(Object.assign({},c),{created_at:i(s.created_at),updated_at:i(s.updated_at)})})}catch(t){n(t)}})),B=({key:t,data:a,id:e,actor:n,log:r})=>new Promise((async(o,i)=>{try{null==r||r({msg:`[set][start] ${t}`});const i=performance.now(),s=n||await G(),l=new Date;await s.set(t,{id:e,data:await c(a),created_at:d(a.created_at||new Date),updated_at:d(l)});const u=performance.now();null==r||r({msg:`[set][done] ${t}`,duration:u-i}),o({id:e,data:Object.assign(Object.assign({},a),{updated_at:l})})}catch(t){i(t)}})),G=async()=>{const e=t();if(!e)throw new Error("No internet identity.");const{actor:n}=await a({identity:e});if(!n)throw new Error("No actor initialized.");return n},M=async()=>K({startsWith:"/decks/",notContains:"/slides/"}),R=async t=>L({key:`/decks/${t}`}),W=async({onNext:t})=>(document.addEventListener("deckPublished",(async({detail:a})=>await t(a)),{passive:!0}),()=>document.removeEventListener("deckPublished",(({detail:a})=>t(a)),!1)),H=async()=>K({startsWith:"/docs/",notContains:"/paragraphs/"}),J=async t=>L({key:`/docs/${t}`}),q=async({onNext:t})=>(document.addEventListener("docPublished",(async({detail:a})=>await t(a)),{passive:!0}),()=>document.removeEventListener("docPublished",(({detail:a})=>t(a)),!1)),Q=(t,a)=>z({key:`/docs/${t}/paragraphs/${a}`}),V=(t,a)=>z({key:`/decks/${t}/slides/${a}`});let X=(t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce(((t,a)=>t+((a&=63)<36?a.toString(36):a<62?(a-26).toString(36).toUpperCase():a>62?"-":"_")),"");const Y=()=>K({startsWith:"/templates/"}),Z=t=>{const a=X();return B({key:`/templates/${a}`,id:a,data:t})},tt=t=>{const{data:a,id:e}=t;return B({key:`/templates/${e}`,id:e,data:a})},at=async t=>{p({msg:"[update][start] user"});const a=performance.now(),{data:e,id:n}=t,r=await B({key:"/user",id:n,data:e}),o=performance.now();return p({msg:"[update][done] user",duration:o-a}),r},et=async({data:t,filename:a,folder:e,storageActor:n,headers:r,token:o,fullPath:i,log:s})=>{s({msg:`[upload][start] ${a}`});const c=performance.now(),l=i||`/${e}/${a}`,{batchId:d}=await n.initUpload({name:a,fullPath:l,token:u(o),folder:e}),m=performance.now();s({msg:`[upload][create batch] ${a}`,duration:m-c});const p=[],g=7e5,h=new Blob([await t.arrayBuffer()]);for(let t=0;t<h.size;t+=g){const a=h.slice(t,t+g);p.push(nt({batchId:d,chunk:a,storageActor:n}))}const f=await Promise.all(p),w=performance.now();s({msg:`[upload][chunks] ${a}`,duration:w-m}),await n.commitUpload({batchId:d,chunkIds:f.map((({chunkId:t})=>t)),headers:[["Content-Type",t.type],["accept-ranges","bytes"],...r]});const y=performance.now();return s({msg:`[upload][commit batch] ${a}`,duration:y-w}),s({msg:`[upload][done] ${a}`,duration:y-c}),{fullPath:l,filename:a,token:o}},nt=async({batchId:t,chunk:a,storageActor:e})=>e.uploadChunk({batchId:t,content:[...new Uint8Array(await a.arrayBuffer())]}),rt=t=>encodeURI(t.toLowerCase().replace(/\s/g,"-")),ot=async()=>{const a=t();if(!a)throw new Error("No internet identity.");const n=await e({identity:a}),{actor:r,bucketId:o}=n;if(!r)throw new Error("No actor initialized.");if(!o)throw new Error("No bucket principal defined");return n},it=async({storageUpload:t,publishData:a})=>{const{social_image_name:e,social_image_value:n}=a;if(!n)return;const{actor:r}=t;await et({data:n,filename:`${e}.png`,folder:"meta",storageActor:r,headers:[["Cache-Control","max-age=3600"]],log:p})},st=({template:t,data:a})=>Object.entries(a).reduce(((t,[a,e])=>t.replaceAll(`{{DECKDECKGO_${a.toUpperCase()}}}`,e||"").replaceAll(`\x3c!-- DECKDECKGO_${a.toUpperCase()} --\x3e`,e||"")),t),ct=async({indexHTML:t,folder:a,meta:e})=>{const{html:n,publishData:r}=t,{bucketId:o,actor:i}=await ot(),{filename:s,pathname:c}=lt({publishData:r,meta:e,folder:a}),l=`https://${o.toText()}.raw.ic0.app`,d=`${l}${c}`;let u=n.replace("{{DECKDECKGO_URL}}",d);return u=(({html:t,data:a,bucketUrl:e})=>{const{social_image_name:n}=a;return t.replaceAll("{{DECKDECKGO_SOCIAL_IMAGE}}",`${e}/meta/${n}.png`)})({html:u,data:r,bucketUrl:l}),{storageUpload:{html:u,actor:i,filename:s,pathname:c,fullUrl:d,bucketUrl:l,folder:a},publishData:r}},lt=({publishData:t,meta:a,folder:e})=>{if(null==a?void 0:a.pathname){const{pathname:t}=a;return{filename:t.replace(`/${e}/`,""),pathname:t}}const n=rt(t.title);return{filename:n,pathname:`/${e}/${n}`}},dt=async({publishData:t,updateTemplateContent:a,sourceFolder:e})=>{const n=await ut(e),r=st({template:n,data:t}),{attributes:o}=t;return{html:a({attr:o?Object.entries(o).reduce(((t,[a,e])=>`${a}="${e}"; ${t}`),"").trim():void 0,template:r})}},ut=async t=>(await fetch(`${h.getInstance().get().kitPath}/${t}/index.html`)).text(),mt=({data:t,storageUpload:a,meta:e,name:n})=>{var r;const{pathname:o}=a,i=new Date;return Object.assign(Object.assign({},t),{meta:Object.assign(Object.assign({},e||{title:n}),{pathname:o,published:!0,published_at:null!==(r=e.published_at)&&void 0!==r?r:i,updated_at:i})})},pt=async({filename:t,html:a,actor:e,folder:n})=>{await et({data:new Blob([a],{type:"text/html"}),filename:t,folder:n,storageActor:e,headers:[["Cache-Control","max-age=3600"]],log:p})},gt=()=>h.getInstance().get().author;const ht=({dataId:t,bucketUrl:a,meta:e})=>{var n,r;const{title:o,pathname:i}=e,s=`${a}${i}`,c=null!=(null==e?void 0:e.description)&&""!==(null==e?void 0:e.description)?`<p class="description">${e.description}</p>`:"",{format:l}=new Intl.DateTimeFormat("en",{year:"numeric",month:"short",day:"2-digit",hour:"numeric",minute:"numeric",second:"numeric"});return`<a data-id="${t}" href="${s}" rel="noopener noreferrer"><article><h3>${o}</h3>${c}<p>Published: ${l(null!==(n=f(null==e?void 0:e.published_at))&&void 0!==n?n:new Date)}</p><p>Edited: ${l(null!==(r=f(null==e?void 0:e.updated_at))&&void 0!==r?r:new Date)}</p></article></a>`},ft=t=>`<url>\n  <loc>${t}</loc>\n  <changefreq>daily</changefreq>\n  <priority>0.7</priority>\n</url>`,wt=async({dataId:t,storageUpload:a,publishData:e,entries:n})=>{const r=(t=>t.filter((({data:t})=>{var a;return!0===(null===(a=t.meta)||void 0===a?void 0:a.published)})).map((({data:t})=>t.meta)).sort((({published_at:t},{published_at:a})=>{var e,n;return((null===(e=f(a))||void 0===e?void 0:e.getTime())||0)-((null===(n=f(t))||void 0===n?void 0:n.getTime())||0)})))(n),o=[kt({storageUpload:a,publishData:e,dataId:t,metas:r}),bt({storageUpload:a,metas:r}),yt({storageUpload:a,metas:r,publishData:e})];await Promise.all(o)},yt=async({storageUpload:t,metas:a,publishData:e})=>{const{bucketUrl:n,actor:r}=t,{author:o}=e,i=(({bucketUrl:t,metas:a,author:e})=>(({items:t,author:a,bucketUrl:e})=>`<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" version="2.0">\n    <channel>\n        <title><![CDATA[${a} blog]]></title>\n        <description><![CDATA[The latest blog posts of ${a}]]></description>\n        <link>${e}</link>\n        <lastBuildDate>${(new Date).toUTCString()}</lastBuildDate>\n        \n        ${t}\n    </channel>\n</rss>`)({bucketUrl:t,items:(({metas:t,bucketUrl:a})=>t.map((({title:t,description:e,pathname:n,published_at:r})=>{var o;return`\n  <item>\n    <title><![CDATA[${t}]]></title>\n    <description><![CDATA[${null!=e?e:t}]]></description>\n    <link>${a}${n}</link>\n    <pubDate>${(null!==(o=f(r))&&void 0!==o?o:new Date).toUTCString()}</pubDate>\n  </item>\n`})))({metas:a,bucketUrl:t}).join(""),author:e}))({bucketUrl:n,metas:a,author:o||gt()});await Dt({rss:i,actor:r})},bt=async({storageUpload:t,metas:a})=>{const{bucketUrl:e,actor:n}=t,r=(({bucketUrl:t,metas:a})=>`<?xml version="1.0" encoding="UTF-8" ?>\n  <urlset\n    xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"\n    xmlns:news="http://www.google.com/schemas/sitemap-news/0.9"\n    xmlns:xhtml="http://www.w3.org/1999/xhtml"\n    xmlns:image="http://www.google.com/schemas/sitemap-image/1.1"\n    xmlns:video="http://www.google.com/schemas/sitemap-video/1.1"\n  >\n    ${[ft(t),...a.map((({pathname:a})=>ft(`${t}${a}`)))].join("")}\n</urlset>`)({bucketUrl:e,metas:a});await vt({sitemap:r,actor:n})},kt=async({dataId:t,storageUpload:a,publishData:e,metas:n})=>{const{bucketUrl:r,actor:o}=a,i=await(async({dataId:t,bucketUrl:a,publishData:e,metas:n})=>{const r=await(async()=>(await fetch(`${h.getInstance().get().kitPath}/index.html`)).text())(),{photo_url:o}=e,i=function(t,a){var e={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&a.indexOf(n)<0&&(e[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(t);r<n.length;r++)a.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(t,n[r])&&(e[n[r]]=t[n[r]])}return e}(e,["photo_url"]);let s=st({template:r,data:i});return s=(({photo_url:t,html:a})=>t?a.replace("\x3c!-- DECKDECKGO_PHOTO_URL --\x3e",`<img role="presentation" alt="" loading="lazy" src="${t}" />`):a)({html:s,photo_url:o}),s=await(async({dataId:t,template:a,bucketUrl:e,metas:n})=>{const r=n.map((a=>ht({dataId:t,meta:a,bucketUrl:e})));return a.replace(/<!-- DECKDECKGO_DATA -->/,r.join(""))})({dataId:t,template:s,bucketUrl:a,metas:n}),s})({dataId:t,bucketUrl:r,publishData:e,metas:n});await $t({html:i,actor:o})},$t=async({html:t,actor:a})=>Ut({actor:a,content:t,mimeType:"text/html",fullPath:"/",filename:"index.html"}),vt=async({sitemap:t,actor:a})=>Ut({actor:a,content:t,mimeType:"application/xml",fullPath:"/sitemap.xml",filename:"sitemap.xml",maxAge:3600}),Dt=async({rss:t,actor:a})=>Ut({actor:a,content:t,mimeType:"application/xml",fullPath:"/rss.xml",filename:"rss.xml",maxAge:3600}),Ut=async({content:t,actor:a,mimeType:e,filename:n,fullPath:r,maxAge:o=0})=>{await et({data:new Blob([t],{type:e}),filename:n,folder:"resources",storageActor:a,headers:[["Cache-Control",`max-age=${o}`]],fullPath:r,log:p})},_t=()=>h.getInstance().get().kitPath,Ot=async({meta:t})=>{const{actor:a}=await ot(),e=(await a.list(u("resources"))).map((({name:t})=>t)),n=await It(),r=n.filter((({filename:t})=>!e.includes(t)));if(!r||r.length<=0)return;const o=r.map((e=>xt({kit:e,actor:a,meta:t})));await Promise.all(o),await jt({kitNewFiles:r,kit:n,actor:a,meta:t})},xt=async({kit:t,actor:a,meta:e})=>{const{src:n,filename:r,mimeType:o,updateContent:i,headers:s}=t,c=await At(n),l=i?i({content:c,meta:e}):c;await Ct({filename:r,content:l,actor:a,mimeType:o,headers:s,fullPath:n.replace(_t(),"")})},jt=async({kitNewFiles:t,kit:a,actor:e,meta:n})=>{if(void 0!==t.find((({filename:t})=>"service-worker.js"===t)))return;const r=a.find((({filename:t})=>"service-worker.js"===t));void 0===!r&&await xt({kit:r,actor:e,meta:n})},Ct=async({filename:t,fullPath:a,content:e,actor:n,mimeType:r,headers:o})=>{await et({data:new Blob([e],{type:r}),filename:t,folder:"resources",storageActor:n,fullPath:a,headers:o,log:p})},At=async t=>(await fetch(t)).text(),It=async()=>{const t=_t();return(await(await fetch(`${t}/build.json`)).json()).map((a=>(a=>{const e=`${t}/${a}`;return e.includes(".js")?{src:e,mimeType:"text/javascript"}:e.includes(".css")?{src:e,mimeType:"text/css"}:e.includes(".webmanifest")?{src:e,mimeType:"application/manifest+json",updateContent:({content:t,meta:a})=>{var e;return t.replace("{{DECKDECKGO_AUTHOR}}",(null===(e=null==a?void 0:a.author)||void 0===e?void 0:e.name)||gt())}}:{src:e,mimeType:"text/plain"}})(a))).map((t=>{const{pathname:a}=new URL(t.src);return Object.assign(Object.assign({},t),{filename:a.split("/").pop(),headers:[["Cache-Control","max-age=31536000"]]})}))},Pt=async({deck:t})=>{await Ot({meta:t.data.meta});const{storageUpload:a,publishData:e,deck:n}=await(async({deck:t})=>{const{id:a,data:e}=t,{meta:n}=e,r=await(async({deck:t})=>{const a=await(async({deck:t,fallbackAuthor:a})=>{let{data:e}=t,{meta:n,background:r,footer:o,header:i}=e;return{...await C({meta:n,selector:$,fallbackName:e.name,fallbackAuthor:a}),slides:F(),background:r?`<div slot="background">${r}</div>`:void 0,header:r?`<div slot="header">${i}</div>`:void 0,footer:r?`<div slot="footer">${o}</div>`:void 0}})({deck:t,fallbackAuthor:h.getInstance().get().author}),{slides:e}=a,{html:n}=await dt({publishData:a,updateTemplateContent:({attr:t,template:a})=>a.replace("\x3c!-- DECKDECKGO_DECK --\x3e",`<deckgo-deck id="slider" embedded="true" ${t||""}>${e.join("")}</deckgo-deck>`),sourceFolder:"p"});return{html:n,publishData:a}})({deck:t}),{storageUpload:o,publishData:i}=await ct({indexHTML:r,folder:"p",meta:n}),s=mt({data:e,meta:e.meta,name:e.name,storageUpload:o}),c=await B({key:`/decks/${a}`,id:a,data:s});return await pt(o),await it({storageUpload:o,publishData:i}),{storageUpload:o,publishData:i,deck:c}})({deck:t});return await(async({dataId:t,storageUpload:a,publishData:e})=>{p({msg:"[list][start] decks"});const n=await M();p({msg:"[list][start] end"}),await wt({storageUpload:a,publishData:e,dataId:t,entries:n})})({storageUpload:a,publishData:e,dataId:n.id,owner_id:t.data.owner_id}),(t=>{const{id:a,data:e}=t,n={id:a,data:Object.assign(Object.assign({},e),{deploy:{api:{status:"successful",updated_at:new Date}}})},r=new CustomEvent("deckPublished",{detail:n});document.dispatchEvent(r)})(n),n},Ft=async({doc:t,config:a})=>{await Ot({meta:t.data.meta});const{storageUpload:e,publishData:n,doc:r}=await(async({doc:t,config:a})=>{const{id:e,data:n}=t,{meta:r}=n,o=await(async({doc:t,config:a})=>{const e=await(async({doc:t,fallbackAuthor:a,theme:e})=>{let{data:n}=t,{meta:r}=n;return{...await C({meta:r,selector:v,fallbackName:n.name,fallbackAuthor:a}),paragraphs:E(),theme:e}})({doc:t,fallbackAuthor:h.getInstance().get().author,theme:a.theme}),{paragraphs:n}=e,{html:r}=await dt({publishData:e,updateTemplateContent:({attr:t,template:a})=>a.replace("\x3c!-- DECKDECKGO_DOC --\x3e",`<article ${t||""} class="deckgo-doc">${n.join("")}</article>`),sourceFolder:"d"});return{html:r,publishData:e}})({doc:t,config:a}),{storageUpload:i,publishData:s}=await ct({indexHTML:o,folder:"d",meta:r}),c=mt({data:n,meta:n.meta,name:n.name,storageUpload:i}),l=await B({key:`/docs/${e}`,id:e,data:c});return await pt(i),await it({storageUpload:i,publishData:s}),{storageUpload:i,publishData:s,doc:l}})({doc:t,config:a});return await(async({dataId:t,storageUpload:a,publishData:e})=>{p({msg:"[list][start] docs"});const n=await H();p({msg:"[list][end] docs"}),await wt({storageUpload:a,publishData:e,dataId:t,entries:n})})({storageUpload:e,publishData:n,dataId:r.id,owner_id:t.data.owner_id}),(t=>{const{id:a,data:e}=t,n={id:a,data:Object.assign(Object.assign({},e),{deploy:{api:{status:"successful",updated_at:new Date}}})},r=new CustomEvent("docPublished",{detail:n});document.dispatchEvent(r)})(r),r},Et=async()=>{const{bucketId:t}=await ot();return`https://${t.toText()}.raw.ic0.app`},Tt=async({data:a,folder:e,maxSize:n})=>{const r=t();return St({data:a,folder:e,maxSize:n,identity:r,log:p})},St=async({data:t,maxSize:a,folder:n,identity:r,storageBucket:o,log:i})=>{if(!t||!t.name)throw new Error("File not valid.");if(t.size>a)throw new Error(`File is too big (max. ${a/1048576} Mb)`);const{actor:s,bucketId:c}=o||await e({identity:r});if(!s||!c)throw new Error("Storage bucket is not initialized.");const{fullPath:l,filename:d,token:u}=await et({data:t,filename:rt(t.name),folder:n,storageActor:s,token:X(),headers:[["cache-control","private, max-age=0"]],log:i});return{downloadUrl:`https://${c.toText()}.raw.ic0.app${l}?token=${u}`,fullPath:l,name:d}},Kt=async({folder:t})=>{const{actor:a,bucketId:e}=await ot(),n=await a.list(u(t)),r=`https://${e.toText()}.raw.ic0.app`;return{items:n.map((({name:t,fullPath:a,token:e})=>({downloadUrl:`${r}${a}?token=${e}`,fullPath:a,name:t}))),nextPageToken:null}},Nt=async({downloadUrl:t,fullPath:a})=>{const{actor:e}=await ot();let n=null;if(t){const{searchParams:a}=new URL(t);n=a.get("token")}return e.del({fullPath:a,token:u(n||void 0)})};function Lt(t){return new Promise((function(a,e){t.oncomplete=t.onsuccess=function(){return a(t.result)},t.onabort=t.onerror=function(){return e(t.error)}}))}var zt;function Bt(){return zt||(t="keyval-store",a="keyval",n=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(t){var a=function(){return indexedDB.databases().finally(t)};e=setInterval(a,100),a()})).finally((function(){return clearInterval(e)})):Promise.resolve()).then((function(){var e=indexedDB.open(t);return e.onupgradeneeded=function(){return e.result.createObjectStore(a)},Lt(e)})),zt=function(t,e){return n.then((function(n){return e(n.transaction(a,t).objectStore(a))}))}),zt;var t,a,e,n}const Gt=({data:t,storageFile:a,imgSrc:e})=>{const{downloadUrl:n,name:r}=a;let o=t.replaceAll(`img-src="${e}"`,`img-src="${n}"`);return o=o.replaceAll(`img-alt="${e}"`,`img-alt="${r}"`),o},Mt=async({selector:t,storageFile:a,src:e})=>{const n=document.querySelector(t);if("deckgo-lazy-img"===(null==n?void 0:n.nodeName.toLowerCase()))return void await Rt({images:[n],storageFile:a,src:e});const r=null==n?void 0:n.querySelectorAll("deckgo-lazy-img");await Rt({images:Array.from(r),storageFile:a,src:e})},Rt=async({storageFile:t,images:a,src:e})=>{const n=a.filter((t=>t.imgSrc===e));if(!n||n.length<=0)return;const r=Array.from(n).map((a=>(async a=>{const{downloadUrl:e,name:n}=t;a.imgSrc=e,a.imgAlt=n})(a)));await Promise.all(r)},Wt=async({storageFile:t,src:a,key:e})=>{const n=(({paragraph:t,images:a})=>{if(!a)return Object.assign({},t);const e=a.filter((({src:t,storageFile:a})=>void 0!==t&&void 0!==a));let{children:n,nodeName:r,attributes:o}=t.data;return"deckgo-lazy-img"===r&&o&&e.forEach((({src:t,storageFile:a})=>{o=(({attributes:t,storageFile:a,imgSrc:e})=>{const{downloadUrl:n}=a;return Object.keys(t).reduce(((a,r)=>(a[r]=t[r]===e?n:t[r],a)),{})})({attributes:o,storageFile:a,imgSrc:t})})),n=null==n?void 0:n.map((t=>(e.forEach((({src:a,storageFile:e})=>{t=Gt({data:t,storageFile:e,imgSrc:a})})),t))),{id:t.id,data:Object.assign(Object.assign({},t.data),{updated_at:new Date,children:n,attributes:o})}})({paragraph:await Ht({key:e}),images:[{src:a,storageFile:t}]});await Jt({key:e,data:n})},Ht=async({key:t})=>{const a=await function(t){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:Bt())("readonly",(function(a){return Lt(a.get(t))}))}(t);if(!a)throw new Error("Data not found and that is really weird here.");return a},Jt=async({key:t,data:a})=>function(t,a){return(arguments.length>2&&void 0!==arguments[2]?arguments[2]:Bt())("readwrite",(function(e){return e.put(a,t),Lt(e.transaction)}))}(t,a),qt=w(import("./p-ed4c6d21.js").then((t=>t.worker)),"stencil.sync.ic.worker","uploadWorker"),Qt=async({msg:t,data:a})=>{"deckdeckgo_sync_deck_background"===t&&await(async t=>{(({storageFile:t})=>{const a=document.querySelector(`${$} > *[slot="background"]`),e=null==a?void 0:a.querySelector("deckgo-lazy-img");if(!e)return;const{downloadUrl:n,name:r}=t;e.imgSrc=n,e.imgAlt=r})(t),await(async({storageFile:t,src:a})=>{const e=document.querySelectorAll(`${$} .deckgo-slide-container:not([custom-background]) *[slot="background"] deckgo-lazy-img`);await Rt({images:Array.from(e),storageFile:t,src:a})})(t),await(async({storageFile:t,src:a,key:e})=>{const n=(({deck:t,storageFile:a,imgSrc:e})=>a&&e?{id:t.id,data:Object.assign(Object.assign({},t.data),{updated_at:new Date,background:Gt({data:t.data.background,imgSrc:e,storageFile:a})})}:Object.assign({},t))({deck:await Ht({key:e}),imgSrc:a,storageFile:t});await Jt({key:e,data:n})})(t)})(a),"deckdeckgo_sync_slide_image"===t&&await(async t=>{const{selector:a}=t;a&&(await Mt(t),await(async({storageFile:t,src:a,key:e})=>{const n=(({slide:t,images:a})=>{if(!a)return Object.assign({},t);const e=a.filter((({src:t,storageFile:a})=>void 0!==t&&void 0!==a));let{content:n}=t.data;return e.forEach((({src:t,storageFile:a})=>{n=Gt({data:n,storageFile:a,imgSrc:t})})),{id:t.id,data:Object.assign(Object.assign({},t.data),{updated_at:new Date,content:n})}})({slide:await Ht({key:e}),images:[{src:a,storageFile:t}]});await Jt({key:e,data:n})})(t))})(a),"deckdeckgo_sync_slide_chart"===t&&await(async t=>{const{selector:a}=t;a&&((({selector:t,storageFile:a})=>{const e=document.querySelector(t);if(!e||!e.nodeName||"deckgo-slide-chart"!==e.nodeName.toLowerCase())return;const{downloadUrl:n}=a;e.src=n})(t),await(async({storageFile:t,src:a,key:e})=>{const n=(({slide:t,chart:a})=>{if(!a)return Object.assign({},t);const{src:e,storageFile:n}=a;if(!e||!n)return Object.assign({},t);const{attributes:r}=t.data;if(!r)return Object.assign({},t);const{downloadUrl:o}=n;return{id:t.id,data:Object.assign(Object.assign({},t.data),{updated_at:new Date,attributes:Object.assign(Object.assign({},r),{src:o})})}})({slide:await Ht({key:e}),chart:{src:a,storageFile:t}});await Jt({key:e,data:n})})(t))})(a),"deckdeckgo_sync_paragraph_image"===t&&await(async t=>{const{selector:a}=t;a&&(await Mt(t),await Wt(t))})(a)},Vt=async({syncData:a,clean:e})=>{if(!t())throw new Error("No internet identity to sync data");const n=await y();if(!b(k.fromJSON(n.delegationChain)))throw new Error("Internet identity has expired. Please login again.");await qt({internetIdentity:n,syncData:a,env:h.getInstance().get()},Qt,p),await e(a)};export{S as canistersBalance,Z as createTemplate,M as deckEntries,Pt as deckPublish,R as deleteDeck,J as deleteDoc,Nt as deleteFile,H as docEntries,Ft as docPublish,Kt as getFiles,Q as getParagraph,V as getSlide,Y as getUserTemplates,Et as publishUrl,W as snapshotDeck,q as snapshotDoc,Vt as sync,tt as updateTemplate,at as updateUser,Tt as uploadFile,St as uploadFileIC}