import{g as t,a,b as e,f as r,c as o,d as i,t as c,e as d,h as u,o as p,E as f,r as h,i as w,j as b,k as y,D as k}from"./p-38663dbe.js";export{n as deleteAuth,g as getIdentity,l as initAuth,m as signIn,s as signOut}from"./p-38663dbe.js";import"./p-0adadf10.js";var $="app-deck-editor > ion-content div.deck > main > deckgo-deck",v="deckgo-studio-doc",D=[{id:"google-fonts-lora",name:"Lora",family:"'Lora', serif"},{id:"google-fonts-roboto",name:"Roboto",family:"'Roboto', sans-serif"},{id:"google-fonts-open-sans",name:"Open Sans",family:"'Open Sans', sans-serif"},{id:"google-fonts-montserrat",name:"Montserrat",family:"'Montserrat', sans-serif"},{id:"google-fonts-cabin",name:"Cabin",family:"'Cabin', sans-serif"},{id:"google-fonts-lato",name:"Lato",family:"'Lato', sans-serif"},{id:"google-fonts-muli",name:"Muli",family:"'Muli', sans-serif"},{id:"google-fonts-source-sans-pro",name:"Source Sans Pro",family:"'Source Sans Pro', sans-serif"},{id:"google-fonts-libre-baskerville",name:"Libre Baskerville",family:"'Libre Baskerville', serif"},{id:"google-fonts-oswald",name:"Oswald",family:"'Oswald', sans-serif"},{id:"google-fonts-jura",name:"Jura",family:"'Jura', sans-serif"},{id:"google-fonts-fjord-one",name:"Fjord One",family:"'Fjord One', serif"},{id:"google-fonts-josefin-slab",name:"Josefin Slab",family:"'Josefin Slab', serif"}],U=["id","hydrated","contenteditable","editable","spellcheck","highlighted","custom-loader","class","placeholder","data-gramm","data-gramm_id","data-gramm_editor","data-gr-id"],_=["paragraph_id","data-src",...U],O=({node:t,deep:a=!0,attributes:e=U})=>{if(j(t))return t;if(C(t)){let r=t.cloneNode(a);x({element:r,attributes:e});let n=r.querySelectorAll(e.map((t=>`[${t}]`)).join(","));for(let t of Array.from(n))x({element:t,attributes:e});return r}return null},x=({element:t,attributes:a})=>{for(let e of a)t.removeAttribute(e)},j=t=>t?.nodeType===Node.TEXT_NODE||t?.nodeType===Node.COMMENT_NODE,C=t=>t?.nodeType===Node.ELEMENT_NODE,A=async({meta:t,fallbackName:a,fallbackAuthor:e,selector:r})=>{let n=[I(),P({meta:t})].filter((t=>void 0!==t)),o=F({selector:r}),s=await K(),i=(t?.title||a)?.trim();return{title:i,description:(t?.description||a)?.trim(),author:t?.author?.name||e,bio:t?.author?.bio,photo_url:t?.author?.photo_url,head_extra:n.length>0?n.join(""):void 0,attributes:o,social_image_name:encodeURI(i).toLowerCase(),social_image_value:s}},I=()=>{let t=document.querySelector($)?.style.fontFamily;if(!t)return;let a=D.find((a=>t===a.family.replace(/\'/g,"")));return a?`<link rel="stylesheet" href="${(({font:t})=>`https://fonts.googleapis.com/css?display=swap&amp;family=${t.name.replace(" ","+")}`)({font:a})}">`:void 0},P=({meta:t})=>{if(t&&t.canonical)return`<link rel="canonical" href="${t.canonical}">`},F=({selector:t})=>{let a=document.querySelector(t)?.attributes;if(a)return Array.from(a).filter((({name:t})=>!["id","hydrated","class","contenteditable"].includes(t))).reduce(((t,{name:a,value:e})=>(t[a]=e,t)),{})},E=()=>{let t=document.querySelectorAll(`${$} > *[slide_id]`),a=({slide:t,custom:a})=>{if(t.hasAttribute(`custom-${a}`))return;let e=t.querySelector(`div[slot="${a}"]`);!e||t.removeChild(e)};return Array.from(t).map((t=>{let e=O({node:t,deep:!1,attributes:_});return Array.from(t.childNodes).forEach((t=>{C(t)&&t.hasAttribute("slot")&&(e.appendChild(O({node:t,attributes:_})),a({slide:e,custom:"background"}),a({slide:e,custom:"header"}),a({slide:e,custom:"footer"}))})),e})).map((t=>t.outerHTML))},T=()=>{let t=document.querySelectorAll(`${v} > article *[paragraph_id]`);return Array.from(t).map((t=>O({node:t,attributes:_}))).map((t=>t.outerHTML))},K=async()=>document.querySelector("deckgo-social-img")?.toBlob("image/png");const N=async()=>{const r=t();if(!r)throw new Error("No internet identity to get the canisters status");const[n,o]=await Promise.all([a({identity:r}),e({identity:r})]),{actor:s,bucketId:i}=n,{actor:c,bucketId:l}=o,[d,u]=await Promise.all([s.cyclesBalance(),c.cyclesBalance()]);return{data:{bucketId:i,balance:d},storage:{bucketId:l,balance:u}}},S=async({startsWith:e,notContains:r})=>{const n=t();if(!n)return[];const{actor:o}=await a({identity:n});if(!o)return[];const s=(await o.list(u({startsWith:u(e),notContains:u(r)}))).map((([,t])=>L({data:t,identity:n})));return await Promise.all(s)},L=async({data:t,identity:a})=>{const e=await o(t.data);return{id:t.id,data:Object.assign(Object.assign({},e),{owner_id:a.getPrincipal().toText(),created_at:i(t.created_at),updated_at:i(t.updated_at)})}},z=async({key:t,actor:a,log:e})=>{if(!t)return;null==e||e({msg:`[delete][start] ${t}`});const r=performance.now(),n=a||await M();await n.del(t);const o=performance.now();null==e||e({msg:`[delete][done] ${t}`,duration:o-r})},B=({key:t,actor:a})=>new Promise((async(e,n)=>{try{const n=a||await M(),s=r(await n.get(t));if(!s)return void e(void 0);const c=await o(s.data);e({id:s.id,data:Object.assign(Object.assign({},c),{created_at:i(s.created_at),updated_at:i(s.updated_at)})})}catch(t){n(t)}})),G=({key:t,data:a,id:e,actor:r,log:n})=>new Promise((async(o,s)=>{try{null==n||n({msg:`[set][start] ${t}`});const s=performance.now(),i=r||await M(),l=new Date;await i.set(t,{id:e,data:await c(a),created_at:d(a.created_at||new Date),updated_at:d(l)});const u=performance.now();null==n||n({msg:`[set][done] ${t}`,duration:u-s}),o({id:e,data:Object.assign(Object.assign({},a),{updated_at:l})})}catch(t){s(t)}})),M=async()=>{const e=t();if(!e)throw new Error("No internet identity.");const{actor:r}=await a({identity:e});if(!r)throw new Error("No actor initialized.");return r},R=async()=>S({startsWith:"/decks/",notContains:"/slides/"}),W=async t=>z({key:`/decks/${t}`}),H=async({onNext:t})=>(document.addEventListener("deckPublished",(async({detail:a})=>await t(a)),{passive:!0}),()=>document.removeEventListener("deckPublished",(({detail:a})=>t(a)),!1)),J=async()=>S({startsWith:"/docs/",notContains:"/paragraphs/"}),q=async t=>z({key:`/docs/${t}`}),Q=async({onNext:t})=>(document.addEventListener("docPublished",(async({detail:a})=>await t(a)),{passive:!0}),()=>document.removeEventListener("docPublished",(({detail:a})=>t(a)),!1)),V=(t,a)=>B({key:`/docs/${t}/paragraphs/${a}`}),X=(t,a)=>B({key:`/decks/${t}/slides/${a}`});let Y=(t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce(((t,a)=>t+((a&=63)<36?a.toString(36):a<62?(a-26).toString(36).toUpperCase():a>62?"-":"_")),"");const Z=()=>S({startsWith:"/templates/"}),tt=t=>{const a=Y();return G({key:`/templates/${a}`,id:a,data:t})},at=t=>{const{data:a,id:e}=t;return G({key:`/templates/${e}`,id:e,data:a})},et=async t=>{p({msg:"[update][start] user"});const a=performance.now(),{data:e,id:r}=t,n=await G({key:"/user",id:r,data:e}),o=performance.now();return p({msg:"[update][done] user",duration:o-a}),n},rt=async({data:t,filename:a,folder:e,storageActor:r,headers:n,token:o,fullPath:s,log:i})=>{i({msg:`[upload][start] ${a}`});const c=performance.now(),l=s||`/${e}/${a}`,{batchId:d}=await r.initUpload({name:a,fullPath:l,token:u(o),folder:e}),m=performance.now();i({msg:`[upload][create batch] ${a}`,duration:m-c});const p=[],g=7e5,f=new Blob([await t.arrayBuffer()]);for(let t=0;t<f.size;t+=g){const a=f.slice(t,t+g);p.push(nt({batchId:d,chunk:a,storageActor:r}))}const h=await Promise.all(p),w=performance.now();i({msg:`[upload][chunks] ${a}`,duration:w-m}),await r.commitUpload({batchId:d,chunkIds:h.map((({chunkId:t})=>t)),headers:[["Content-Type",t.type],["accept-ranges","bytes"],...n]});const b=performance.now();return i({msg:`[upload][commit batch] ${a}`,duration:b-w}),i({msg:`[upload][done] ${a}`,duration:b-c}),{fullPath:l,filename:a,token:o}},nt=async({batchId:t,chunk:a,storageActor:e})=>e.uploadChunk({batchId:t,content:[...new Uint8Array(await a.arrayBuffer())]}),ot=t=>encodeURI(t.toLowerCase().replace(/\s/g,"-")),st=async()=>{const a=t();if(!a)throw new Error("No internet identity.");const r=await e({identity:a}),{actor:n,bucketId:o}=r;if(!n)throw new Error("No actor initialized.");if(!o)throw new Error("No bucket principal defined");return r},it=async({storageUpload:t,publishData:a})=>{const{social_image_name:e,social_image_value:r}=a;if(!r)return;const{actor:n}=t;await rt({data:r,filename:`${e}.png`,folder:"meta",storageActor:n,headers:[["Cache-Control","max-age=3600"]],log:p})},ct=({template:t,data:a})=>Object.entries(a).reduce(((t,[a,e])=>t.replaceAll(`{{DECKDECKGO_${a.toUpperCase()}}}`,e||"").replaceAll(`\x3c!-- DECKDECKGO_${a.toUpperCase()} --\x3e`,e||"")),t),lt=async({indexHTML:t,folder:a,meta:e})=>{const{html:r,publishData:n}=t,{bucketId:o,actor:s}=await st(),{filename:i,pathname:c}=dt({publishData:n,meta:e,folder:a}),l=`https://${o.toText()}.raw.ic0.app`,d=`${l}${c}`;let u=r.replace("{{DECKDECKGO_URL}}",d);return u=(({html:t,data:a,bucketUrl:e})=>{const{social_image_name:r}=a;return t.replaceAll("{{DECKDECKGO_SOCIAL_IMAGE}}",`${e}/meta/${r}.png`)})({html:u,data:n,bucketUrl:l}),{storageUpload:{html:u,actor:s,filename:i,pathname:c,fullUrl:d,bucketUrl:l,folder:a},publishData:n}},dt=({publishData:t,meta:a,folder:e})=>{if(null==a?void 0:a.pathname){const{pathname:t}=a;return{filename:t.replace(`/${e}/`,""),pathname:t}}const r=ot(t.title);return{filename:r,pathname:`/${e}/${r}`}},ut=async({publishData:t,updateTemplateContent:a,sourceFolder:e})=>{const r=await mt(e),n=ct({template:r,data:t}),{attributes:o}=t;return{html:a({attr:o?Object.entries(o).reduce(((t,[a,e])=>`${a}="${e}"; ${t}`),"").trim():void 0,template:n})}},mt=async t=>(await fetch(`${f.getInstance().get().kitPath}/${t}/index.html`)).text(),pt=({data:t,storageUpload:a,meta:e,name:r})=>{var n;const{pathname:o}=a,s=new Date;return Object.assign(Object.assign({},t),{meta:Object.assign(Object.assign({},e||{title:r}),{pathname:o,published:!0,published_at:null!==(n=e.published_at)&&void 0!==n?n:s,updated_at:s})})},gt=async({filename:t,html:a,actor:e,folder:r})=>{await rt({data:new Blob([a],{type:"text/html"}),filename:t,folder:r,storageActor:e,headers:[["Cache-Control","max-age=3600"]],log:p})},ft=()=>f.getInstance().get().author;const ht=({dataId:t,bucketUrl:a,meta:e})=>{var r,n;const{title:o,pathname:s}=e,i=`${a}${s}`,c=null!=(null==e?void 0:e.description)&&""!==(null==e?void 0:e.description)?`<p class="description">${e.description}</p>`:"",{format:l}=new Intl.DateTimeFormat("en",{year:"numeric",month:"short",day:"2-digit",hour:"numeric",minute:"numeric",second:"numeric"});return`<a data-id="${t}" href="${i}" rel="noopener noreferrer"><article><h3>${o}</h3>${c}<p>Published: ${l(null!==(r=h(null==e?void 0:e.published_at))&&void 0!==r?r:new Date)}</p><p>Edited: ${l(null!==(n=h(null==e?void 0:e.updated_at))&&void 0!==n?n:new Date)}</p></article></a>`},wt=t=>`<url>\n  <loc>${t}</loc>\n  <changefreq>daily</changefreq>\n  <priority>0.7</priority>\n</url>`,bt=async({dataId:t,storageUpload:a,publishData:e,entries:r})=>{const n=(t=>t.filter((({data:t})=>{var a;return!0===(null===(a=t.meta)||void 0===a?void 0:a.published)})).map((({data:t})=>t.meta)).sort((({published_at:t},{published_at:a})=>{var e,r;return((null===(e=h(a))||void 0===e?void 0:e.getTime())||0)-((null===(r=h(t))||void 0===r?void 0:r.getTime())||0)})))(r),o=[$t({storageUpload:a,publishData:e,dataId:t,metas:n}),kt({storageUpload:a,metas:n}),yt({storageUpload:a,metas:n,publishData:e})];await Promise.all(o)},yt=async({storageUpload:t,metas:a,publishData:e})=>{const{bucketUrl:r,actor:n}=t,{author:o}=e,s=(({bucketUrl:t,metas:a,author:e})=>(({items:t,author:a,bucketUrl:e})=>`<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" version="2.0">\n    <channel>\n        <title><![CDATA[${a} blog]]></title>\n        <description><![CDATA[The latest blog posts of ${a}]]></description>\n        <link>${e}</link>\n        <lastBuildDate>${(new Date).toUTCString()}</lastBuildDate>\n        \n        ${t}\n    </channel>\n</rss>`)({bucketUrl:t,items:(({metas:t,bucketUrl:a})=>t.map((({title:t,description:e,pathname:r,published_at:n})=>{var o;return`\n  <item>\n    <title><![CDATA[${t}]]></title>\n    <description><![CDATA[${null!=e?e:t}]]></description>\n    <link>${a}${r}</link>\n    <pubDate>${(null!==(o=h(n))&&void 0!==o?o:new Date).toUTCString()}</pubDate>\n  </item>\n`})))({metas:a,bucketUrl:t}).join(""),author:e}))({bucketUrl:r,metas:a,author:o||ft()});await Ut({rss:s,actor:n})},kt=async({storageUpload:t,metas:a})=>{const{bucketUrl:e,actor:r}=t,n=(({bucketUrl:t,metas:a})=>`<?xml version="1.0" encoding="UTF-8" ?>\n  <urlset\n    xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"\n    xmlns:news="http://www.google.com/schemas/sitemap-news/0.9"\n    xmlns:xhtml="http://www.w3.org/1999/xhtml"\n    xmlns:image="http://www.google.com/schemas/sitemap-image/1.1"\n    xmlns:video="http://www.google.com/schemas/sitemap-video/1.1"\n  >\n    ${[wt(t),...a.map((({pathname:a})=>wt(`${t}${a}`)))].join("")}\n</urlset>`)({bucketUrl:e,metas:a});await Dt({sitemap:n,actor:r})},$t=async({dataId:t,storageUpload:a,publishData:e,metas:r})=>{const{bucketUrl:n,actor:o}=a,s=await(async({dataId:t,bucketUrl:a,publishData:e,metas:r})=>{const n=await(async()=>(await fetch(`${f.getInstance().get().kitPath}/index.html`)).text())(),{photo_url:o}=e,s=function(t,a){var e={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&a.indexOf(r)<0&&(e[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(t);n<r.length;n++)a.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(t,r[n])&&(e[r[n]]=t[r[n]])}return e}(e,["photo_url"]);let i=ct({template:n,data:s});return i=(({photo_url:t,html:a})=>t?a.replace("\x3c!-- DECKDECKGO_PHOTO_URL --\x3e",`<img role="presentation" alt="" loading="lazy" src="${t}" />`):a)({html:i,photo_url:o}),i=await(async({dataId:t,template:a,bucketUrl:e,metas:r})=>{const n=r.map((a=>ht({dataId:t,meta:a,bucketUrl:e})));return a.replace(/<!-- DECKDECKGO_DATA -->/,n.join(""))})({dataId:t,template:i,bucketUrl:a,metas:r}),i})({dataId:t,bucketUrl:n,publishData:e,metas:r});await vt({html:s,actor:o})},vt=async({html:t,actor:a})=>_t({actor:a,content:t,mimeType:"text/html",fullPath:"/",filename:"index.html"}),Dt=async({sitemap:t,actor:a})=>_t({actor:a,content:t,mimeType:"application/xml",fullPath:"/sitemap.xml",filename:"sitemap.xml",maxAge:3600}),Ut=async({rss:t,actor:a})=>_t({actor:a,content:t,mimeType:"application/xml",fullPath:"/rss.xml",filename:"rss.xml",maxAge:3600}),_t=async({content:t,actor:a,mimeType:e,filename:r,fullPath:n,maxAge:o=0})=>{await rt({data:new Blob([t],{type:e}),filename:r,folder:"resources",storageActor:a,headers:[["Cache-Control",`max-age=${o}`]],fullPath:n,log:p})},Ot=()=>f.getInstance().get().kitPath,xt=async({meta:t})=>{const{actor:a}=await st(),e=(await a.list(u("resources"))).map((({name:t})=>t)),r=await Pt(),n=r.filter((({filename:t})=>!e.includes(t)));if(!n||n.length<=0)return;const o=n.map((e=>jt({kit:e,actor:a,meta:t})));await Promise.all(o),await Ct({kitNewFiles:n,kit:r,actor:a,meta:t})},jt=async({kit:t,actor:a,meta:e})=>{const{src:r,filename:n,mimeType:o,updateContent:s,headers:i}=t,c=await It(r),l=s?s({content:c,meta:e}):c;await At({filename:n,content:l,actor:a,mimeType:o,headers:i,fullPath:r.replace(Ot(),"")})},Ct=async({kitNewFiles:t,kit:a,actor:e,meta:r})=>{if(void 0!==t.find((({filename:t})=>"service-worker.js"===t)))return;const n=a.find((({filename:t})=>"service-worker.js"===t));void 0===!n&&await jt({kit:n,actor:e,meta:r})},At=async({filename:t,fullPath:a,content:e,actor:r,mimeType:n,headers:o})=>{await rt({data:new Blob([e],{type:n}),filename:t,folder:"resources",storageActor:r,fullPath:a,headers:o,log:p})},It=async t=>(await fetch(t)).text(),Pt=async()=>{const t=Ot();return(await(await fetch(`${t}/build.json`)).json()).map((a=>(a=>{const e=`${t}/${a}`;return e.includes(".js")?{src:e,mimeType:"text/javascript"}:e.includes(".css")?{src:e,mimeType:"text/css"}:e.includes(".webmanifest")?{src:e,mimeType:"application/manifest+json",updateContent:({content:t,meta:a})=>{var e;return t.replace("{{DECKDECKGO_AUTHOR}}",(null===(e=null==a?void 0:a.author)||void 0===e?void 0:e.name)||ft())}}:{src:e,mimeType:"text/plain"}})(a))).map((t=>{const{pathname:a}=new URL(t.src);return Object.assign(Object.assign({},t),{filename:a.split("/").pop(),headers:[["Cache-Control","max-age=31536000"]]})}))},Ft=async({deck:t})=>{await xt({meta:t.data.meta});const{storageUpload:a,publishData:e,deck:r}=await(async({deck:t})=>{const{id:a,data:e}=t,{meta:r}=e,n=await(async({deck:t})=>{const a=await(async({deck:t,fallbackAuthor:a})=>{let{data:e}=t,{meta:r,background:n,footer:o,header:s}=e;return{...await A({meta:r,selector:$,fallbackName:e.name,fallbackAuthor:a}),slides:E(),background:n?`<div slot="background">${n}</div>`:void 0,header:n?`<div slot="header">${s}</div>`:void 0,footer:n?`<div slot="footer">${o}</div>`:void 0}})({deck:t,fallbackAuthor:f.getInstance().get().author}),{slides:e}=a,{html:r}=await ut({publishData:a,updateTemplateContent:({attr:t,template:a})=>a.replace("\x3c!-- DECKDECKGO_DECK --\x3e",`<deckgo-deck id="slider" embedded="true" ${t||""}>${e.join("")}</deckgo-deck>`),sourceFolder:"p"});return{html:r,publishData:a}})({deck:t}),{storageUpload:o,publishData:s}=await lt({indexHTML:n,folder:"p",meta:r}),i=pt({data:e,meta:e.meta,name:e.name,storageUpload:o}),c=await G({key:`/decks/${a}`,id:a,data:i});return await gt(o),await it({storageUpload:o,publishData:s}),{storageUpload:o,publishData:s,deck:c}})({deck:t});return await(async({dataId:t,storageUpload:a,publishData:e})=>{p({msg:"[list][start] decks"});const r=await R();p({msg:"[list][start] end"}),await bt({storageUpload:a,publishData:e,dataId:t,entries:r})})({storageUpload:a,publishData:e,dataId:r.id,owner_id:t.data.owner_id}),(t=>{const{id:a,data:e}=t,r={id:a,data:Object.assign(Object.assign({},e),{deploy:{api:{status:"successful",updated_at:new Date}}})},n=new CustomEvent("deckPublished",{detail:r});document.dispatchEvent(n)})(r),r},Et=async({doc:t,config:a})=>{await xt({meta:t.data.meta});const{storageUpload:e,publishData:r,doc:n}=await(async({doc:t,config:a})=>{const{id:e,data:r}=t,{meta:n}=r,o=await(async({doc:t,config:a})=>{const e=await(async({doc:t,fallbackAuthor:a,theme:e})=>{let{data:r}=t,{meta:n}=r;return{...await A({meta:n,selector:v,fallbackName:r.name,fallbackAuthor:a}),paragraphs:T(),theme:e}})({doc:t,fallbackAuthor:f.getInstance().get().author,theme:a.theme}),{paragraphs:r}=e,{html:n}=await ut({publishData:e,updateTemplateContent:({attr:t,template:a})=>a.replace("\x3c!-- DECKDECKGO_DOC --\x3e",`<article ${t||""} class="deckgo-doc">${r.join("")}</article>`),sourceFolder:"d"});return{html:n,publishData:e}})({doc:t,config:a}),{storageUpload:s,publishData:i}=await lt({indexHTML:o,folder:"d",meta:n}),c=pt({data:r,meta:r.meta,name:r.name,storageUpload:s}),l=await G({key:`/docs/${e}`,id:e,data:c});return await gt(s),await it({storageUpload:s,publishData:i}),{storageUpload:s,publishData:i,doc:l}})({doc:t,config:a});return await(async({dataId:t,storageUpload:a,publishData:e})=>{p({msg:"[list][start] docs"});const r=await J();p({msg:"[list][end] docs"}),await bt({storageUpload:a,publishData:e,dataId:t,entries:r})})({storageUpload:e,publishData:r,dataId:n.id,owner_id:t.data.owner_id}),(t=>{const{id:a,data:e}=t,r={id:a,data:Object.assign(Object.assign({},e),{deploy:{api:{status:"successful",updated_at:new Date}}})},n=new CustomEvent("docPublished",{detail:r});document.dispatchEvent(n)})(n),n},Tt=async()=>{const{bucketId:t}=await st();return`https://${t.toText()}.raw.ic0.app`},Kt=async({data:a,folder:e,maxSize:r})=>{const n=t();return Nt({data:a,folder:e,maxSize:r,identity:n,log:p})},Nt=async({data:t,maxSize:a,folder:r,identity:n,storageBucket:o,log:s})=>{if(!t||!t.name)throw new Error("File not valid.");if(t.size>a)throw new Error(`File is too big (max. ${a/1048576} Mb)`);const{actor:i,bucketId:c}=o||await e({identity:n});if(!i||!c)throw new Error("Storage bucket is not initialized.");const{fullPath:l,filename:d,token:u}=await rt({data:t,filename:ot(t.name),folder:r,storageActor:i,token:Y(),headers:[["cache-control","private, max-age=0"]],log:s});return{downloadUrl:`https://${c.toText()}.raw.ic0.app${l}?token=${u}`,fullPath:l,name:d}},St=async({folder:t})=>{const{actor:a,bucketId:e}=await st(),r=await a.list(u(t)),n=`https://${e.toText()}.raw.ic0.app`;return{items:r.map((({name:t,fullPath:a,token:e})=>({downloadUrl:`${n}${a}?token=${e}`,fullPath:a,name:t}))),nextPageToken:null}},Lt=async({downloadUrl:t,fullPath:a})=>{const{actor:e}=await st();let r=null;if(t){const{searchParams:a}=new URL(t);r=a.get("token")}return e.del({fullPath:a,token:u(r||void 0)})};function zt(t){return new Promise((function(a,e){t.oncomplete=t.onsuccess=function(){return a(t.result)},t.onabort=t.onerror=function(){return e(t.error)}}))}var Bt;function Gt(){return Bt||(t="keyval-store",a="keyval",r=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(t){var a=function(){return indexedDB.databases().finally(t)};e=setInterval(a,100),a()})).finally((function(){return clearInterval(e)})):Promise.resolve()).then((function(){var e=indexedDB.open(t);return e.onupgradeneeded=function(){return e.result.createObjectStore(a)},zt(e)})),Bt=function(t,e){return r.then((function(r){return e(r.transaction(a,t).objectStore(a))}))}),Bt;var t,a,e,r}const Mt=({data:t,storageFile:a,src:e})=>{const{downloadUrl:r,name:n}=a;let o=t.replaceAll(`img-src="${e}"`,`img-src="${r}"`);return o=o.replaceAll(`img-alt="${e}"`,`img-alt="${n}"`),o=o.replaceAll(`data-src="${e}"`,`data-src="${r}"`),o},Rt=async({selector:t,storageFile:a,folder:e,src:r})=>{const n=document.querySelector(t);if("deckgo-lazy-img"===(null==n?void 0:n.nodeName.toLowerCase()))return void await Wt({images:[n],storageFile:a,folder:e,src:r});const o=null==n?void 0:n.querySelectorAll("deckgo-lazy-img");await Wt({images:Array.from(o),storageFile:a,folder:e,src:r})},Wt=async({storageFile:t,folder:a="images",images:e,src:r})=>{const n=e.filter((t=>"data"===a?t.getAttribute("data-src")===r:t.imgSrc===r));if(!n||n.length<=0)return;const o=Array.from(n).map((e=>"data"===a?(async a=>{const{downloadUrl:e}=t;a.setAttribute("data-src",e)})(e):(async a=>{const{downloadUrl:e,name:r}=t;a.imgSrc=e,a.imgAlt=r})(e)));await Promise.all(o)},Ht=async({storageFile:t,src:a,key:e})=>{const r=(({paragraph:t,files:a})=>{if(!a)return Object.assign({},t);const e=a.filter((({src:t,storageFile:a})=>void 0!==t&&void 0!==a));let{children:r,nodeName:n,attributes:o}=t.data;return"deckgo-lazy-img"===n&&o&&e.forEach((({src:t,storageFile:a})=>{o=(({attributes:t,storageFile:a,src:e})=>{const{downloadUrl:r}=a;return Object.keys(t).reduce(((a,n)=>(a[n]=t[n]===e?r:t[n],a)),{})})({attributes:o,storageFile:a,src:t})})),r=null==r?void 0:r.map((t=>(e.forEach((({src:a,storageFile:e})=>{t=Mt({data:t,storageFile:e,src:a})})),t))),{id:t.id,data:Object.assign(Object.assign({},t.data),{updated_at:new Date,children:r,attributes:o})}})({paragraph:await Jt({key:e}),files:[{src:a,storageFile:t}]});await qt({key:e,data:r})},Jt=async({key:t})=>{const a=await function(t){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:Gt())("readonly",(function(a){return zt(a.get(t))}))}(t);if(!a)throw new Error("Data not found and that is really weird here.");return a},qt=async({key:t,data:a})=>function(t,a){return(arguments.length>2&&void 0!==arguments[2]?arguments[2]:Gt())("readwrite",(function(e){return e.put(a,t),zt(e.transaction)}))}(t,a),Qt=w(import("./p-bebbaf58.js").then((t=>t.worker)),"stencil.sync.ic.worker","uploadWorker"),Vt=async({msg:t,data:a})=>{"deckdeckgo_sync_deck_background"===t&&await(async t=>{(({storageFile:t})=>{const a=document.querySelector(`${$} > *[slot="background"]`),e=null==a?void 0:a.querySelector("deckgo-lazy-img");if(!e)return;const{downloadUrl:r,name:n}=t;e.imgSrc=r,e.imgAlt=n})(t),await(async({storageFile:t,src:a})=>{const e=document.querySelectorAll(`${$} .deckgo-slide-container:not([custom-background]) *[slot="background"] deckgo-lazy-img`);await Wt({images:Array.from(e),storageFile:t,src:a})})(t),await(async({storageFile:t,src:a,key:e})=>{const r=(({deck:t,storageFile:a,imgSrc:e})=>a&&e?{id:t.id,data:Object.assign(Object.assign({},t.data),{updated_at:new Date,background:Mt({data:t.data.background,src:e,storageFile:a})})}:Object.assign({},t))({deck:await Jt({key:e}),imgSrc:a,storageFile:t});await qt({key:e,data:r})})(t)})(a),"deckdeckgo_sync_slide_image"===t&&await(async t=>{const{selector:a}=t;a&&(await Rt(t),await(async({storageFile:t,src:a,key:e})=>{const r=(({slide:t,images:a})=>{if(!a)return Object.assign({},t);const e=a.filter((({src:t,storageFile:a})=>void 0!==t&&void 0!==a));let{content:r}=t.data;return e.forEach((({src:t,storageFile:a})=>{r=Mt({data:r,storageFile:a,src:t})})),{id:t.id,data:Object.assign(Object.assign({},t.data),{updated_at:new Date,content:r})}})({slide:await Jt({key:e}),images:[{src:a,storageFile:t}]});await qt({key:e,data:r})})(t))})(a),"deckdeckgo_sync_slide_chart"===t&&await(async t=>{const{selector:a}=t;a&&((({selector:t,storageFile:a})=>{const e=document.querySelector(t);if(!e||!e.nodeName||"deckgo-slide-chart"!==e.nodeName.toLowerCase())return;const{downloadUrl:r}=a;e.src=r})(t),await(async({storageFile:t,src:a,key:e})=>{const r=(({slide:t,chart:a})=>{if(!a)return Object.assign({},t);const{src:e,storageFile:r}=a;if(!e||!r)return Object.assign({},t);const{attributes:n}=t.data;if(!n)return Object.assign({},t);const{downloadUrl:o}=r;return{id:t.id,data:Object.assign(Object.assign({},t.data),{updated_at:new Date,attributes:Object.assign(Object.assign({},n),{src:o})})}})({slide:await Jt({key:e}),chart:{src:a,storageFile:t}});await qt({key:e,data:r})})(t))})(a),"deckdeckgo_sync_paragraph_image"===t&&await(async t=>{const{selector:a}=t;a&&(await Rt(t),await Ht(t))})(a)},Xt=async({syncData:a,clean:e})=>{if(!t())throw new Error("No internet identity to sync data");const r=await b();if(!y(k.fromJSON(r.delegationChain)))throw new Error("Internet identity has expired. Please login again.");await Qt({internetIdentity:r,syncData:a,env:f.getInstance().get()},Vt,p),await e(a)};export{N as canistersBalance,tt as createTemplate,R as deckEntries,Ft as deckPublish,W as deleteDeck,q as deleteDoc,Lt as deleteFile,J as docEntries,Et as docPublish,St as getFiles,V as getParagraph,X as getSlide,Z as getUserTemplates,Tt as publishUrl,H as snapshotDeck,Q as snapshotDoc,Xt as sync,at as updateTemplate,et as updateUser,Kt as uploadFile,Nt as uploadFileIC}