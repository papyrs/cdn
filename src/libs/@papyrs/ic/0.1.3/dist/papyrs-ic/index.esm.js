import{g as t,a,t as n,f as r,b as o,c,d as l,E as u,i as m}from"./p-d488c758.js";import{g as p,t as h,I as w,c as y,i as f,a as k}from"./p-dc7801c0.js";export{e as deleteAuth,g as getIdentity,b as initAuth,i as isAuthenticated,d as signIn,s as signOut}from"./p-dc7801c0.js";import{u as _,g as $,s as v,D}from"./p-8989bfdf.js";import"./p-963e2329.js";import"./p-82ae0ef6.js";var O=["id","hydrated","contenteditable","editable","spellcheck","highlighted","custom-loader","class","placeholder","data-gramm","data-gramm_id","data-gramm_editor","data-gr-id","data-selectable-paragraph"],j=["paragraph_id","data-src",...O],I=({node:t,deep:e=!0,attributes:a=O})=>{if(C(t))return t;if(E(t)){let i=t.cloneNode(e);U({element:i,attributes:a});let n=i.querySelectorAll(a.map((t=>`[${t}]`)).join(","));for(let t of Array.from(n))U({element:t,attributes:a});return i}return null},U=({element:t,attributes:e})=>{for(let a of e)t.removeAttribute(a)},C=t=>t?.nodeType===Node.TEXT_NODE||t?.nodeType===Node.COMMENT_NODE,E=t=>t?.nodeType===Node.ELEMENT_NODE,x="app-deck-editor > ion-content div.deck > main > deckgo-deck",A="deckgo-studio-doc",P=[{id:"google-fonts-lora",name:"Lora",family:"'Lora', serif"},{id:"google-fonts-roboto",name:"Roboto",family:"'Roboto', sans-serif"},{id:"google-fonts-open-sans",name:"Open Sans",family:"'Open Sans', sans-serif"},{id:"google-fonts-montserrat",name:"Montserrat",family:"'Montserrat', sans-serif"},{id:"google-fonts-cabin",name:"Cabin",family:"'Cabin', sans-serif"},{id:"google-fonts-lato",name:"Lato",family:"'Lato', sans-serif"},{id:"google-fonts-muli",name:"Muli",family:"'Muli', sans-serif"},{id:"google-fonts-source-sans-pro",name:"Source Sans Pro",family:"'Source Sans Pro', sans-serif"},{id:"google-fonts-libre-baskerville",name:"Libre Baskerville",family:"'Libre Baskerville', serif"},{id:"google-fonts-oswald",name:"Oswald",family:"'Oswald', sans-serif"},{id:"google-fonts-jura",name:"Jura",family:"'Jura', sans-serif"},{id:"google-fonts-fjord-one",name:"Fjord One",family:"'Fjord One', serif"},{id:"google-fonts-josefin-slab",name:"Josefin Slab",family:"'Josefin Slab', serif"}],T=async({meta:t,fallbackName:e,fallbackAuthor:a,selector:i,socialImgPath:n})=>{let r=[F(),N({meta:t})].filter((t=>void 0!==t)),o=K({selector:i}),s=await G(),c=(t?.title||e)?.trim();return{title:c,description:(t?.description||e)?.trim(),author:t?.author?.name??a,bio:t?.author?.bio,photo_url:t?.author?.photo_url,head_extra:r.length>0?r.join(""):void 0,attributes:o,social_image_name:encodeURI(c).toLowerCase(),social_image_value:s,social_links:z({meta:t,socialImgPath:n}),social_image_link:void 0,lang:t?.lang??"en"}},F=()=>{let t=document.querySelector(x)?.style.fontFamily;if(!t)return;let e=P.find((e=>t===e.family.replace(/\'/g,"")));return e?`<link rel="stylesheet" href="${(({font:t})=>`https://fonts.googleapis.com/css?display=swap&amp;family=${t.name.replace(" ","+")}`)({font:e})}">`:void 0},N=({meta:t})=>{if(t&&t.canonical)return`<link rel="canonical" href="${t.canonical}">`},K=({selector:t})=>{let e=document.querySelector(t)?.attributes;if(e)return Array.from(e).filter((({name:t})=>!["id","hydrated","class","contenteditable"].includes(t))).reduce(((t,{name:e,value:a})=>(t[e]=a,t)),{})},S=()=>{let t=document.querySelectorAll(`${x} > *[slide_id]`),e=({slide:t,custom:e})=>{if(t.hasAttribute(`custom-${e}`))return;let a=t.querySelector(`div[slot="${e}"]`);!a||t.removeChild(a)};return Array.from(t).map((t=>{let a=I({node:t,deep:!1,attributes:j});return Array.from(t.childNodes).forEach((t=>{E(t)&&t.hasAttribute("slot")&&(a.appendChild(I({node:t,attributes:j})),e({slide:a,custom:"background"}),e({slide:a,custom:"header"}),e({slide:a,custom:"footer"}))})),a})).map((t=>t.outerHTML))},L=()=>{let t=document.querySelectorAll(`${A} > article *[paragraph_id]`);return Array.from(t).map((t=>I({node:t,attributes:j}))).map((t=>t.outerHTML))},G=async()=>document.querySelector("deckgo-social-img")?.toBlob("image/png"),z=({meta:t,socialImgPath:e})=>{if(!t||!t.author)return;let{author:{social:a,name:i}}=t,n=({username:t,href:a,authorName:i,platformName:n,iconName:r})=>t&&""!==t?`<a href="https://${a}/${t}" aria-label="${i} on ${n}" rel="noopener norefferer"><deckgo-lazy-img svg-src="${e}/${r}.svg" role="presentation" alt="${n} logo" /></a>`:void 0,r=n({username:a?.twitter,href:"twitter.com",authorName:i,platformName:"Twitter",iconName:"twitter"}),o=n({username:a?.linkedin,href:"www.linkedin.com/in",authorName:i,platformName:"LinkedIn",iconName:"linkedin"}),s=n({username:a?.github,href:"github.com",authorName:i,platformName:"GitHub",iconName:"github"}),c=(({custom:t,authorName:a})=>t&&""!==t?`<a href="${t}" aria-label="${a}" rel="noopener norefferer"><deckgo-lazy-img svg-src="${e}/globe.svg" role="presentation" alt="" /></a>`:void 0)({custom:a?.custom,authorName:i});return void 0!==r||void 0!==o||void 0!==s||void 0!==c?`${[c,r,s,o].filter((t=>void 0!==t)).join("")}`:void 0},R=({selector:t})=>{let e=document.querySelector(`${t} > article *:nth-child(1)`),a=document.querySelector(`${t} > article *:nth-child(2)`),i=t=>{let e=t?.getAttribute("img-src");return 0===e?.indexOf("http")?e:void 0};if("deckgo-lazy-img"===e?.nodeName.toLowerCase())return i(e);if("deckgo-lazy-img"===a?.nodeName.toLowerCase())return i(a);let n=e?.querySelector("deckgo-lazy-img");return i(null!=n?n:a?.querySelector("deckgo-lazy-img"))},M=t=>{if(t&&void 0!==t)return t instanceof String||"string"==typeof t?new Date(`${t}`):"number"!=typeof t||isNaN(t)?t&&t.seconds>=0&&t.nanoseconds>=0?new Date(t.toDate()):t:new Date(t)};const B=async()=>{const e=p();if(!e)throw new Error("No internet identity to get the canisters status");const[i,n]=await Promise.all([t({identity:e}),a({identity:e})]),{actor:r,bucketId:o}=i,{actor:s,bucketId:c}=n,[d,l]=await Promise.all([r.cyclesBalance(),s.cyclesBalance()]);return{data:{bucketId:o,balance:d},storage:{bucketId:c,balance:l}}},H=async({startsWith:e,notContains:a})=>{const i=p();if(!i)return[];const{actor:r}=await t({identity:i});if(!r)return[];const o=(await r.list(n({startsWith:n(e),notContains:n(a)}))).map((([,t])=>W({data:t,identity:i})));return Promise.all(o)},W=async({data:t,identity:e})=>{const a=await r(t.data);return{id:t.id,data:Object.assign(Object.assign({},a),{owner_id:e.getPrincipal().toText()}),created_at:t.created_at,updated_at:t.updated_at}},q=async({key:t,actor:e})=>{const a=e||await Q(),i=o(await a.get(t));if(!i)return;const n=await r(i.data);return{id:i.id,data:n,created_at:i.created_at,updated_at:i.updated_at}},J=async()=>{const e=p();if(!e)throw new Error("No internet identity.");const a=await t({identity:e}),{actor:i,bucketId:n}=a;if(!i)throw new Error("No actor initialized.");if(!n)throw new Error("No bucket principal defined");return a},Q=async()=>{const{actor:t}=await J();return t},V=async({key:t,record:e,updateTimestamps:a=!1,actor:i,log:r})=>{null==r||r({msg:`[set][start] ${t}`,level:"info"});const o=performance.now(),s=await(async({key:t,record:e,actor:a})=>{const i=a||await Q(),{id:r,data:o,created_at:s,updated_at:d}=e,l=await i.put(t,{id:r,data:await c(o),created_at:n(s),updated_at:n(d)});return{id:r,data:o,created_at:l.created_at,updated_at:l.updated_at}})({key:t,actor:i,record:e});a&&await _(t,(({id:t,data:e})=>({id:t,data:e,created_at:s.created_at,updated_at:s.updated_at})));const d=performance.now();return null==r||r({msg:`[set][done] ${t}`,duration:d-o,level:"info"}),s},X=async({key:t,actor:e,log:a,data:i})=>{if(!t||!i)return;null==a||a({msg:`[delete][start] ${t}`,level:"info"});const n=performance.now();await(async({key:t,actor:e,data:a})=>{const i=e||await Q();await i.delete(t,a)})({key:t,actor:e,data:i});const r=performance.now();null==a||a({msg:`[delete][done] ${t}`,duration:r-n,level:"info"})},Y=async()=>H({startsWith:"/decks/",notContains:"/slides/"}),Z=async(t,e)=>X(Object.assign({key:`/decks/${t}`},void 0!==e&&{id:t,updated_at:e})),tt=async({onNext:t})=>{const e=["deckPublished","deckFeedSubmitted"];return e.forEach((e=>document.addEventListener(e,(async({detail:e})=>await t(e)),{passive:!0}))),()=>e.forEach((e=>document.removeEventListener(e,(({detail:e})=>t(e)),!1)))},et=async()=>H({startsWith:"/docs/",notContains:"/paragraphs/"}),at=async(t,e)=>X(Object.assign({key:`/docs/${t}`},void 0!==e&&{id:t,updated_at:e})),it=async({onNext:t})=>{const e=["docPublished","docFeedSubmitted"];return e.forEach((e=>document.addEventListener(e,(async({detail:e})=>await t(e)),{passive:!0}))),()=>e.forEach((e=>document.removeEventListener(e,(async({detail:e})=>await t(e)),!1)))},nt=(t,e)=>q({key:`/docs/${t}/paragraphs/${e}`}),rt=(t,e)=>q({key:`/decks/${t}/slides/${e}`});let ot=(t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce(((t,e)=>t+((e&=63)<36?e.toString(36):e<62?(e-26).toString(36).toUpperCase():e>62?"-":"_")),"");const st=()=>H({startsWith:"/templates/"}),ct=t=>{const e=ot(),a=new Date,i={id:e,data:Object.assign(Object.assign({},t),{updated_at:a,created_at:a})};return V({key:`/templates/${e}`,record:i})},dt=t=>{const{id:e}=t;return V({key:`/templates/${e}`,record:t})},lt=async t=>{h({msg:"[update][start] user",level:"info"});const e=performance.now(),a=await V({key:"/user",record:t}),i=performance.now();return h({msg:"[update][done] user",duration:i-e,level:"info"}),a},ut=({IDL:t})=>{const e=t.Principal,a=t.Record({storageId:t.Opt(e)}),i=t.Int,n=t.Record({linkedin:t.Opt(t.Text),twitter:t.Opt(t.Text),custom:t.Opt(t.Text),github:t.Opt(t.Text)}),r=t.Record({bio:t.Opt(t.Text),photo_url:t.Opt(t.Text),social:t.Opt(n),name:t.Text}),o=t.Record({title:t.Text,tags:t.Opt(t.Vec(t.Text)),description:t.Opt(t.Text),author:t.Opt(r)}),s=t.Record({id:t.Text,updated_at:i,meta:o,pathname:t.Text,storageId:e,created_at:i}),c=t.Variant({open:t.Null,accepted:t.Null,declined:t.Null}),d=t.Record({status:t.Opt(c)}),l=t.Variant({open:t.Null,accepted:t.Null,declined:t.Null}),u=t.Record({id:t.Text,meta:o,pathname:t.Text,storageId:e}),m=t.Record({status:l,updated_at:i,created_at:i,proposal:u}),p=t.Record({id:t.Text,meta:o,pathname:t.Text,storageId:e});return t.Service({accept:t.Func([t.Principal,t.Text],[],[]),decline:t.Func([t.Principal,t.Text],[],[]),del:t.Func([t.Principal,t.Text],[],[]),list:t.Func([t.Opt(a)],[t.Vec(t.Tuple(t.Text,s))],["query"]),listProposals:t.Func([t.Opt(d)],[t.Vec(t.Tuple(t.Text,m))],["query"]),submit:t.Func([t.Text,p],[],[])})},mt=async({doc:t})=>{const{data:{meta:e},id:a}=t;if(!e)throw new Error("No meta data to submit to feed");await gt({meta:e,id:a});const i=await ht({key:"docs",entry:t});return wt({data:i,type:"docFeedSubmitted"}),i},pt=async({deck:t})=>{const{data:{meta:e},id:a}=t;if(!e)throw new Error("No meta data to submit to feed");await gt({meta:e,id:a});const i=await ht({key:"decks",entry:t});return wt({data:i,type:"deckFeedSubmitted"}),i},gt=async({meta:t,id:e})=>{const i=p();if(!i)throw new Error("No internet identity to submit entry to feed");const{bucketId:r}=await a({identity:i});if(!r)throw new Error("No storage found. Is the document published?");h({msg:"[submit][start] feed",level:"info"});const o=performance.now(),s=await(({identity:t})=>l({canisterId:u.getInstance().get().feedCanisterId,idlFactory:ut,identity:t}))({identity:i}),c=u.getInstance().get().feedSecret,{pathname:d,title:m,description:g,tags:w,author:y}=t;if(!d)throw new Error("No pathname found. Is the document published?");await s.submit(c,{id:e,storageId:r,pathname:t.pathname,meta:{title:m,description:n(g),tags:n(w),author:n(y?{name:y.name,bio:n(y.bio),photo_url:n(y.photo_url),social:n(y.social?{twitter:n(y.social.twitter),linkedin:n(y.social.linkedin),github:n(y.social.github),custom:n(y.social.custom)}:void 0)}:void 0)}});const f=performance.now();h({msg:"[submit][done] feed",duration:f-o,level:"info"})},ht=async({key:t,entry:e})=>{var a;h({msg:`[update][start] ${t}`,level:"info"});const i=performance.now(),{id:n,data:r}=e,o=await $(`/${t}/${n}`),s=null!==(a=null==o?void 0:o.data)&&void 0!==a?a:r,c={id:n,data:Object.assign(Object.assign({},s),{meta:Object.assign(Object.assign({},s.meta),{feed:!0}),updated_at:new Date}),created_at:o.created_at,updated_at:o.updated_at},d=await V({key:`/${t}/${n}`,record:c,updateTimestamps:!0}),l=performance.now();return h({msg:`[update][done] ${t}`,duration:l-i,level:"info"}),d},wt=({data:t,type:e})=>{const a=new CustomEvent(e,{detail:t});document.dispatchEvent(a)},yt=async({key:e,ids:a})=>{const i=p();if(!i)throw new Error("No internet identity to get the count of interactions");const{actor:{listInteractions:n}}=await t({identity:i}),r=`/${e}/`,s=await n(a.map((t=>`${r}${t}`)));return(await Promise.all(s.map((t=>(async t=>{const{countLikes:e,like:a,countComments:i}=t[1],n=o(a),s={countLikes:e,like:void 0!==n?await ft(n):void 0,countComments:i};return{[t[0].replace(r,"")]:s}})(t))))).reduce(((t,e)=>Object.assign(Object.assign({},t),e)),{})},ft=async t=>{const e=await r(t.data);return{id:t.id,data:e,created_at:t.created_at,updated_at:t.updated_at,author_id:t.author.toText()}},bt=async({like:t,identity:e,key:a,id:i})=>{const r=new Date,o=void 0===t?{id:ot(),data:{like:!0,created_at:r,updated_at:r},author_id:e.getPrincipal().toText()}:Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{like:!t.data.like})}),{id:s,data:d,created_at:l,updated_at:u}=o;return{putKey:kt({key:a,id:i,identity:e}),putInteraction:{id:s,data:await c(d),author:e.getPrincipal(),created_at:n(l),updated_at:n(u)}}},kt=({key:t,id:e,identity:a})=>`/${t}/${e}/likes/${a.getPrincipal().toText()}`,_t=async({key:e,id:a,interaction:i})=>{const n=p();if(!n)throw new Error("No internet identity to save the interaction");const{actor:{putInteraction:r}}=await t({identity:n}),{putKey:o,putInteraction:s}=await bt({key:e,id:a,like:i,identity:n}),c=await r(o,s);return ft(c)},$t=({identity:t,canisterId:e})=>l({canisterId:e,idlFactory:m,identity:t}),vt=async({key:t,id:e,canisterId:a})=>{const i=p(),{countLikes:n}=await $t({identity:i,canisterId:a});return n(`/${t}/${e}`)},Dt=async({key:t,id:e,canisterId:a})=>{const i=p();if(!i)return;const{getLike:n}=await $t({identity:i,canisterId:a}),r=o(await n(kt({key:t,id:e,identity:i})));return r?ft(r):void 0},Ot=async({key:t,id:e,like:a,canisterId:i})=>{const n=p();if(!n)throw new Error("No internet identity to record the like");const{putInteraction:r}=await $t({identity:n,canisterId:i}),{putKey:o,putInteraction:s}=await bt({key:t,id:e,like:a,identity:n}),c=await r(o,s);return ft(c)},jt=async({data:t,filename:e,folder:a,storageActor:i,headers:r,token:o,fullPath:s,log:c,sha256:d})=>{c({msg:`[upload][start] ${e}`,level:"info"});const l=performance.now(),u=s||`/${a}/${e}`,{batch_id:m}=await i.initUpload({name:e,full_path:u,token:n(o),folder:a,sha256:n(d)}),p=performance.now();c({msg:`[upload][create batch] ${e}`,duration:p-l,level:"info"});const g=7e5,h=[],w=new Blob([await t.arrayBuffer()]);for(let t=0;t<w.size;t+=g){const e=w.slice(t,t+g);h.push(await It({batchId:m,chunk:e,storageActor:i}))}const y=performance.now();c({msg:`[upload][chunks] ${e}`,duration:y-p,level:"info"}),await i.commitUpload({batch_id:m,chunk_ids:h.map((({chunk_id:t})=>t)),headers:[["Content-Type",t.type],["accept-ranges","bytes"],...r]});const f=performance.now();return c({msg:`[upload][commit batch] ${e}`,duration:f-y,level:"info"}),c({msg:`[upload][done] ${e}`,duration:f-l,level:"info"}),{fullPath:u,filename:e,token:o}},It=async({batchId:t,chunk:e,storageActor:a})=>a.uploadChunk({batch_id:t,content:[...new Uint8Array(await e.arrayBuffer())]}),Ut=t=>encodeURI(t.toLowerCase().replace(/\s/g,"-")),Ct=async()=>{const t=p();if(!t)throw new Error("No internet identity.");const e=await a({identity:t}),{actor:i,bucketId:n}=e;if(!i)throw new Error("No actor initialized.");if(!n)throw new Error("No bucket principal defined");return e},Et=t=>{const e=(new TextEncoder).encode(t);return crypto.subtle.digest("SHA-256",e)},xt=t=>btoa([...t].map((t=>String.fromCharCode(t))).join("")),At=({social_image_link:t})=>void 0!==t&&t.includes("unsplash.com"),Pt=async({storageUpload:t,publishData:e})=>{const{social_image_name:a,social_image_value:i}=e;if(At(e))return;if(!i)return;const{actor:n}=t;await jt({data:i,filename:`${a}.png`,folder:"meta",storageActor:n,headers:[["Cache-Control","max-age=3600"]],log:h})},Tt=async({template:t,data:e,ids:a})=>{const i=[...Object.entries(e),...Object.entries(a)].reduce(((t,[e,a])=>t.replaceAll(`{{DECKDECKGO_${e.toUpperCase()}}}`,a||"").replaceAll(`%%DECKDECKGO_${e.toUpperCase()}%%`,a||"").replaceAll(`\x3c!-- DECKDECKGO_${e.toUpperCase()} --\x3e`,a||"")),t),{data_canister_id:n,storage_canister_id:r}=a,{data_id:o}=a,s=`window.data_canister_id = "${n}";window.storage_canister_id = "${r}";window.data_id = "${null!=o?o:""}";`,c=i.replaceAll("\x3c!-- DECKDECKGO_IDS_SCRIPT --\x3e",`<script>${s}<\/script>`),d=xt(new Uint8Array(await Et(s)));return c.replaceAll("{{DECKDECKGO_IDS_SHAS}}",`'sha256-${d}'`)},Ft=async({indexHTML:t,folder:e,meta:a})=>{const{html:i,publishData:n}=t,{bucketId:r,actor:o}=await Ct(),{filename:s,pathname:c}=Nt({publishData:n,meta:a,folder:e}),d=`https://${r.toText()}.raw.ic0.app`,l=`${d}${c}`;let u=i.replace("{{DECKDECKGO_URL}}",l);return u=(({html:t,data:e,bucketUrl:a})=>{const{social_image_name:i}=e;if(At(e)){const{social_image_link:a}=e;return t.replaceAll("{{DECKDECKGO_SOCIAL_IMAGE}}",a)}return t.replaceAll("{{DECKDECKGO_SOCIAL_IMAGE}}",`${a}/meta/${i}.png`)})({html:u,data:n,bucketUrl:d}),{storageUpload:{html:u,actor:o,filename:s,pathname:c,fullUrl:l,bucketUrl:d,folder:e},publishData:n}},Nt=({publishData:t,meta:e,folder:a})=>{if(null==e?void 0:e.pathname){const{pathname:t}=e;return{filename:t.replace(`/${a}/`,""),pathname:t}}const i=Ut(t.title);return{filename:i,pathname:`/${a}/${i}`}},Kt=async({publishData:t,ids:e,updateTemplateContent:a,sourceFolder:i})=>{const n=await St(i),r=await Tt({template:n,data:t,ids:e}),{attributes:o}=t;return{html:a({attr:o?Object.entries(o).reduce(((t,[e,a])=>`${e}="${a}"; ${t}`),"").trim():void 0,template:r})}},St=async t=>(await fetch(`${u.getInstance().get().kitPath}/${t}/index.html`)).text(),Lt=({data:t,storageUpload:e,meta:a,name:i})=>{var n;const{pathname:r}=e,o=new Date;return Object.assign(Object.assign({},t),{meta:Object.assign(Object.assign({},a||{title:i}),{pathname:r,published:!0,published_at:null!==(n=a.published_at)&&void 0!==n?n:o,updated_at:o})})},Gt=async({filename:t,html:e,actor:a,folder:i})=>{await jt({data:new Blob([e],{type:"text/html"}),filename:t,folder:i,storageActor:a,headers:[["Cache-Control","max-age=3600"]],log:h})},zt=()=>u.getInstance().get().author;const Rt=({content:t,bucketUrl:e,metas:a,selector:i})=>{const n=a.map((({dataId:t,meta:a})=>Mt({dataId:t,meta:a,bucketUrl:e})));return t.replace(i,n.join(""))},Mt=({dataId:t,bucketUrl:e,meta:a})=>{var i,n;const{title:r,pathname:o}=a,s=`${e}${o}`,c=null!=(null==a?void 0:a.description)&&""!==(null==a?void 0:a.description)?`<p class="description">${a.description}</p>`:"",{format:d}=new Intl.DateTimeFormat("en",{year:"numeric",month:"short",day:"2-digit",hour:"numeric",minute:"numeric",second:"numeric"});return`<a data-id="${t}" href="${s}" rel="noopener noreferrer"><article><div><h3>${r}</h3>${c}</div><div><p>Published: ${d(null!==(i=M(null==a?void 0:a.published_at))&&void 0!==i?i:new Date)}</p><p>Edited: ${d(null!==(n=M(null==a?void 0:a.updated_at))&&void 0!==n?n:new Date)}</p></div></article></a>`},Bt=t=>`<url>\n  <loc>${t}</loc>\n  <changefreq>daily</changefreq>\n  <priority>0.7</priority>\n</url>`,Ht=t=>t.filter((({data:t})=>{var e;return!0===(null===(e=t.meta)||void 0===e?void 0:e.published)})).sort((({data:{meta:{published_at:t}}},{data:{meta:{published_at:e}}})=>{var a,i;return((null===(a=M(e))||void 0===a?void 0:a.getTime())||0)-((null===(i=M(t))||void 0===i?void 0:i.getTime())||0)})).map((({id:t,data:{meta:e}})=>({dataId:t,meta:e}))),Wt=async({storageUpload:t,publishData:e,entries:a,canisterIds:i})=>{const n=Ht(a),r=[Qt({storageUpload:t,publishData:e,metas:n,canisterIds:i}),Jt({storageUpload:t,metas:n}),qt({storageUpload:t,metas:n,publishData:e})];await Promise.all(r)},qt=async({storageUpload:t,metas:e,publishData:a})=>{const{bucketUrl:i,actor:n}=t,{author:r}=a,o=(({bucketUrl:t,metas:e,author:a})=>(({items:t,author:e,bucketUrl:a})=>`<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" version="2.0">\n    <channel>\n        <title><![CDATA[${e} blog]]></title>\n        <description><![CDATA[The latest blog posts of ${e}]]></description>\n        <link>${a}</link>\n        <lastBuildDate>${(new Date).toUTCString()}</lastBuildDate>\n        \n        ${t}\n    </channel>\n</rss>`)({bucketUrl:t,items:(({metas:t,bucketUrl:e})=>t.map((({meta:{title:t,description:a,pathname:i,published_at:n}})=>{var r;return`\n  <item>\n    <title><![CDATA[${t}]]></title>\n    <description><![CDATA[${null!=a?a:t}]]></description>\n    <link>${e}${i}</link>\n    <pubDate>${(null!==(r=M(n))&&void 0!==r?r:new Date).toUTCString()}</pubDate>\n  </item>\n`})))({metas:e,bucketUrl:t}).join(""),author:a}))({bucketUrl:i,metas:e,author:r||zt()});await Yt({rss:o,actor:n})},Jt=async({storageUpload:t,metas:e})=>{const{bucketUrl:a,actor:i}=t,n=(({bucketUrl:t,metas:e})=>`<?xml version="1.0" encoding="UTF-8" ?>\n  <urlset\n    xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"\n    xmlns:news="http://www.google.com/schemas/sitemap-news/0.9"\n    xmlns:xhtml="http://www.w3.org/1999/xhtml"\n    xmlns:image="http://www.google.com/schemas/sitemap-image/1.1"\n    xmlns:video="http://www.google.com/schemas/sitemap-video/1.1"\n  >\n    ${[Bt(t),...e.map((({meta:{pathname:e}})=>Bt(`${t}${e}`)))].join("")}\n</urlset>`)({bucketUrl:a,metas:e});await Xt({sitemap:n,actor:i})},Qt=async({storageUpload:t,publishData:e,metas:a,canisterIds:i})=>{const{bucketUrl:n,actor:r}=t,o=await(async({bucketUrl:t,publishData:e,metas:a,canisterIds:i})=>{const n=await(async()=>(await fetch(`${u.getInstance().get().kitPath}/index.html`)).text())(),{photo_url:r}=e,o=function(t,e){var a={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(a[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(t,i[n])&&(a[i[n]]=t[i[n]])}return a}(e,["photo_url"]);let s=await Tt({template:n,data:o,ids:i});return s=(({photo_url:t,html:e})=>t?e.replace("\x3c!-- DECKDECKGO_PHOTO_URL --\x3e",`<img role="presentation" alt="" loading="lazy" src="${t}" />`):e)({html:s,photo_url:r}),s=Rt({content:s,bucketUrl:t,metas:a,selector:/<!-- DECKDECKGO_DATA -->/}),s})({bucketUrl:n,publishData:e,metas:a,canisterIds:i});await Vt({html:o,actor:r})},Vt=async({html:t,actor:e})=>Zt({actor:e,content:t,mimeType:"text/html",fullPath:"/",filename:"index.html"}),Xt=async({sitemap:t,actor:e})=>Zt({actor:e,content:t,mimeType:"application/xml",fullPath:"/sitemap.xml",filename:"sitemap.xml",maxAge:3600}),Yt=async({rss:t,actor:e})=>Zt({actor:e,content:t,mimeType:"application/xml",fullPath:"/rss.xml",filename:"rss.xml",maxAge:3600}),Zt=async({content:t,actor:e,mimeType:a,filename:i,fullPath:n,maxAge:r=0})=>{await jt({data:new Blob([t],{type:a}),filename:i,folder:"resources",storageActor:e,headers:[["Cache-Control",`max-age=${r}`]],fullPath:n,log:h})},te=async({bucketUrl:t,identity:e})=>{const a=await et(e.getPrincipal().toText()),i=Ht(a),n=await(async({metas:t,bucketUrl:e})=>{const a=await(async t=>{const e=await fetch(t);if(e.ok)return e.text()})(e);if(!a)return;const i=[...a.matchAll(/<section id="posts"[\s\S]*?>([\s\S]*?)<\/section>/gm)];return i.length<1&&i[0].length<2?void 0:Rt({content:a,metas:t,bucketUrl:e,selector:i[0][1]})})({bucketUrl:t,metas:i});if(!n)return;const{actor:r}=await Ct();await Vt({html:n,actor:r})},ee=()=>u.getInstance().get().kitPath,ae=async({meta:t,ids:e})=>{const{actor:a}=await Ct(),i=await a.list(n("resources")),r=(await se()).map((n=>ne({kit:n,actor:a,meta:t,ids:e,assetKeys:i})));await Promise.all(r)},ie=({src:t,sha256:e,assetKeys:a})=>{var i;const n=t.replace(ee(),""),r=a.find((({full_path:t})=>n===t)),s=xt(new Uint8Array(null!==(i=o(null==r?void 0:r.sha256))&&void 0!==i?i:[]));return void 0===r||void 0===e||e!==s},ne=async({kit:t,actor:e,meta:a,ids:i,assetKeys:n})=>{const{updateContent:r}=t;if(void 0!==r)return void await(async({kit:t,actor:e,meta:a,ids:i,assetKeys:n})=>{const{src:r,filename:o,mimeType:s,updateContent:c,headers:d}=t,l=c({content:await oe(r),meta:a,ids:i}),u=xt(new Uint8Array(await Et(l)));ie({src:r,sha256:u,assetKeys:n})&&await re({filename:o,content:l,actor:e,mimeType:s,headers:d,fullPath:r.replace(ee(),"")})})({kit:t,actor:e,meta:a,ids:i,assetKeys:n});const{src:o,filename:s,mimeType:c,headers:d,sha256:l}=t;if(!ie({src:o,sha256:l,assetKeys:n}))return;const u=await oe(o),m=r?r({content:u,meta:a,ids:i}):u;await re({filename:s,content:m,actor:e,mimeType:c,headers:d,fullPath:o.replace(ee(),"")})},re=async({filename:t,fullPath:e,content:a,actor:i,mimeType:n,headers:r})=>{const o=[...new Uint8Array(await Et(a))];await jt({data:new Blob([a],{type:n}),filename:t,folder:"resources",storageActor:i,fullPath:e,headers:r,log:h,sha256:o})},oe=async t=>(await fetch(t)).text(),se=async()=>{const t=ee();return(await(await fetch(`${t}/build.json`)).json()).map((e=>(e=>{const a="string"==typeof e?`${t}/${e}`:`${t}/${e.fullPath}`,i="string"==typeof e?void 0:e.sha256;return a.includes("hoisted.js")?{src:a,mimeType:"text/javascript",sha256:i,updateContent:({content:t,ids:{data_canister_id:e,data_id:a,storage_canister_id:i}})=>t.replace("{{DECKDECKGO_DATA_CANISTER_ID}}",e).replace("{{DECKDECKGO_STORAGE_CANISTER_ID}}",i).replace("{{DECKDECKGO_DATA_ID}}",a)}:a.includes(".js")?{src:a,mimeType:"text/javascript",sha256:i}:a.includes(".css")?{src:a,mimeType:"text/css",sha256:i}:a.includes(".webmanifest")?{src:a,mimeType:"application/manifest+json",sha256:i,updateContent:({content:t,meta:e})=>{var a;return t.replace("{{DECKDECKGO_AUTHOR}}",(null===(a=null==e?void 0:e.author)||void 0===a?void 0:a.name)||zt())}}:{src:a,mimeType:"text/plain",sha256:i}})(e))).map((t=>{const{pathname:e}=new URL(t.src);return Object.assign(Object.assign({},t),{filename:e.split("/").pop(),headers:[["Cache-Control","max-age=31536000"]]})}))},ce=async({deck:t})=>{const e=await le();await ae({meta:t.data.meta,ids:Object.assign(Object.assign({},e),{data_id:t.id})});const{storageUpload:a,publishData:i,deck:n}=await(async({deck:t,canisterIds:e})=>{const{id:a,data:i}=t,{meta:n}=i,r=await(async({deck:t,canisterIds:e})=>{const a=await(async({deck:t,fallbackAuthor:e})=>{let{data:a}=t,{meta:i,background:n,footer:r,header:o}=a??{};return{...await T({meta:i,selector:x,fallbackName:a?.name??"",fallbackAuthor:e}),slides:S(),background:n?`<div slot="background">${n}</div>`:void 0,header:n?`<div slot="header">${o}</div>`:void 0,footer:n?`<div slot="footer">${r}</div>`:void 0}})({deck:t,fallbackAuthor:u.getInstance().get().author}),{slides:i}=a,{html:n}=await Kt({publishData:a,ids:Object.assign(Object.assign({},e),{data_id:t.id}),updateTemplateContent:({attr:t,template:e})=>e.replace("\x3c!-- DECKDECKGO_DECK --\x3e",`<deckgo-deck id="slider" embedded="true" ${t||""}>${i.join("")}</deckgo-deck>`),sourceFolder:"p"});return{html:n,publishData:a}})({deck:t,canisterIds:e}),{storageUpload:o,publishData:s}=await Ft({indexHTML:r,folder:"p",meta:n}),c=Lt({data:i,meta:i.meta,name:i.name,storageUpload:o});await _(`/decks/${a}`,(t=>Object.assign(Object.assign({},t),{data:c})));const d=await $(`/decks/${a}`),l=await V({key:`/decks/${a}`,record:d,updateTimestamps:!0});return await Gt(o),await Pt({storageUpload:o,publishData:s}),{storageUpload:o,publishData:s,deck:l}})({deck:t,canisterIds:e});return await(async({storageUpload:t,publishData:e,canisterIds:a})=>{h({msg:"[list][start] decks",level:"info"});const i=await Y();h({msg:"[list][start] end",level:"info"}),await Wt({storageUpload:t,publishData:e,entries:i,canisterIds:a})})({storageUpload:a,publishData:i,owner_id:t.data.owner_id,canisterIds:e}),(t=>{const{id:e,data:a}=t,i={id:e,data:Object.assign(Object.assign({},a),{deploy:{api:{status:"successful",updated_at:new Date}}})},n=new CustomEvent("deckPublished",{detail:i});document.dispatchEvent(n)})(n),n},de=async({doc:t,config:e})=>{const a=await le();await ae({meta:t.data.meta,ids:Object.assign(Object.assign({},a),{data_id:t.id})});const{storageUpload:i,publishData:n,doc:r}=await(async({doc:t,config:e,canisterIds:a})=>{const{id:i,data:n}=t,{meta:r}=n,o=await(async({doc:t,config:e,canisterIds:a})=>{const{theme:i,socialImgPath:n}=e,r=await(async({doc:t,fallbackAuthor:e,theme:a,socialImgPath:i})=>{let{data:n}=t,{meta:r}=n??{};return{...await T({meta:r,selector:A,fallbackName:n?.name??"",fallbackAuthor:e,socialImgPath:i}),paragraphs:L(),theme:a,social_image_link:R({selector:A})}})({doc:t,fallbackAuthor:u.getInstance().get().author,theme:i,socialImgPath:n}),{paragraphs:o}=r,{html:s}=await Kt({publishData:r,ids:Object.assign(Object.assign({},a),{data_id:t.id}),updateTemplateContent:({attr:t,template:e})=>e.replace("\x3c!-- DECKDECKGO_DOC --\x3e",`<article ${t||""} class="deckgo-doc">${o.join("")}</article>`),sourceFolder:"d"});return{html:s,publishData:r}})({doc:t,config:e,canisterIds:a}),{storageUpload:s,publishData:c}=await Ft({indexHTML:o,folder:"d",meta:r}),d=Lt({data:n,meta:n.meta,name:n.name,storageUpload:s});await _(`/docs/${i}`,(t=>Object.assign(Object.assign({},t),{data:d})));const l=await $(`/docs/${i}`),m=await V({key:`/docs/${i}`,record:l,updateTimestamps:!0});return await Gt(s),await Pt({storageUpload:s,publishData:c}),{storageUpload:s,publishData:c,doc:m}})({doc:t,config:e,canisterIds:a});return await(async({storageUpload:t,publishData:e,canisterIds:a})=>{h({msg:"[list][start] docs",level:"info"});const i=await et();h({msg:"[list][end] docs",level:"info"}),await Wt({storageUpload:t,publishData:e,entries:i,canisterIds:a})})({storageUpload:i,publishData:n,owner_id:t.data.owner_id,canisterIds:a}),(t=>{const{id:e,data:a}=t,i={id:e,data:Object.assign(Object.assign({},a),{deploy:{api:{status:"successful",updated_at:new Date}}})},n=new CustomEvent("docPublished",{detail:i});document.dispatchEvent(n)})(r),r},le=async()=>{const[{bucketId:t},{bucketId:e}]=await Promise.all([J(),Ct()]);return{data_canister_id:t.toText(),storage_canister_id:e.toText()}},ue=async()=>{const{bucketId:t}=await Ct();return u.getInstance().localIdentity()?`http://${t.toText()}.localhost:8000`:`https://${t.toText()}.raw.ic0.app`},me=async()=>{const t=p();if(!t)throw new Error("No internet identity provided to list the entries that should be listed on the landing page");const e=await ue();await te({bucketUrl:e,identity:t})},pe=async({data:t,folder:e,maxSize:a})=>{const i=p();return ge({data:t,folder:e,maxSize:a,identity:i,log:h})},ge=async({data:t,maxSize:e,folder:i,identity:n,storageBucket:r,log:o})=>{if(!t||!t.name)throw new Error("File not valid.");if(t.size>e)throw new Error(`File is too big (max. ${e/1048576} Mb)`);const{actor:s,bucketId:c}=r||await a({identity:n});if(!s||!c)throw new Error("Storage bucket is not initialized.");const{fullPath:d,filename:l,token:u}=await jt({data:t,filename:Ut(t.name),folder:i,storageActor:s,token:ot(),headers:[["cache-control","private, max-age=0"]],log:o});return{downloadUrl:`https://${c.toText()}.raw.ic0.app${d}?token=${u}`,fullPath:d,name:l}},he=async({folder:t})=>{const{actor:e,bucketId:a}=await Ct(),i=await e.list(n(t)),r=`https://${a.toText()}.raw.ic0.app`;return{items:i.map((({name:t,full_path:e,token:a})=>({downloadUrl:`${r}${e}?token=${a}`,fullPath:e,name:t}))),nextPageToken:null}},we=async({downloadUrl:t,fullPath:e})=>{const{actor:a}=await Ct();let i=null;if(t){const{searchParams:e}=new URL(t);i=e.get("token")}return a.del({full_path:e,token:n(i||void 0)})},ye=({data:t,storageFile:e,src:a})=>{const{downloadUrl:i,name:n}=e;let r=t.replaceAll(`img-src="${a}"`,`img-src="${i}"`);return r=r.replaceAll(`img-alt="${a}"`,`img-alt="${n}"`),r=r.replaceAll(`data-src="${a}"`,`data-src="${i}"`),r},fe=async({selector:t,storageFile:e,folder:a,src:i})=>{const n=document.querySelector(t);if("deckgo-lazy-img"===(null==n?void 0:n.nodeName.toLowerCase()))return void await be({images:[n],storageFile:e,folder:a,src:i});const r=null==n?void 0:n.querySelectorAll("deckgo-lazy-img");await be({images:Array.from(r),storageFile:e,folder:a,src:i})},be=async({storageFile:t,folder:e="images",images:a,src:i})=>{const n=a.filter((t=>"data"===e?t.getAttribute("data-src")===i:t.imgSrc===i));if(!n||n.length<=0)return;const r=Array.from(n).map((a=>"data"===e?(async e=>{const{downloadUrl:a}=t;e.setAttribute("data-src",a)})(a):(async e=>{const{downloadUrl:a,name:i}=t;e.imgSrc=a,e.imgAlt=i})(a)));await Promise.all(r)},ke=async({storageFile:t,src:e,key:a})=>{const i=(({paragraph:t,files:e})=>{if(!e)return Object.assign({},t);const a=e.filter((({src:t,storageFile:e})=>void 0!==t&&void 0!==e));let{children:i,nodeName:n,attributes:r}=t.data;return"deckgo-lazy-img"===n&&r&&a.forEach((({src:t,storageFile:e})=>{r=(({attributes:t,storageFile:e,src:a})=>{const{downloadUrl:i}=e;return Object.keys(t).reduce(((e,n)=>(e[n]=t[n]===a?i:t[n],e)),{})})({attributes:r,storageFile:e,src:t})})),i=null==i?void 0:i.map((t=>(a.forEach((({src:e,storageFile:a})=>{t=ye({data:t,storageFile:a,src:e})})),t))),Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,children:i,attributes:r})})})({paragraph:await _e({key:a}),files:[{src:e,storageFile:t}]});await $e({key:a,data:i})},_e=async({key:t})=>{const e=await $(t);if(!e)throw new Error("Data not found and that is really weird here.");return e},$e=async({key:t,data:e})=>v(t,e),ve=y(import("./p-a4dd4232.js").then((t=>t.worker)),"stencil.sync.ic.worker","uploadWorker"),De=async({msg:t,data:e})=>{"deckdeckgo_sync_deck_background"===t&&await(async t=>{(({storageFile:t})=>{const e=document.querySelector(`${x} > *[slot="background"]`),a=null==e?void 0:e.querySelector("deckgo-lazy-img");if(!a)return;const{downloadUrl:i,name:n}=t;a.imgSrc=i,a.imgAlt=n})(t),await(async({storageFile:t,src:e})=>{const a=document.querySelectorAll(`${x} .deckgo-slide-container:not([custom-background]) *[slot="background"] deckgo-lazy-img`);await be({images:Array.from(a),storageFile:t,src:e})})(t),await(async({storageFile:t,src:e,key:a})=>{const i=(({deck:t,storageFile:e,imgSrc:a})=>e&&a?Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,background:ye({data:t.data.background,src:a,storageFile:e})})}):Object.assign({},t))({deck:await _e({key:a}),imgSrc:e,storageFile:t});await $e({key:a,data:i})})(t)})(e),"deckdeckgo_sync_slide_image"===t&&await(async t=>{const{selector:e}=t;e&&(await fe(t),await(async({storageFile:t,src:e,key:a})=>{const i=(({slide:t,images:e})=>{if(!e)return Object.assign({},t);const a=e.filter((({src:t,storageFile:e})=>void 0!==t&&void 0!==e));let{content:i}=t.data;return a.forEach((({src:t,storageFile:e})=>{i=ye({data:i,storageFile:e,src:t})})),Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,content:i})})})({slide:await _e({key:a}),images:[{src:e,storageFile:t}]});await $e({key:a,data:i})})(t))})(e),"deckdeckgo_sync_slide_chart"===t&&await(async t=>{const{selector:e}=t;e&&((({selector:t,storageFile:e})=>{const a=document.querySelector(t);if(!a||!a.nodeName||"deckgo-slide-chart"!==a.nodeName.toLowerCase())return;const{downloadUrl:i}=e;a.src=i})(t),await(async({storageFile:t,src:e,key:a})=>{const i=(({slide:t,chart:e})=>{if(!e)return Object.assign({},t);const{src:a,storageFile:i}=e;if(!a||!i)return Object.assign({},t);const{attributes:n}=t.data;if(!n)return Object.assign({},t);const{downloadUrl:r}=i;return Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,attributes:Object.assign(Object.assign({},n),{src:r})})})})({slide:await _e({key:a}),chart:{src:e,storageFile:t}});await $e({key:a,data:i})})(t))})(e),"deckdeckgo_sync_paragraph_image"===t&&await(async t=>{const{selector:e}=t;e&&(await fe(t),await ke(t))})(e)},Oe=async({syncData:t,clean:e})=>{const a=p(),[i,n]=await(async()=>{const t=new w;return Promise.all([t.get("delegation"),t.get("identity")])})();if(!a||!n)throw h({msg:"[identity] no internet identity to sync data. Please login again.",level:"error"}),new Error("No internet identity to sync data. Please login again.");if(!0!==await f())throw h({msg:"[identity] internet identity has expired. Please login again.",level:"error"}),new Error("Internet identity has expired. Please login again.");if(!k(D.fromJSON(i)))throw h({msg:"[identity] delegation has expired. Please login again.",level:"error"}),new Error("Delegation has expired. Please login again.");await ve({syncData:t,env:u.getInstance().get()},De,h),await e(t)};export{B as canistersBalance,vt as countLikes,ct as createTemplate,Y as deckEntries,ce as deckPublish,pt as deckSubmitFeed,Z as deleteDeck,at as deleteDoc,we as deleteFile,et as docEntries,de as docPublish,mt as docSubmitFeed,he as getFiles,Dt as getLike,nt as getParagraph,rt as getSlide,st as getUserTemplates,bt as initLikePut,Ot as likeDislike,kt as likeKey,yt as listInteractions,ue as publishUrl,_t as putInteraction,tt as snapshotDeck,it as snapshotDoc,Oe as sync,ft as toInteraction,me as updateLanding,dt as updateTemplate,lt as updateUser,pe as uploadFile,ge as uploadFileIC}