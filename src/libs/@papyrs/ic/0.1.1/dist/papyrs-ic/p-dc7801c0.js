import{E as t,e,h as i}from"./p-d488c758.js";import{P as n,g as s,A as o}from"./p-963e2329.js";import{E as a,D as r,a as c,b as l,d as u}from"./p-8989bfdf.js";import{c as d}from"./p-82ae0ef6.js";var h=t=>{let e=new CustomEvent("ddgLog",{detail:t,bubbles:!0});document.dispatchEvent(e)};function w(t,e){for(const{delegation:e}of t.delegations)if(+new Date(Number(e.expiration/BigInt(1e6)))<=+Date.now())return!1;const i=[],s=null==e?void 0:e.scope;s&&(Array.isArray(s)?i.push(...s.map((t=>"string"==typeof t?n.fromText(t):t))):i.push("string"==typeof s?n.fromText(s):s));for(const e of i){const i=e.toText();for(const{delegation:e}of t.delegations){if(void 0===e.targets)continue;let t=!0;for(const n of e.targets)if(n.toText()===i){t=!1;break}if(t)return!1}}return!0}const f=["mousedown","mousemove","keydown","touchstart","wheel"];let v,m;const g=new WeakMap,y=new WeakMap,p=new WeakMap,b=new WeakMap,I=new WeakMap;let D={get(t,e,i){if(t instanceof IDBTransaction){if("done"===e)return y.get(t);if("objectStoreNames"===e)return t.objectStoreNames||p.get(t);if("store"===e)return i.objectStoreNames[1]?void 0:i.objectStore(i.objectStoreNames[0])}return k(t[e])},set:(t,e,i)=>(t[e]=i,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function B(t){return"function"==typeof t?(e=t)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(m||(m=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(T(this),t),k(g.get(this))}:function(...t){return k(e.apply(T(this),t))}:function(t,...i){const n=e.call(T(this),t,...i);return p.set(n,t.sort?t.sort():[t]),k(n)}:(t instanceof IDBTransaction&&function(t){if(y.has(t))return;const e=new Promise(((e,i)=>{const n=()=>{t.removeEventListener("complete",s),t.removeEventListener("error",o),t.removeEventListener("abort",o)},s=()=>{e(),n()},o=()=>{i(t.error||new DOMException("AbortError","AbortError")),n()};t.addEventListener("complete",s),t.addEventListener("error",o),t.addEventListener("abort",o)}));y.set(t,e)}(t),i=t,(v||(v=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((t=>i instanceof t))?new Proxy(t,D):t);var e,i}function k(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,i)=>{const n=()=>{t.removeEventListener("success",s),t.removeEventListener("error",o)},s=()=>{e(k(t.result)),n()},o=()=>{i(t.error),n()};t.addEventListener("success",s),t.addEventListener("error",o)}));return e.then((e=>{e instanceof IDBCursor&&g.set(e,t)})).catch((()=>{})),I.set(e,t),e}(t);if(b.has(t))return b.get(t);const e=B(t);return e!==t&&(b.set(t,e),I.set(e,t)),e}const T=t=>I.get(t),j=["get","getKey","getAll","getAllKeys","count"],S=["put","add","delete","clear"],E=new Map;function O(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(E.get(e))return E.get(e);const i=e.replace(/FromIndex$/,""),n=e!==i,s=S.includes(i);if(!(i in(n?IDBIndex:IDBObjectStore).prototype)||!s&&!j.includes(i))return;const o=async function(t,...e){const o=this.transaction(t,s?"readwrite":"readonly");let a=o.store;return n&&(a=a.index(e.shift())),(await Promise.all([a[i](...e),s&&o.done]))[0]};return E.set(e,o),o}var P;P=D,D={...P,get:(t,e,i)=>O(t,e)||P.get(t,e,i),has:(t,e)=>!!O(t,e)||P.has(t,e)};const x="auth-client-db",A="ic-keyval";class C{constructor(t,e){this._db=t,this._storeName=e}static async create(t){const{dbName:e=x,storeName:i=A,version:n=1}=null!=t?t:{},s=await(async(t=x,e=A,i)=>(W&&(null===localStorage||void 0===localStorage?void 0:localStorage.getItem(N))&&(localStorage.removeItem(N),localStorage.removeItem(M)),await function(t,e,{blocked:i,upgrade:n,blocking:s,terminated:o}={}){const a=indexedDB.open(t,e),r=k(a);return n&&a.addEventListener("upgradeneeded",(t=>{n(k(a.result),t.oldVersion,t.newVersion,k(a.transaction),t)})),i&&a.addEventListener("blocked",(t=>i(t.oldVersion,t.newVersion,t))),r.then((t=>{o&&t.addEventListener("close",(()=>o())),s&&t.addEventListener("versionchange",(t=>s(t.oldVersion,t.newVersion,t)))})).catch((()=>{})),r}(t,i,{upgrade:t=>{t.objectStoreNames.contains(e)&&t.clear(e),t.createObjectStore(e)}})))(e,i,n);return new C(s,i)}async set(t,e){return await async function(t,e,i,n){return await t.put(e,n,i)}(this._db,this._storeName,t,e)}async get(t){var e;return null!==(e=await async function(t,e,i){return await t.get(e,i)}(this._db,this._storeName,t))&&void 0!==e?e:null}async remove(t){return await async function(t,e,i){return await t.delete(e,i)}(this._db,this._storeName,t)}}const M="identity",N="delegation",W="undefined"!=typeof window;class _{constructor(t="ic-",e){this.prefix=t,this._localStorage=e}get(t){return Promise.resolve(this._getLocalStorage().getItem(this.prefix+t))}set(t,e){return this._getLocalStorage().setItem(this.prefix+t,e),Promise.resolve()}remove(t){return this._getLocalStorage().removeItem(this.prefix+t),Promise.resolve()}_getLocalStorage(){if(this._localStorage)return this._localStorage;const t="undefined"==typeof window?void 0===s?"undefined"==typeof self?void 0:self.localStorage:s.localStorage:window.localStorage;if(!t)throw new Error("Could not find local storage.");return t}}class z{get _db(){return new Promise((t=>{this.initializedDb?t(this.initializedDb):C.create({version:1}).then((e=>{this.initializedDb=e,t(e)}))}))}async get(t){const e=await this._db;return await e.get(t)}async set(t,e){const i=await this._db;await i.set(t,e)}async remove(t){const e=await this._db;await e.remove(t)}}async function L(t){await t.remove(M),await t.remove(N),await t.remove("iv")}const U=(t,e)=>{const i=globalThis[e];return null!=i&&t instanceof i},$=t=>{if(null!=t){if(U(t,"ArrayBuffer")||U(t,"MessagePort")||U(t,"ImageBitmap")||U(t,"OffscreenCanvas"))return[t];if("object"==typeof t)return t.constructor===Object&&(t=Object.values(t)),Array.isArray(t)?t.flatMap($):$(t.buffer)}return[]};let K=0,R=0;const F=new Map,J=new Map,q=(t,e,i)=>{const n=new Worker(t,{name:e});return n.addEventListener("message",(({data:t})=>{if(t){const e=t[0],n=t[1],s=t[2];if(e===i){const e=t[3],[i,o,a]=F.get(n);if(F.delete(n),e){const t=e.isError?Object.assign(new Error(e.value.message),e.value):e.value;d(t),o(t)}else a&&a.forEach((t=>J.delete(t))),i(s)}else if(e===i+".cb")try{J.get(n)(...s)}catch(t){d(t)}}})),n},G=(t,e,i)=>(...n)=>new Promise(((s,o)=>{let a=K++,r=0,c=n.length,l=[s,o];for(F.set(a,l);r<c;r++)if("function"==typeof n[r]){const t=R++;J.set(t,n[r]),n[r]=[e+".cb",t],(l[2]=l[2]||[]).push(t)}const u=t=>t.postMessage([e,a,i,n],$(n));t.then?t.then(u):u(t)})),H=import("./p-2b88a50c.js").then((t=>t.worker)),Q=G(H,"stencil.idle.ic.worker","startIdleTime"),V=G(H,"stencil.idle.ic.worker","stopIdleTimer"),X=G(import("./p-ce90430d.js").then((t=>t.worker)),"stencil.user.ic.worker","initUserWorker");let Y;const Z=()=>class{constructor(t,e,i,n,s,o,a,r){var c;this._identity=t,this._key=e,this._chain=i,this._storage=n,this.idleManager=s,this._createOptions=o,this._idpWindow=a,this._eventHandler=r;const l=this.logout.bind(this),u=null==o?void 0:o.idleOptions;(null==u?void 0:u.onIdle)||(null==u?void 0:u.disableDefaultIdleCallback)||null===(c=this.idleManager)||void 0===c||c.registerCallback((()=>{l(),location.reload()}))}static async create(t={}){var e,i;const n=null!==(e=t.storage)&&void 0!==e?e:new z;let s=null;if(t.identity)s=t.identity;else{let t=await n.get(M);if(!t&&W)try{const e=new _,i=await e.get(N),s=await e.get(M);i&&s&&(console.log("Discovered an identity stored in localstorage. Migrating to IndexedDB"),await n.set(N,i),await n.set(M,s),t=i,await e.remove(N),await e.remove(M))}catch(t){console.error("error while attempting to recover localstorage: "+t)}if(t)try{s=a.fromJSON(t)}catch(t){}}let l=new o,u=null;if(s)try{const e=await n.get(N);t.identity?l=t.identity:e&&(u=r.fromJSON(e),w(u)?l=c.fromDelegation(s,u):(await L(n),s=null))}catch(t){console.error(t),await L(n),s=null}const d=(null===(i=t.idleOptions)||void 0===i?void 0:i.disableIdle)?void 0:class{constructor(t={}){var e;this.callbacks=[],this.idleTimeout=6e5,this.timeoutID=void 0;const{onIdle:i,idleTimeout:n=6e5}=t||{};this.callbacks=i?[i]:[],this.idleTimeout=n;const s=this._resetTimer.bind(this);if(window.addEventListener("load",s,!0),f.forEach((function(t){document.addEventListener(t,s,!0)})),null==t?void 0:t.captureScroll){const i=((t,e)=>{let i;return(...n)=>{const s=this;clearTimeout(i),i=window.setTimeout((function(){i=void 0,t.apply(s,n)}),e)}})(s,null!==(e=null==t?void 0:t.scrollDebounce)&&void 0!==e?e:100);window.addEventListener("scroll",i,!0)}s()}static create(t={}){return new this(t)}registerCallback(t){this.callbacks.push(t)}exit(){clearTimeout(this.timeoutID),window.removeEventListener("load",this._resetTimer,!0);const t=this._resetTimer.bind(this);f.forEach((function(e){document.removeEventListener(e,t,!0)})),this.callbacks.forEach((t=>t()))}_resetTimer(){const t=this.exit.bind(this);window.clearTimeout(this.timeoutID),this.timeoutID=window.setTimeout(t,this.idleTimeout)}}.create(t.idleOptions);return s||(s=a.generate(),await n.set(M,JSON.stringify(s))),new this(l,s,u,n,d,t)}_handleSuccess(t,e){var i;const n=t.delegations.map((t=>({delegation:new l(t.delegation.pubkey,t.delegation.expiration,t.delegation.targets),signature:t.signature.buffer}))),s=r.fromDelegations(n,t.userPublicKey.buffer),o=this._key;o&&(this._chain=s,this._identity=c.fromDelegation(o,this._chain),null===(i=this._idpWindow)||void 0===i||i.close(),null==e||e(),this._removeEventListener(),delete this._idpWindow)}getIdentity(){return this._identity}async isAuthenticated(){return!this.getIdentity().getPrincipal().isAnonymous()&&null!==this._chain}async login(t){var e,i,n,s;const o=BigInt(8)*BigInt(36e11),a=new URL((null===(e=null==t?void 0:t.identityProvider)||void 0===e?void 0:e.toString())||"https://identity.ic0.app");a.hash="#authorize",null===(i=this._idpWindow)||void 0===i||i.close(),this._removeEventListener(),this._eventHandler=this._getEventHandler(a,Object.assign({maxTimeToLive:null!==(n=null==t?void 0:t.maxTimeToLive)&&void 0!==n?n:o},t)),window.addEventListener("message",this._eventHandler),this._idpWindow=null!==(s=window.open(a.toString(),"idpWindow",null==t?void 0:t.windowOpenerFeatures))&&void 0!==s?s:void 0;const r=()=>{this._idpWindow&&(this._idpWindow.closed?this._handleFailure("UserInterrupt",null==t?void 0:t.onError):setTimeout(r,500))};r()}_getEventHandler(t,e){return async i=>{var n,s,o;if(i.origin!==t.origin)return void console.warn(`WARNING: expected origin '${t.origin}', got '${i.origin}' (ignoring)`);const a=i.data;switch(a.kind){case"authorize-ready":{const i={kind:"authorize-client",sessionPublicKey:new Uint8Array(null===(n=this._key)||void 0===n?void 0:n.getPublicKey().toDer()),maxTimeToLive:null==e?void 0:e.maxTimeToLive,derivationOrigin:null===(s=null==e?void 0:e.derivationOrigin)||void 0===s?void 0:s.toString()};null===(o=this._idpWindow)||void 0===o||o.postMessage(i,t.origin);break}case"authorize-client-success":try{this._handleSuccess(a,null==e?void 0:e.onSuccess),this._chain&&await this._storage.set(N,JSON.stringify(this._chain.toJSON()))}catch(t){this._handleFailure(t.message,null==e?void 0:e.onError)}break;case"authorize-client-failure":this._handleFailure(a.text,null==e?void 0:e.onError)}}}_handleFailure(t,e){var i;null===(i=this._idpWindow)||void 0===i||i.close(),null==e||e(t),this._removeEventListener(),delete this._idpWindow}_removeEventListener(){this._eventHandler&&window.removeEventListener("message",this._eventHandler),this._eventHandler=void 0}async logout(t={}){if(await L(this._storage),this._identity=new o,this._chain=null,t.returnTo)try{window.history.pushState({},"",t.returnTo)}catch(e){window.location.href=t.returnTo}}}.create({idleOptions:{disableIdle:!0,disableDefaultIdleCallback:!0}}),tt=async({config:e,success:i})=>{t.getInstance().set(e),Y=await Z(),await(null==Y?void 0:Y.isAuthenticated())&&(await et({success:i}),await X({env:t.getInstance().get()},(async t=>await it({user:t,success:i})),h),Q((()=>{const t=new CustomEvent("ddgSignOut",{bubbles:!0});document.dispatchEvent(t)})).then((()=>{})))},et=async({success:t})=>{await t({authUser:{state:"initialization"},user:void 0})},it=async({user:t,success:e})=>{const{id:i,data:n}=t,{name:s,email:o,photo_url:a}=n,r={uid:i,state:"authenticated",name:s,email:o,photo_url:a};await e({authUser:r,user:t})},nt=async()=>{await V(),await(null==Y?void 0:Y.logout()),Y=void 0,await u("/user")},st=async({onSuccess:i,onError:n})=>{Y=Y||await Z(),await Y.login(Object.assign({onSuccess:i,onError:n,maxTimeToLive:e},t.getInstance().localIdentity()&&{identityProvider:`http://${t.getInstance().get().localIdentityCanisterId}.localhost:8000?#authorize`}))},ot=async()=>{const t=at();if(!t)throw new Error("Invalid identity.");const e=await i({identity:t});await Promise.all([e.delData(),e.delStorage()])},at=()=>null==Y?void 0:Y.getIdentity(),rt=()=>null==Y?void 0:Y.isAuthenticated();export{z as I,w as a,tt as b,G as c,st as d,ot as e,q as f,at as g,rt as i,nt as s,h as t}