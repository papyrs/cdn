import{E as e,e as t,h as s}from"./p-e9d6f70b.js";import{A as a,d as i}from"./p-0df7b987.js";import{c as n}from"./p-ee0b2015.js";var o=e=>{let t=new CustomEvent("ddgLog",{detail:e,bubbles:!0});document.dispatchEvent(t)};const r=(e,t)=>{const s=globalThis[t];return null!=s&&e instanceof s},c=e=>{if(null!=e){if(r(e,"ArrayBuffer")||r(e,"MessagePort")||r(e,"ImageBitmap")||r(e,"OffscreenCanvas"))return[e];if("object"==typeof e)return e.constructor===Object&&(e=Object.values(e)),Array.isArray(e)?e.flatMap(c):c(e.buffer)}return[]};let l=0,u=0;const d=new Map,f=new Map,w=(e,t,s)=>{const a=new Worker(e,{name:t});return a.addEventListener("message",(({data:e})=>{if(e){const t=e[0],a=e[1],i=e[2];if(t===s){const t=e[3],[s,o,r]=d.get(a);if(d.delete(a),t){const e=t.isError?Object.assign(new Error(t.value.message),t.value):t.value;n(e),o(e)}else r&&r.forEach((e=>f.delete(e))),s(i)}else if(t===s+".cb")try{f.get(a)(...i)}catch(e){n(e)}}})),a},m=(e,t,s)=>(...a)=>new Promise(((i,n)=>{let o=l++,r=0,w=a.length,m=[i,n];for(d.set(o,m);r<w;r++)if("function"==typeof a[r]){const e=u++;f.set(e,a[r]),a[r]=[t+".cb",e],(m[2]=m[2]||[]).push(e)}const b=e=>e.postMessage([t,o,s,a],c(a));e.then?e.then(b):b(e)})),b=import("./p-7f36ecf5.js").then((e=>e.worker)),p=m(b,"stencil.idle.ic.worker","startIdleTime"),y=m(b,"stencil.idle.ic.worker","stopIdleTimer"),v=m(import("./p-b41735c3.js").then((e=>e.worker)),"stencil.user.ic.worker","initUserWorker");let h;const g=()=>a.create({idleOptions:{disableIdle:!0,disableDefaultIdleCallback:!0}}),j=async({config:t,success:s})=>{e.getInstance().set(t),h=await g(),await(null==h?void 0:h.isAuthenticated())&&(await E({success:s}),await v({env:e.getInstance().get()},(async e=>await O({user:e,success:s})),o),await p((()=>{const e=new CustomEvent("ddgSignOut",{bubbles:!0});document.dispatchEvent(e)})))},E=async({success:e})=>{await e({authUser:{state:"initialization"},user:void 0})},O=async({user:e,success:t})=>{const{id:s,data:a}=e,{name:i,email:n,photo_url:o}=a,r={uid:s,state:"authenticated",name:i,email:n,photo_url:o};await t({authUser:r,user:e})},k=async()=>{await y(),await(null==h?void 0:h.logout()),h=void 0,await i("/user")},I=async({onSuccess:s,onError:a})=>{h=h||await g(),await h.login(Object.assign({onSuccess:s,onError:a,maxTimeToLive:t},e.getInstance().localIdentity()&&{identityProvider:`http://${e.getInstance().get().localIdentityCanisterId}.localhost:8000?#authorize`}))},T=async()=>{const e=C();if(!e)throw new Error("Invalid identity.");const t=await s({identity:e});await Promise.all([t.delData(),t.delStorage()])},C=()=>null==h?void 0:h.getIdentity(),P=()=>null==h?void 0:h.isAuthenticated();export{j as a,I as b,m as c,T as d,w as e,C as g,P as i,k as s,o as t}