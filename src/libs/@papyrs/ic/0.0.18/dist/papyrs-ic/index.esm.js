import{g as t,a as e,b as a,t as o,f as r,c as i,d as c,e as d,h as u,E as p,i as f,I as h,j as w,k as b,D as y}from"./p-4bcbd6f2.js";export{n as deleteAuth,g as getIdentity,l as initAuth,j as isAuthenticated,m as signIn,s as signOut}from"./p-4bcbd6f2.js";import"./p-a8ab4139.js";var k=["id","hydrated","contenteditable","editable","spellcheck","highlighted","custom-loader","class","placeholder","data-gramm","data-gramm_id","data-gramm_editor","data-gr-id"],v=["paragraph_id","data-src",...k],$=({node:t,deep:e=!0,attributes:a=k})=>{if(_(t))return t;if(O(t)){let o=t.cloneNode(e);D({element:o,attributes:a});let n=o.querySelectorAll(a.map((t=>`[${t}]`)).join(","));for(let t of Array.from(n))D({element:t,attributes:a});return o}return null},D=({element:t,attributes:e})=>{for(let a of e)t.removeAttribute(a)},_=t=>t?.nodeType===Node.TEXT_NODE||t?.nodeType===Node.COMMENT_NODE,O=t=>t?.nodeType===Node.ELEMENT_NODE,U="app-deck-editor > ion-content div.deck > main > deckgo-deck",x="deckgo-studio-doc",C=[{id:"google-fonts-lora",name:"Lora",family:"'Lora', serif"},{id:"google-fonts-roboto",name:"Roboto",family:"'Roboto', sans-serif"},{id:"google-fonts-open-sans",name:"Open Sans",family:"'Open Sans', sans-serif"},{id:"google-fonts-montserrat",name:"Montserrat",family:"'Montserrat', sans-serif"},{id:"google-fonts-cabin",name:"Cabin",family:"'Cabin', sans-serif"},{id:"google-fonts-lato",name:"Lato",family:"'Lato', sans-serif"},{id:"google-fonts-muli",name:"Muli",family:"'Muli', sans-serif"},{id:"google-fonts-source-sans-pro",name:"Source Sans Pro",family:"'Source Sans Pro', sans-serif"},{id:"google-fonts-libre-baskerville",name:"Libre Baskerville",family:"'Libre Baskerville', serif"},{id:"google-fonts-oswald",name:"Oswald",family:"'Oswald', sans-serif"},{id:"google-fonts-jura",name:"Jura",family:"'Jura', sans-serif"},{id:"google-fonts-fjord-one",name:"Fjord One",family:"'Fjord One', serif"},{id:"google-fonts-josefin-slab",name:"Josefin Slab",family:"'Josefin Slab', serif"}],P=async({meta:t,fallbackName:e,fallbackAuthor:a,selector:o,socialImgPath:n})=>{let r=[I(),E({meta:t})].filter((t=>void 0!==t)),i=A({selector:o}),s=await T(),c=(t?.title||e)?.trim();return{title:c,description:(t?.description||e)?.trim(),author:t?.author?.name??a,bio:t?.author?.bio,photo_url:t?.author?.photo_url,head_extra:r.length>0?r.join(""):void 0,attributes:i,social_image_name:encodeURI(c).toLowerCase(),social_image_value:s,social_links:S({meta:t,socialImgPath:n}),social_image_link:void 0,lang:t?.lang??"en"}},I=()=>{let t=document.querySelector(U)?.style.fontFamily;if(!t)return;let e=C.find((e=>t===e.family.replace(/\'/g,"")));return e?`<link rel="stylesheet" href="${(({font:t})=>`https://fonts.googleapis.com/css?display=swap&amp;family=${t.name.replace(" ","+")}`)({font:e})}">`:void 0},E=({meta:t})=>{if(t&&t.canonical)return`<link rel="canonical" href="${t.canonical}">`},A=({selector:t})=>{let e=document.querySelector(t)?.attributes;if(e)return Array.from(e).filter((({name:t})=>!["id","hydrated","class","contenteditable"].includes(t))).reduce(((t,{name:e,value:a})=>(t[e]=a,t)),{})},F=()=>{let t=document.querySelectorAll(`${U} > *[slide_id]`),e=({slide:t,custom:e})=>{if(t.hasAttribute(`custom-${e}`))return;let a=t.querySelector(`div[slot="${e}"]`);!a||t.removeChild(a)};return Array.from(t).map((t=>{let a=$({node:t,deep:!1,attributes:v});return Array.from(t.childNodes).forEach((t=>{O(t)&&t.hasAttribute("slot")&&(a.appendChild($({node:t,attributes:v})),e({slide:a,custom:"background"}),e({slide:a,custom:"header"}),e({slide:a,custom:"footer"}))})),a})).map((t=>t.outerHTML))},N=()=>{let t=document.querySelectorAll(`${x} > article *[paragraph_id]`);return Array.from(t).map((t=>$({node:t,attributes:v}))).map((t=>t.outerHTML))},T=async()=>document.querySelector("deckgo-social-img")?.toBlob("image/png"),S=({meta:t,socialImgPath:e})=>{if(!t||!t.author)return;let{author:{social:a,name:o}}=t,n=({username:t,href:a,authorName:o,platformName:n,iconName:r})=>t&&""!==t?`<a href="https://${a}/${t}" aria-label="${o} on ${n}" rel="noopener norefferer"><deckgo-lazy-img svg-src="${e}/${r}.svg" role="presentation" alt="${n} logo" /></a>`:void 0,r=n({username:a?.twitter,href:"twitter.com",authorName:o,platformName:"Twitter",iconName:"twitter"}),i=n({username:a?.linkedin,href:"www.linkedin.com/in",authorName:o,platformName:"LinkedIn",iconName:"linkedin"}),s=n({username:a?.github,href:"github.com",authorName:o,platformName:"GitHub",iconName:"github"}),c=(({custom:t,authorName:a})=>t&&""!==t?`<a href="${t}" aria-label="${a}" rel="noopener norefferer"><deckgo-lazy-img svg-src="${e}/globe.svg" role="presentation" alt="" /></a>`:void 0)({custom:a?.custom,authorName:o});return void 0!==r||void 0!==i||void 0!==s||void 0!==c?`${[c,r,s,i].filter((t=>void 0!==t)).join("")}`:void 0},K=({selector:t})=>{let e=document.querySelector(`${t} > article *:nth-child(1)`),a=document.querySelector(`${t} > article *:nth-child(2)`),o=t=>{let e=t?.getAttribute("img-src");return 0===e?.indexOf("http")?e:void 0};if("deckgo-lazy-img"===e?.nodeName.toLowerCase())return o(e);if("deckgo-lazy-img"===a?.nodeName.toLowerCase())return o(a);let n=e?.querySelector("deckgo-lazy-img");return o(null!=n?n:a?.querySelector("deckgo-lazy-img"))},z=t=>{if(t&&void 0!==t)return t instanceof String||"string"==typeof t?new Date(`${t}`):"number"!=typeof t||isNaN(t)?t&&t.seconds>=0&&t.nanoseconds>=0?new Date(t.toDate()):t:new Date(t)};const L=async()=>{const o=t();if(!o)throw new Error("No internet identity to get the canisters status");const[n,r]=await Promise.all([e({identity:o}),a({identity:o})]),{actor:i,bucketId:s}=n,{actor:c,bucketId:l}=r,[d,u]=await Promise.all([i.cyclesBalance(),c.cyclesBalance()]);return{data:{bucketId:s,balance:d},storage:{bucketId:l,balance:u}}},G=async({startsWith:a,notContains:n})=>{const r=t();if(!r)return[];const{actor:i}=await e({identity:r});if(!i)return[];const s=(await i.list(o({startsWith:o(a),notContains:o(n)}))).map((([,t])=>B({data:t,identity:r})));return Promise.all(s)},B=async({data:t,identity:e})=>{const a=await r(t.data);return{id:t.id,data:Object.assign(Object.assign({},a),{owner_id:e.getPrincipal().toText()}),created_at:t.created_at,updated_at:t.updated_at}},M=async({key:t,actor:e})=>{const a=e||await R(),o=i(await a.get(t));if(!o)return;const n=await r(o.data);return{id:o.id,data:n,created_at:o.created_at,updated_at:o.updated_at}},R=async()=>{const a=t();if(!a)throw new Error("No internet identity.");const{actor:o}=await e({identity:a});if(!o)throw new Error("No actor initialized.");return o};function H(t){return new Promise((function(e,a){t.oncomplete=t.onsuccess=function(){return e(t.result)},t.onabort=t.onerror=function(){return a(t.error)}}))}var W;function q(){return W||(W=function(t,e){var a=indexedDB.open("keyval-store");a.onupgradeneeded=function(){return a.result.createObjectStore(e)};var o=H(a);return function(t,a){return o.then((function(o){return a(o.transaction(e,t).objectStore(e))}))}}(0,"keyval")),W}const J=async({key:t,idbData:e,actor:a,log:n})=>{null==n||n({msg:`[set][start] ${t}`,level:"info"});const r=performance.now(),i=await(async({key:t,idbData:e,actor:a})=>{const n=a||await R(),{id:r,data:i,created_at:s,updated_at:l}=e,d=await n.put(t,{id:r,data:await c(i),created_at:o(s),updated_at:o(l)});return{id:r,data:i,created_at:d.created_at,updated_at:d.updated_at}})({key:t,actor:a,idbData:e});await function(t,e){return(arguments.length>2&&void 0!==arguments[2]?arguments[2]:q())("readwrite",(function(a){return new Promise((function(o,n){a.get(t).onsuccess=function(){try{a.put(e(this.result),t),o(H(a.transaction))}catch(t){n(t)}}}))}))}(t,(({id:t,data:e})=>({id:t,data:e,created_at:i.created_at,updated_at:i.updated_at})));const s=performance.now();return null==n||n({msg:`[set][done] ${t}`,duration:s-r,level:"info"}),i},Q=async({key:t,actor:e,log:a,data:o})=>{if(!t)return;null==a||a({msg:`[delete][start] ${t}`,level:"info"});const n=performance.now();await(async({key:t,actor:e,data:a})=>{const o=e||await R();a?await o.delete(t,a):await o.del(t)})({key:t,actor:e,data:o}),void 0!==o&&await function(t){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:q())("readwrite",(function(e){return e.delete(t),H(e.transaction)}))}(t);const r=performance.now();null==a||a({msg:`[delete][done] ${t}`,duration:r-n,level:"info"})},V=async()=>G({startsWith:"/decks/",notContains:"/slides/"}),X=async(t,e)=>Q(Object.assign({key:`/decks/${t}`},void 0!==e&&{id:t,updated_at:e})),Y=async({onNext:t})=>{const e=["deckPublished","deckFeedSubmitted"];return e.forEach((e=>document.addEventListener(e,(async({detail:e})=>await t(e)),{passive:!0}))),()=>e.forEach((e=>document.removeEventListener(e,(({detail:e})=>t(e)),!1)))},Z=async()=>G({startsWith:"/docs/",notContains:"/paragraphs/"}),tt=async(t,e)=>Q(Object.assign({key:`/docs/${t}`},void 0!==e&&{id:t,updated_at:e})),et=async({onNext:t})=>{const e=["docPublished","docFeedSubmitted"];return e.forEach((e=>document.addEventListener(e,(async({detail:e})=>await t(e)),{passive:!0}))),()=>e.forEach((e=>document.removeEventListener(e,(async({detail:e})=>await t(e)),!1)))},at=(t,e)=>M({key:`/docs/${t}/paragraphs/${e}`}),ot=(t,e)=>M({key:`/decks/${t}/slides/${e}`});let nt=(t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce(((t,e)=>t+((e&=63)<36?e.toString(36):e<62?(e-26).toString(36).toUpperCase():e>62?"-":"_")),"");const rt=()=>G({startsWith:"/templates/"}),it=t=>{const e=nt(),a=new Date,o={id:e,data:Object.assign(Object.assign({},t),{updated_at:a,created_at:a})};return J({key:`/templates/${e}`,idbData:o})},st=t=>{const{id:e}=t;return J({key:`/templates/${e}`,idbData:t})},ct=async t=>{d({msg:"[update][start] user",level:"info"});const e=performance.now(),a=await J({key:"/user",idbData:t}),o=performance.now();return d({msg:"[update][done] user",duration:o-e,level:"info"}),a},lt=({IDL:t})=>{const e=t.Principal,a=t.Record({storageId:t.Opt(e)}),o=t.Int,n=t.Record({linkedin:t.Opt(t.Text),twitter:t.Opt(t.Text),custom:t.Opt(t.Text),github:t.Opt(t.Text)}),r=t.Record({bio:t.Opt(t.Text),photo_url:t.Opt(t.Text),social:t.Opt(n),name:t.Text}),i=t.Record({title:t.Text,tags:t.Opt(t.Vec(t.Text)),description:t.Opt(t.Text),author:t.Opt(r)}),s=t.Record({id:t.Text,updated_at:o,meta:i,pathname:t.Text,storageId:e,created_at:o}),c=t.Variant({open:t.Null,accepted:t.Null,declined:t.Null}),l=t.Record({status:t.Opt(c)}),d=t.Variant({open:t.Null,accepted:t.Null,declined:t.Null}),u=t.Record({id:t.Text,meta:i,pathname:t.Text,storageId:e}),m=t.Record({status:d,updated_at:o,created_at:o,proposal:u}),p=t.Record({id:t.Text,meta:i,pathname:t.Text,storageId:e});return t.Service({accept:t.Func([t.Principal,t.Text],[],[]),decline:t.Func([t.Principal,t.Text],[],[]),del:t.Func([t.Principal,t.Text],[],[]),list:t.Func([t.Opt(a)],[t.Vec(t.Tuple(t.Text,s))],["query"]),listProposals:t.Func([t.Opt(l)],[t.Vec(t.Tuple(t.Text,m))],["query"]),submit:t.Func([t.Text,p],[],[])})},dt=async({doc:t})=>{const{data:{meta:e},id:a}=t;if(!e)throw new Error("No meta data to submit to feed");await mt({meta:e,id:a});const o=await pt({key:"docs",idbData:t});return gt({data:o,type:"docFeedSubmitted"}),o},ut=async({deck:t})=>{const{data:{meta:e},id:a}=t;if(!e)throw new Error("No meta data to submit to feed");await mt({meta:e,id:a});const o=await pt({key:"decks",idbData:t});return gt({data:o,type:"deckFeedSubmitted"}),o},mt=async({meta:e,id:n})=>{const r=t();if(!r)throw new Error("No internet identity to submit entry to feed");const{bucketId:i}=await a({identity:r});if(!i)throw new Error("No storage found. Is the document published?");d({msg:"[submit][start] feed",level:"info"});const s=performance.now(),c=await(({identity:t})=>u({canisterId:p.getInstance().get().feedCanisterId,idlFactory:lt,identity:t}))({identity:r}),l=p.getInstance().get().feedSecret,{pathname:m,title:g,description:f,tags:h,author:w}=e;if(!m)throw new Error("No pathname found. Is the document published?");await c.submit(l,{id:n,storageId:i,pathname:e.pathname,meta:{title:g,description:o(f),tags:o(h),author:o(w?{name:w.name,bio:o(w.bio),photo_url:o(w.photo_url),social:o(w.social?{twitter:o(w.social.twitter),linkedin:o(w.social.linkedin),github:o(w.social.github),custom:o(w.social.custom)}:void 0)}:void 0)}});const b=performance.now();d({msg:"[submit][done] feed",duration:b-s,level:"info"})},pt=async({key:t,idbData:e})=>{d({msg:`[update][start] ${t}`,level:"info"});const a=performance.now(),{data:o,id:n,created_at:r,updated_at:i}=e,s={id:n,data:Object.assign(Object.assign({},o),{meta:Object.assign(Object.assign({},o.meta),{feed:!0}),updated_at:new Date}),created_at:r,updated_at:i},c=await J({key:`/docs/${n}`,idbData:s}),l=performance.now();return d({msg:`[update][done] ${t}`,duration:l-a,level:"info"}),c},gt=({data:t,type:e})=>{const a=new CustomEvent(e,{detail:t});document.dispatchEvent(a)},ft=async({data:t,filename:e,folder:a,storageActor:n,headers:r,token:i,fullPath:s,log:c})=>{c({msg:`[upload][start] ${e}`,level:"info"});const l=performance.now(),d=s||`/${a}/${e}`,{batchId:u}=await n.initUpload({name:e,fullPath:d,token:o(i),folder:a}),m=performance.now();c({msg:`[upload][create batch] ${e}`,duration:m-l,level:"info"});const p=[],g=7e5,f=new Blob([await t.arrayBuffer()]);for(let t=0;t<f.size;t+=g){const e=f.slice(t,t+g);p.push(ht({batchId:u,chunk:e,storageActor:n}))}const h=await Promise.all(p),w=performance.now();c({msg:`[upload][chunks] ${e}`,duration:w-m,level:"info"}),await n.commitUpload({batchId:u,chunkIds:h.map((({chunkId:t})=>t)),headers:[["Content-Type",t.type],["accept-ranges","bytes"],...r]});const b=performance.now();return c({msg:`[upload][commit batch] ${e}`,duration:b-w,level:"info"}),c({msg:`[upload][done] ${e}`,duration:b-l,level:"info"}),{fullPath:d,filename:e,token:i}},ht=async({batchId:t,chunk:e,storageActor:a})=>a.uploadChunk({batchId:t,content:[...new Uint8Array(await e.arrayBuffer())]}),wt=t=>encodeURI(t.toLowerCase().replace(/\s/g,"-")),bt=async()=>{const e=t();if(!e)throw new Error("No internet identity.");const o=await a({identity:e}),{actor:n,bucketId:r}=o;if(!n)throw new Error("No actor initialized.");if(!r)throw new Error("No bucket principal defined");return o},yt=({social_image_link:t})=>void 0!==t,kt=async({storageUpload:t,publishData:e})=>{const{social_image_name:a,social_image_value:o}=e;if(yt(e))return;if(!o)return;const{actor:n}=t;await ft({data:o,filename:`${a}.png`,folder:"meta",storageActor:n,headers:[["Cache-Control","max-age=3600"]],log:d})},vt=({template:t,data:e})=>Object.entries(e).reduce(((t,[e,a])=>t.replaceAll(`{{DECKDECKGO_${e.toUpperCase()}}}`,a||"").replaceAll(`\x3c!-- DECKDECKGO_${e.toUpperCase()} --\x3e`,a||"")),t),$t=async({indexHTML:t,folder:e,meta:a})=>{const{html:o,publishData:n}=t,{bucketId:r,actor:i}=await bt(),{filename:s,pathname:c}=Dt({publishData:n,meta:a,folder:e}),l=`https://${r.toText()}.raw.ic0.app`,d=`${l}${c}`;let u=o.replace("{{DECKDECKGO_URL}}",d);return u=(({html:t,data:e,bucketUrl:a})=>{const{social_image_name:o}=e;if(yt(e)){const{social_image_link:a}=e;return t.replaceAll("{{DECKDECKGO_SOCIAL_IMAGE}}",a)}return t.replaceAll("{{DECKDECKGO_SOCIAL_IMAGE}}",`${a}/meta/${o}.png`)})({html:u,data:n,bucketUrl:l}),{storageUpload:{html:u,actor:i,filename:s,pathname:c,fullUrl:d,bucketUrl:l,folder:e},publishData:n}},Dt=({publishData:t,meta:e,folder:a})=>{if(null==e?void 0:e.pathname){const{pathname:t}=e;return{filename:t.replace(`/${a}/`,""),pathname:t}}const o=wt(t.title);return{filename:o,pathname:`/${a}/${o}`}},_t=async({publishData:t,updateTemplateContent:e,sourceFolder:a})=>{const o=await Ot(a),n=vt({template:o,data:t}),{attributes:r}=t;return{html:e({attr:r?Object.entries(r).reduce(((t,[e,a])=>`${e}="${a}"; ${t}`),"").trim():void 0,template:n})}},Ot=async t=>(await fetch(`${p.getInstance().get().kitPath}/${t}/index.html`)).text(),jt=({data:t,storageUpload:e,meta:a,name:o})=>{var n;const{pathname:r}=e,i=new Date;return Object.assign(Object.assign({},t),{meta:Object.assign(Object.assign({},a||{title:o}),{pathname:r,published:!0,published_at:null!==(n=a.published_at)&&void 0!==n?n:i,updated_at:i})})},Ut=async({filename:t,html:e,actor:a,folder:o})=>{await ft({data:new Blob([e],{type:"text/html"}),filename:t,folder:o,storageActor:a,headers:[["Cache-Control","max-age=3600"]],log:d})},xt=()=>p.getInstance().get().author;const Ct=({content:t,bucketUrl:e,metas:a,selector:o})=>{const n=a.map((({dataId:t,meta:a})=>Pt({dataId:t,meta:a,bucketUrl:e})));return t.replace(o,n.join(""))},Pt=({dataId:t,bucketUrl:e,meta:a})=>{var o,n;const{title:r,pathname:i}=a,s=`${e}${i}`,c=null!=(null==a?void 0:a.description)&&""!==(null==a?void 0:a.description)?`<p class="description">${a.description}</p>`:"",{format:l}=new Intl.DateTimeFormat("en",{year:"numeric",month:"short",day:"2-digit",hour:"numeric",minute:"numeric",second:"numeric"});return`<a data-id="${t}" href="${s}" rel="noopener noreferrer"><article><div><h3>${r}</h3>${c}</div><div><p>Published: ${l(null!==(o=z(null==a?void 0:a.published_at))&&void 0!==o?o:new Date)}</p><p>Edited: ${l(null!==(n=z(null==a?void 0:a.updated_at))&&void 0!==n?n:new Date)}</p></div></article></a>`},It=t=>`<url>\n  <loc>${t}</loc>\n  <changefreq>daily</changefreq>\n  <priority>0.7</priority>\n</url>`,Et=t=>t.filter((({data:t})=>{var e;return!0===(null===(e=t.meta)||void 0===e?void 0:e.published)})).sort((({data:{meta:{published_at:t}}},{data:{meta:{published_at:e}}})=>{var a,o;return((null===(a=z(e))||void 0===a?void 0:a.getTime())||0)-((null===(o=z(t))||void 0===o?void 0:o.getTime())||0)})).map((({id:t,data:{meta:e}})=>({dataId:t,meta:e}))),At=async({storageUpload:t,publishData:e,entries:a})=>{const o=Et(a),n=[Tt({storageUpload:t,publishData:e,metas:o}),Nt({storageUpload:t,metas:o}),Ft({storageUpload:t,metas:o,publishData:e})];await Promise.all(n)},Ft=async({storageUpload:t,metas:e,publishData:a})=>{const{bucketUrl:o,actor:n}=t,{author:r}=a,i=(({bucketUrl:t,metas:e,author:a})=>(({items:t,author:e,bucketUrl:a})=>`<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" version="2.0">\n    <channel>\n        <title><![CDATA[${e} blog]]></title>\n        <description><![CDATA[The latest blog posts of ${e}]]></description>\n        <link>${a}</link>\n        <lastBuildDate>${(new Date).toUTCString()}</lastBuildDate>\n        \n        ${t}\n    </channel>\n</rss>`)({bucketUrl:t,items:(({metas:t,bucketUrl:e})=>t.map((({meta:{title:t,description:a,pathname:o,published_at:n}})=>{var r;return`\n  <item>\n    <title><![CDATA[${t}]]></title>\n    <description><![CDATA[${null!=a?a:t}]]></description>\n    <link>${e}${o}</link>\n    <pubDate>${(null!==(r=z(n))&&void 0!==r?r:new Date).toUTCString()}</pubDate>\n  </item>\n`})))({metas:e,bucketUrl:t}).join(""),author:a}))({bucketUrl:o,metas:e,author:r||xt()});await zt({rss:i,actor:n})},Nt=async({storageUpload:t,metas:e})=>{const{bucketUrl:a,actor:o}=t,n=(({bucketUrl:t,metas:e})=>`<?xml version="1.0" encoding="UTF-8" ?>\n  <urlset\n    xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"\n    xmlns:news="http://www.google.com/schemas/sitemap-news/0.9"\n    xmlns:xhtml="http://www.w3.org/1999/xhtml"\n    xmlns:image="http://www.google.com/schemas/sitemap-image/1.1"\n    xmlns:video="http://www.google.com/schemas/sitemap-video/1.1"\n  >\n    ${[It(t),...e.map((({meta:{pathname:e}})=>It(`${t}${e}`)))].join("")}\n</urlset>`)({bucketUrl:a,metas:e});await Kt({sitemap:n,actor:o})},Tt=async({storageUpload:t,publishData:e,metas:a})=>{const{bucketUrl:o,actor:n}=t,r=await(async({bucketUrl:t,publishData:e,metas:a})=>{const o=await(async()=>(await fetch(`${p.getInstance().get().kitPath}/index.html`)).text())(),{photo_url:n}=e,r=function(t,e){var a={};for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.indexOf(o)<0&&(a[o]=t[o]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(t);n<o.length;n++)e.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(t,o[n])&&(a[o[n]]=t[o[n]])}return a}(e,["photo_url"]);let i=vt({template:o,data:r});return i=(({photo_url:t,html:e})=>t?e.replace("\x3c!-- DECKDECKGO_PHOTO_URL --\x3e",`<img role="presentation" alt="" loading="lazy" src="${t}" />`):e)({html:i,photo_url:n}),i=Ct({content:i,bucketUrl:t,metas:a,selector:/<!-- DECKDECKGO_DATA -->/}),i})({bucketUrl:o,publishData:e,metas:a});await St({html:r,actor:n})},St=async({html:t,actor:e})=>Lt({actor:e,content:t,mimeType:"text/html",fullPath:"/",filename:"index.html"}),Kt=async({sitemap:t,actor:e})=>Lt({actor:e,content:t,mimeType:"application/xml",fullPath:"/sitemap.xml",filename:"sitemap.xml",maxAge:3600}),zt=async({rss:t,actor:e})=>Lt({actor:e,content:t,mimeType:"application/xml",fullPath:"/rss.xml",filename:"rss.xml",maxAge:3600}),Lt=async({content:t,actor:e,mimeType:a,filename:o,fullPath:n,maxAge:r=0})=>{await ft({data:new Blob([t],{type:a}),filename:o,folder:"resources",storageActor:e,headers:[["Cache-Control",`max-age=${r}`]],fullPath:n,log:d})},Gt=async({bucketUrl:t,identity:e})=>{const a=await Z(e.getPrincipal().toText()),o=Et(a),n=await(async({metas:t,bucketUrl:e})=>{const a=await(async t=>{const e=await fetch(t);if(e.ok)return e.text()})(e);if(!a)return;const o=[...a.matchAll(/<section id="posts"[\s\S]*?>([\s\S]*?)<\/section>/gm)];return o.length<1&&o[0].length<2?void 0:Ct({content:a,metas:t,bucketUrl:e,selector:o[0][1]})})({bucketUrl:t,metas:o});if(!n)return;const{actor:r}=await bt();await St({html:n,actor:r})},Bt=()=>p.getInstance().get().kitPath,Mt=async({meta:t})=>{const{actor:e}=await bt(),a=(await e.list(o("resources"))).map((({name:t})=>t)),n=await Jt(),r=n.filter((({filename:t,mimeType:e})=>!a.includes(t)||["text/css","text/javascript"].includes(e)));if(!r||r.length<=0)return;const i=r.map((a=>Rt({kit:a,actor:e,meta:t})));await Promise.all(i),await Ht({kitNewFiles:r,kit:n,actor:e,meta:t})},Rt=async({kit:t,actor:e,meta:a})=>{const{src:o,filename:n,mimeType:r,updateContent:i,headers:s}=t,c=await qt(o),l=i?i({content:c,meta:a}):c;await Wt({filename:n,content:l,actor:e,mimeType:r,headers:s,fullPath:o.replace(Bt(),"")})},Ht=async({kitNewFiles:t,kit:e,actor:a,meta:o})=>{if(void 0!==t.find((({filename:t})=>"service-worker.js"===t)))return;const n=e.find((({filename:t})=>"service-worker.js"===t));void 0===!n&&await Rt({kit:n,actor:a,meta:o})},Wt=async({filename:t,fullPath:e,content:a,actor:o,mimeType:n,headers:r})=>{await ft({data:new Blob([a],{type:n}),filename:t,folder:"resources",storageActor:o,fullPath:e,headers:r,log:d})},qt=async t=>(await fetch(t)).text(),Jt=async()=>{const t=Bt();return(await(await fetch(`${t}/build.json`)).json()).map((e=>(e=>{const a=`${t}/${e}`;return a.includes(".js")?{src:a,mimeType:"text/javascript"}:a.includes(".css")?{src:a,mimeType:"text/css"}:a.includes(".webmanifest")?{src:a,mimeType:"application/manifest+json",updateContent:({content:t,meta:e})=>{var a;return t.replace("{{DECKDECKGO_AUTHOR}}",(null===(a=null==e?void 0:e.author)||void 0===a?void 0:a.name)||xt())}}:{src:a,mimeType:"text/plain"}})(e))).map((t=>{const{pathname:e}=new URL(t.src);return Object.assign(Object.assign({},t),{filename:e.split("/").pop(),headers:[["Cache-Control","max-age=31536000"]]})}))},Qt=async({deck:t})=>{await Mt({meta:t.data.meta});const{storageUpload:e,publishData:a,deck:o}=await(async({deck:t})=>{const{id:e,data:a}=t,{meta:o}=a,n=await(async({deck:t})=>{const e=await(async({deck:t,fallbackAuthor:e})=>{let{data:a}=t,{meta:o,background:n,footer:r,header:i}=a??{};return{...await P({meta:o,selector:U,fallbackName:a?.name??"",fallbackAuthor:e}),slides:F(),background:n?`<div slot="background">${n}</div>`:void 0,header:n?`<div slot="header">${i}</div>`:void 0,footer:n?`<div slot="footer">${r}</div>`:void 0}})({deck:t,fallbackAuthor:p.getInstance().get().author}),{slides:a}=e,{html:o}=await _t({publishData:e,updateTemplateContent:({attr:t,template:e})=>e.replace("\x3c!-- DECKDECKGO_DECK --\x3e",`<deckgo-deck id="slider" embedded="true" ${t||""}>${a.join("")}</deckgo-deck>`),sourceFolder:"p"});return{html:o,publishData:e}})({deck:t}),{storageUpload:r,publishData:i}=await $t({indexHTML:n,folder:"p",meta:o}),s=jt({data:a,meta:a.meta,name:a.name,storageUpload:r}),c=await J({key:`/decks/${e}`,idbData:Object.assign(Object.assign({},t),{data:s})});return await Ut(r),await kt({storageUpload:r,publishData:i}),{storageUpload:r,publishData:i,deck:c}})({deck:t});return await(async({storageUpload:t,publishData:e})=>{d({msg:"[list][start] decks",level:"info"});const a=await V();d({msg:"[list][start] end",level:"info"}),await At({storageUpload:t,publishData:e,entries:a})})({storageUpload:e,publishData:a,owner_id:t.data.owner_id}),(t=>{const{id:e,data:a}=t,o={id:e,data:Object.assign(Object.assign({},a),{deploy:{api:{status:"successful",updated_at:new Date}}})},n=new CustomEvent("deckPublished",{detail:o});document.dispatchEvent(n)})(o),o},Vt=async({doc:t,config:e})=>{await Mt({meta:t.data.meta});const{storageUpload:a,publishData:o,doc:n}=await(async({doc:t,config:e})=>{const{id:a,data:o}=t,{meta:n}=o,r=await(async({doc:t,config:e})=>{const{theme:a,socialImgPath:o}=e,n=await(async({doc:t,fallbackAuthor:e,theme:a,socialImgPath:o})=>{let{data:n}=t,{meta:r}=n??{};return{...await P({meta:r,selector:x,fallbackName:n?.name??"",fallbackAuthor:e,socialImgPath:o}),paragraphs:N(),theme:a,social_image_link:K({selector:x})}})({doc:t,fallbackAuthor:p.getInstance().get().author,theme:a,socialImgPath:o}),{paragraphs:r}=n,{html:i}=await _t({publishData:n,updateTemplateContent:({attr:t,template:e})=>e.replace("\x3c!-- DECKDECKGO_DOC --\x3e",`<article ${t||""} class="deckgo-doc">${r.join("")}</article>`),sourceFolder:"d"});return{html:i,publishData:n}})({doc:t,config:e}),{storageUpload:i,publishData:s}=await $t({indexHTML:r,folder:"d",meta:n}),c=jt({data:o,meta:o.meta,name:o.name,storageUpload:i}),l=await J({key:`/docs/${a}`,idbData:Object.assign(Object.assign({},t),{data:c})});return await Ut(i),await kt({storageUpload:i,publishData:s}),{storageUpload:i,publishData:s,doc:l}})({doc:t,config:e});return await(async({storageUpload:t,publishData:e})=>{d({msg:"[list][start] docs",level:"info"});const a=await Z();d({msg:"[list][end] docs",level:"info"}),await At({storageUpload:t,publishData:e,entries:a})})({storageUpload:a,publishData:o,owner_id:t.data.owner_id}),(t=>{const{id:e,data:a}=t,o={id:e,data:Object.assign(Object.assign({},a),{deploy:{api:{status:"successful",updated_at:new Date}}})},n=new CustomEvent("docPublished",{detail:o});document.dispatchEvent(n)})(n),n},Xt=async()=>{const{bucketId:t}=await bt();return p.getInstance().localIdentity()?`http://${t.toText()}.localhost:8000`:`https://${t.toText()}.raw.ic0.app`},Yt=async()=>{const e=t();if(!e)throw new Error("No internet identity provided to list the entries that should be listed on the landing page");const a=await Xt();await Gt({bucketUrl:a,identity:e})},Zt=async({data:e,folder:a,maxSize:o})=>{const n=t();return te({data:e,folder:a,maxSize:o,identity:n,log:d})},te=async({data:t,maxSize:e,folder:o,identity:n,storageBucket:r,log:i})=>{if(!t||!t.name)throw new Error("File not valid.");if(t.size>e)throw new Error(`File is too big (max. ${e/1048576} Mb)`);const{actor:s,bucketId:c}=r||await a({identity:n});if(!s||!c)throw new Error("Storage bucket is not initialized.");const{fullPath:l,filename:d,token:u}=await ft({data:t,filename:wt(t.name),folder:o,storageActor:s,token:nt(),headers:[["cache-control","private, max-age=0"]],log:i});return{downloadUrl:`https://${c.toText()}.raw.ic0.app${l}?token=${u}`,fullPath:l,name:d}},ee=async({folder:t})=>{const{actor:e,bucketId:a}=await bt(),n=await e.list(o(t)),r=`https://${a.toText()}.raw.ic0.app`;return{items:n.map((({name:t,fullPath:e,token:a})=>({downloadUrl:`${r}${e}?token=${a}`,fullPath:e,name:t}))),nextPageToken:null}},ae=async({downloadUrl:t,fullPath:e})=>{const{actor:a}=await bt();let n=null;if(t){const{searchParams:e}=new URL(t);n=e.get("token")}return a.del({fullPath:e,token:o(n||void 0)})},oe=({data:t,storageFile:e,src:a})=>{const{downloadUrl:o,name:n}=e;let r=t.replaceAll(`img-src="${a}"`,`img-src="${o}"`);return r=r.replaceAll(`img-alt="${a}"`,`img-alt="${n}"`),r=r.replaceAll(`data-src="${a}"`,`data-src="${o}"`),r},ne=async({selector:t,storageFile:e,folder:a,src:o})=>{const n=document.querySelector(t);if("deckgo-lazy-img"===(null==n?void 0:n.nodeName.toLowerCase()))return void await re({images:[n],storageFile:e,folder:a,src:o});const r=null==n?void 0:n.querySelectorAll("deckgo-lazy-img");await re({images:Array.from(r),storageFile:e,folder:a,src:o})},re=async({storageFile:t,folder:e="images",images:a,src:o})=>{const n=a.filter((t=>"data"===e?t.getAttribute("data-src")===o:t.imgSrc===o));if(!n||n.length<=0)return;const r=Array.from(n).map((a=>"data"===e?(async e=>{const{downloadUrl:a}=t;e.setAttribute("data-src",a)})(a):(async e=>{const{downloadUrl:a,name:o}=t;e.imgSrc=a,e.imgAlt=o})(a)));await Promise.all(r)},ie=async({storageFile:t,src:e,key:a})=>{const o=(({paragraph:t,files:e})=>{if(!e)return Object.assign({},t);const a=e.filter((({src:t,storageFile:e})=>void 0!==t&&void 0!==e));let{children:o,nodeName:n,attributes:r}=t.data;return"deckgo-lazy-img"===n&&r&&a.forEach((({src:t,storageFile:e})=>{r=(({attributes:t,storageFile:e,src:a})=>{const{downloadUrl:o}=e;return Object.keys(t).reduce(((e,n)=>(e[n]=t[n]===a?o:t[n],e)),{})})({attributes:r,storageFile:e,src:t})})),o=null==o?void 0:o.map((t=>(a.forEach((({src:e,storageFile:a})=>{t=oe({data:t,storageFile:a,src:e})})),t))),Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,children:o,attributes:r})})})({paragraph:await se({key:a}),files:[{src:e,storageFile:t}]});await ce({key:a,data:o})},se=async({key:t})=>{const e=await function(t){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:q())("readonly",(function(e){return H(e.get(t))}))}(t);if(!e)throw new Error("Data not found and that is really weird here.");return e},ce=async({key:t,data:e})=>function(t,e){return(arguments.length>2&&void 0!==arguments[2]?arguments[2]:q())("readwrite",(function(a){return a.put(e,t),H(a.transaction)}))}(t,e),le=f(import("./p-5ca47e51.js").then((t=>t.worker)),"stencil.sync.ic.worker","uploadWorker"),de=async({msg:t,data:e})=>{"deckdeckgo_sync_deck_background"===t&&await(async t=>{(({storageFile:t})=>{const e=document.querySelector(`${U} > *[slot="background"]`),a=null==e?void 0:e.querySelector("deckgo-lazy-img");if(!a)return;const{downloadUrl:o,name:n}=t;a.imgSrc=o,a.imgAlt=n})(t),await(async({storageFile:t,src:e})=>{const a=document.querySelectorAll(`${U} .deckgo-slide-container:not([custom-background]) *[slot="background"] deckgo-lazy-img`);await re({images:Array.from(a),storageFile:t,src:e})})(t),await(async({storageFile:t,src:e,key:a})=>{const o=(({deck:t,storageFile:e,imgSrc:a})=>e&&a?Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,background:oe({data:t.data.background,src:a,storageFile:e})})}):Object.assign({},t))({deck:await se({key:a}),imgSrc:e,storageFile:t});await ce({key:a,data:o})})(t)})(e),"deckdeckgo_sync_slide_image"===t&&await(async t=>{const{selector:e}=t;e&&(await ne(t),await(async({storageFile:t,src:e,key:a})=>{const o=(({slide:t,images:e})=>{if(!e)return Object.assign({},t);const a=e.filter((({src:t,storageFile:e})=>void 0!==t&&void 0!==e));let{content:o}=t.data;return a.forEach((({src:t,storageFile:e})=>{o=oe({data:o,storageFile:e,src:t})})),Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,content:o})})})({slide:await se({key:a}),images:[{src:e,storageFile:t}]});await ce({key:a,data:o})})(t))})(e),"deckdeckgo_sync_slide_chart"===t&&await(async t=>{const{selector:e}=t;e&&((({selector:t,storageFile:e})=>{const a=document.querySelector(t);if(!a||!a.nodeName||"deckgo-slide-chart"!==a.nodeName.toLowerCase())return;const{downloadUrl:o}=e;a.src=o})(t),await(async({storageFile:t,src:e,key:a})=>{const o=(({slide:t,chart:e})=>{if(!e)return Object.assign({},t);const{src:a,storageFile:o}=e;if(!a||!o)return Object.assign({},t);const{attributes:n}=t.data;if(!n)return Object.assign({},t);const{downloadUrl:r}=o;return Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,attributes:Object.assign(Object.assign({},n),{src:r})})})})({slide:await se({key:a}),chart:{src:e,storageFile:t}});await ce({key:a,data:o})})(t))})(e),"deckdeckgo_sync_paragraph_image"===t&&await(async t=>{const{selector:e}=t;e&&(await ne(t),await ie(t))})(e)},ue=async({syncData:e,clean:a})=>{const o=t(),[n,r]=await(async()=>{const t=new h;return Promise.all([t.get("delegation"),t.get("identity")])})();if(!o||!r)throw d({msg:"[identity] no internet identity to sync data. Please login again.",level:"error"}),new Error("No internet identity to sync data. Please login again.");if(!0!==await w())throw d({msg:"[identity] internet identity has expired. Please login again.",level:"error"}),new Error("Internet identity has expired. Please login again.");if(!b(y.fromJSON(n)))throw d({msg:"[identity] delegation has expired. Please login again.",level:"error"}),new Error("Delegation has expired. Please login again.");await le({syncData:e,env:p.getInstance().get()},de,d),await a(e)};export{L as canistersBalance,it as createTemplate,V as deckEntries,Qt as deckPublish,ut as deckSubmitFeed,X as deleteDeck,tt as deleteDoc,ae as deleteFile,Z as docEntries,Vt as docPublish,dt as docSubmitFeed,ee as getFiles,at as getParagraph,ot as getSlide,rt as getUserTemplates,Xt as publishUrl,Y as snapshotDeck,et as snapshotDoc,ue as sync,Yt as updateLanding,st as updateTemplate,ct as updateUser,Zt as uploadFile,te as uploadFileIC}