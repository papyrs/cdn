import{P as t}from"./p-5c5f3838.js";import{g as a,a as n,c as r,f as o,t as c,b as l,d as u,e as m,E as p,i as h}from"./p-463b3fac.js";import{g as w,t as y,K as f,a as k,c as _,i as v}from"./p-1155b644.js";export{e as deleteAuth,g as getIdentity,b as initAuth,i as isAuthenticated,d as signIn,s as signOut}from"./p-1155b644.js";import{u as $,g as D,s as O,c as j,a as I,i as U,D as C}from"./p-46a3a60f.js";import"./p-82ae0ef6.js";var E=["id","hydrated","contenteditable","editable","spellcheck","highlighted","custom-loader","class","placeholder","data-gramm","data-gramm_id","data-gramm_editor","data-gr-id","data-selectable-paragraph"],x=["paragraph_id","data-src",...E],A=({node:t,deep:e=!0,attributes:a=E})=>{if(N(t))return t;if(T(t)){let i=t.cloneNode(e);P({element:i,attributes:a});let n=i.querySelectorAll(a.map((t=>`[${t}]`)).join(","));for(let t of Array.from(n))P({element:t,attributes:a});return i}return null},P=({element:t,attributes:e})=>{for(let a of e)t.removeAttribute(a)},N=t=>t?.nodeType===Node.TEXT_NODE||t?.nodeType===Node.COMMENT_NODE,T=t=>t?.nodeType===Node.ELEMENT_NODE,F="app-deck-editor > ion-content div.deck > main > deckgo-deck",K="deckgo-studio-doc",S=[{id:"google-fonts-lora",name:"Lora",family:"'Lora', serif"},{id:"google-fonts-roboto",name:"Roboto",family:"'Roboto', sans-serif"},{id:"google-fonts-open-sans",name:"Open Sans",family:"'Open Sans', sans-serif"},{id:"google-fonts-montserrat",name:"Montserrat",family:"'Montserrat', sans-serif"},{id:"google-fonts-cabin",name:"Cabin",family:"'Cabin', sans-serif"},{id:"google-fonts-lato",name:"Lato",family:"'Lato', sans-serif"},{id:"google-fonts-muli",name:"Muli",family:"'Muli', sans-serif"},{id:"google-fonts-source-sans-pro",name:"Source Sans Pro",family:"'Source Sans Pro', sans-serif"},{id:"google-fonts-libre-baskerville",name:"Libre Baskerville",family:"'Libre Baskerville', serif"},{id:"google-fonts-oswald",name:"Oswald",family:"'Oswald', sans-serif"},{id:"google-fonts-jura",name:"Jura",family:"'Jura', sans-serif"},{id:"google-fonts-fjord-one",name:"Fjord One",family:"'Fjord One', serif"},{id:"google-fonts-josefin-slab",name:"Josefin Slab",family:"'Josefin Slab', serif"}],L=async({meta:t,fallbackName:e,fallbackAuthor:a,selector:i,socialImgPath:n})=>{let r=[G(),z({meta:t})].filter((t=>void 0!==t)),o=R({selector:i}),s=await H(),c=(t?.title||e)?.trim();return{title:c,description:(t?.description||e)?.trim(),author:t?.author?.name??a,bio:t?.author?.bio,photo_url:t?.author?.photo_url,head_extra:r.length>0?r.join(""):void 0,attributes:o,social_image_name:encodeURI(c).toLowerCase(),social_image_value:s,social_links:W({meta:t,socialImgPath:n}),social_image_link:void 0,lang:t?.lang??"en"}},G=()=>{let t=document.querySelector(F)?.style.fontFamily;if(!t)return;let e=S.find((e=>t===e.family.replace(/\'/g,"")));return e?`<link rel="stylesheet" href="${(({font:t})=>`https://fonts.googleapis.com/css?display=swap&amp;family=${t.name.replace(" ","+")}`)({font:e})}">`:void 0},z=({meta:t})=>{if(t&&t.canonical)return`<link rel="canonical" href="${t.canonical}">`},R=({selector:t})=>{let e=document.querySelector(t)?.attributes;if(e)return Array.from(e).filter((({name:t})=>!["id","hydrated","class","contenteditable"].includes(t))).reduce(((t,{name:e,value:a})=>(t[e]=a,t)),{})},M=()=>{let t=document.querySelectorAll(`${F} > *[slide_id]`),e=({slide:t,custom:e})=>{if(t.hasAttribute(`custom-${e}`))return;let a=t.querySelector(`div[slot="${e}"]`);!a||t.removeChild(a)};return Array.from(t).map((t=>{let a=A({node:t,deep:!1,attributes:x});return Array.from(t.childNodes).forEach((t=>{T(t)&&t.hasAttribute("slot")&&(a.appendChild(A({node:t,attributes:x})),e({slide:a,custom:"background"}),e({slide:a,custom:"header"}),e({slide:a,custom:"footer"}))})),a})).map((t=>t.outerHTML))},B=()=>{let t=document.querySelectorAll(`${K} > article *[paragraph_id]`);return Array.from(t).map((t=>A({node:t,attributes:x}))).map((t=>t.outerHTML))},H=async()=>document.querySelector("deckgo-social-img")?.toBlob("image/png"),W=({meta:t,socialImgPath:e})=>{if(!t||!t.author)return;let{author:{social:a,name:i}}=t,n=({username:t,href:a,authorName:i,platformName:n,iconName:r})=>t&&""!==t?`<a href="https://${a}/${t}" aria-label="${i} on ${n}" rel="noopener norefferer"><deckgo-lazy-img svg-src="${e}/${r}.svg" role="presentation" alt="${n} logo" /></a>`:void 0,r=n({username:a?.twitter,href:"twitter.com",authorName:i,platformName:"Twitter",iconName:"twitter"}),o=n({username:a?.linkedin,href:"www.linkedin.com/in",authorName:i,platformName:"LinkedIn",iconName:"linkedin"}),s=n({username:a?.github,href:"github.com",authorName:i,platformName:"GitHub",iconName:"github"}),c=(({custom:t,authorName:a})=>t&&""!==t?`<a href="${t}" aria-label="${a}" rel="noopener norefferer"><deckgo-lazy-img svg-src="${e}/globe.svg" role="presentation" alt="" /></a>`:void 0)({custom:a?.custom,authorName:i});return void 0!==r||void 0!==o||void 0!==s||void 0!==c?`${[c,r,s,o].filter((t=>void 0!==t)).join("")}`:void 0},q=({selector:t})=>{let e=document.querySelector(`${t} > article *:nth-child(1)`),a=document.querySelector(`${t} > article *:nth-child(2)`),i=t=>{let e=t?.getAttribute("img-src");return 0===e?.indexOf("http")?e:void 0};if("deckgo-lazy-img"===e?.nodeName.toLowerCase())return i(e);if("deckgo-lazy-img"===a?.nodeName.toLowerCase())return i(a);let n=e?.querySelector("deckgo-lazy-img");return i(null!=n?n:a?.querySelector("deckgo-lazy-img"))},J=t=>{if(t&&void 0!==t)return t instanceof String||"string"==typeof t?new Date(`${t}`):"number"!=typeof t||isNaN(t)?t&&t.seconds>=0&&t.nanoseconds>=0?new Date(t.toDate()):t:new Date(t)};const Q=async()=>{const t=w();if(!t)throw new Error("No internet identity to get the canisters status");const[e,i]=await Promise.all([a({identity:t}),n({identity:t})]),{actor:r,bucketId:o}=e,{actor:s,bucketId:c}=i,[d,l]=await Promise.all([r.cyclesBalance(),s.cyclesBalance()]);return{data:{bucketId:o,balance:d},storage:{bucketId:c,balance:l}}},V=async()=>{var t,e;const a=w();if(!a)throw new Error("No internet identity to get the canisters controllers");const{getDataControllers:i,getStorageControllers:n}=await r({identity:a}),[s,c]=await Promise.all([i(),n()]);return{data:null!==(t=o(s))&&void 0!==t?t:[],storage:null!==(e=o(c))&&void 0!==e?e:[]}},X=async e=>{const a=w();if(!a)throw new Error("No internet identity to add the canisters controller");const{setDataController:i,setStorageController:n}=await r({identity:a});await Promise.all([i(t.fromText(e)),n(t.fromText(e))])},Y=async({startsWith:t,notContains:e})=>{const i=w();if(!i)return[];const{actor:n}=await a({identity:i});if(!n)return[];const r=(await n.list(c({startsWith:c(t),notContains:c(e)}))).map((([,t])=>Z({data:t,identity:i})));return Promise.all(r)},Z=async({data:t,identity:e})=>{const a=await l(t.data);return{id:t.id,data:Object.assign(Object.assign({},a),{owner_id:e.getPrincipal().toText()}),created_at:t.created_at,updated_at:t.updated_at}},tt=async({key:t,actor:e})=>{const a=e||await at(),i=o(await a.get(t));if(!i)return;const n=await l(i.data);return{id:i.id,data:n,created_at:i.created_at,updated_at:i.updated_at}},et=async()=>{const t=w();if(!t)throw new Error("No internet identity.");const e=await a({identity:t}),{actor:i,bucketId:n}=e;if(!i)throw new Error("No actor initialized.");if(!n)throw new Error("No bucket principal defined");return e},at=async()=>{const{actor:t}=await et();return t},it=async({key:t,record:e,updateTimestamps:a=!1,actor:i,log:n})=>{null==n||n({msg:`[set][start] ${t}`,level:"info"});const r=performance.now(),o=await(async({key:t,record:e,actor:a})=>{const i=a||await at(),{id:n,data:r,created_at:o,updated_at:s}=e,d=await i.put(t,{id:n,data:await u(r),created_at:c(o),updated_at:c(s)});return{id:n,data:r,created_at:d.created_at,updated_at:d.updated_at}})({key:t,actor:i,record:e});a&&await $(t,(({id:t,data:e})=>({id:t,data:e,created_at:o.created_at,updated_at:o.updated_at})));const s=performance.now();return null==n||n({msg:`[set][done] ${t}`,duration:s-r,level:"info"}),o},nt=async({key:t,actor:e,log:a,data:i})=>{if(!t||!i)return;null==a||a({msg:`[delete][start] ${t}`,level:"info"});const n=performance.now();await(async({key:t,actor:e,data:a})=>{const i=e||await at();await i.delete(t,a)})({key:t,actor:e,data:i});const r=performance.now();null==a||a({msg:`[delete][done] ${t}`,duration:r-n,level:"info"})},rt=async()=>Y({startsWith:"/decks/",notContains:"/slides/"}),ot=async(t,e)=>nt(Object.assign({key:`/decks/${t}`},void 0!==e&&{data:{id:t,updated_at:e}})),st=async({onNext:t})=>{const e=["deckPublished","deckFeedSubmitted"];return e.forEach((e=>document.addEventListener(e,(async({detail:e})=>await t(e)),{passive:!0}))),()=>e.forEach((e=>document.removeEventListener(e,(({detail:e})=>t(e)),!1)))},ct=async()=>Y({startsWith:"/docs/",notContains:"/paragraphs/"}),dt=async(t,e)=>nt(Object.assign({key:`/docs/${t}`},void 0!==e&&{data:{id:t,updated_at:e}})),lt=async({onNext:t})=>{const e=["docPublished","docFeedSubmitted"];return e.forEach((e=>document.addEventListener(e,(async({detail:e})=>await t(e)),{passive:!0}))),()=>e.forEach((e=>document.removeEventListener(e,(async({detail:e})=>await t(e)),!1)))},ut=(t,e)=>tt({key:`/docs/${t}/paragraphs/${e}`}),mt=(t,e)=>tt({key:`/decks/${t}/slides/${e}`});let pt=(t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce(((t,e)=>t+((e&=63)<36?e.toString(36):e<62?(e-26).toString(36).toUpperCase():e>62?"-":"_")),"");const gt=()=>Y({startsWith:"/templates/"}),ht=t=>{const e=pt(),a=new Date,i={id:e,data:Object.assign(Object.assign({},t),{updated_at:a,created_at:a})};return it({key:`/templates/${e}`,record:i})},wt=t=>{const{id:e}=t;return it({key:`/templates/${e}`,record:t})},yt=async t=>{y({msg:"[update][start] user",level:"info"});const e=performance.now(),a=await it({key:"/user",record:t}),i=performance.now();return y({msg:"[update][done] user",duration:i-e,level:"info"}),a},ft=({IDL:t})=>{const e=t.Principal,a=t.Record({storageId:t.Opt(e)}),i=t.Int,n=t.Record({linkedin:t.Opt(t.Text),twitter:t.Opt(t.Text),custom:t.Opt(t.Text),github:t.Opt(t.Text)}),r=t.Record({bio:t.Opt(t.Text),photo_url:t.Opt(t.Text),social:t.Opt(n),name:t.Text}),o=t.Record({title:t.Text,tags:t.Opt(t.Vec(t.Text)),description:t.Opt(t.Text),author:t.Opt(r)}),s=t.Record({id:t.Text,updated_at:i,meta:o,pathname:t.Text,storageId:e,created_at:i}),c=t.Variant({open:t.Null,accepted:t.Null,declined:t.Null}),d=t.Record({status:t.Opt(c)}),l=t.Variant({open:t.Null,accepted:t.Null,declined:t.Null}),u=t.Record({id:t.Text,meta:o,pathname:t.Text,storageId:e}),m=t.Record({status:l,updated_at:i,created_at:i,proposal:u}),p=t.Record({id:t.Text,meta:o,pathname:t.Text,storageId:e});return t.Service({accept:t.Func([t.Principal,t.Text],[],[]),decline:t.Func([t.Principal,t.Text],[],[]),del:t.Func([t.Principal,t.Text],[],[]),list:t.Func([t.Opt(a)],[t.Vec(t.Tuple(t.Text,s))],["query"]),listProposals:t.Func([t.Opt(d)],[t.Vec(t.Tuple(t.Text,m))],["query"]),submit:t.Func([t.Text,p],[],[])})},bt=async({doc:t})=>{const{data:{meta:e},id:a}=t;if(!e)throw new Error("No meta data to submit to feed");await _t({meta:e,id:a});const i=await vt({key:"docs",entry:t});return $t({data:i,type:"docFeedSubmitted"}),i},kt=async({deck:t})=>{const{data:{meta:e},id:a}=t;if(!e)throw new Error("No meta data to submit to feed");await _t({meta:e,id:a});const i=await vt({key:"decks",entry:t});return $t({data:i,type:"deckFeedSubmitted"}),i},_t=async({meta:t,id:e})=>{const a=w();if(!a)throw new Error("No internet identity to submit entry to feed");const{bucketId:i}=await n({identity:a});if(!i)throw new Error("No storage found. Is the document published?");y({msg:"[submit][start] feed",level:"info"});const r=performance.now(),o=await(({identity:t})=>m({canisterId:p.getInstance().get().feedCanisterId,idlFactory:ft,identity:t}))({identity:a}),s=p.getInstance().get().feedSecret,{pathname:d,title:l,description:u,tags:g,author:h}=t;if(!d)throw new Error("No pathname found. Is the document published?");await o.submit(s,{id:e,storageId:i,pathname:t.pathname,meta:{title:l,description:c(u),tags:c(g),author:c(h?{name:h.name,bio:c(h.bio),photo_url:c(h.photo_url),social:c(h.social?{twitter:c(h.social.twitter),linkedin:c(h.social.linkedin),github:c(h.social.github),custom:c(h.social.custom)}:void 0)}:void 0)}});const f=performance.now();y({msg:"[submit][done] feed",duration:f-r,level:"info"})},vt=async({key:t,entry:e})=>{var a;y({msg:`[update][start] ${t}`,level:"info"});const i=performance.now(),{id:n,data:r}=e,o=await D(`/${t}/${n}`),s=null!==(a=null==o?void 0:o.data)&&void 0!==a?a:r,c={id:n,data:Object.assign(Object.assign({},s),{meta:Object.assign(Object.assign({},s.meta),{feed:!0}),updated_at:new Date}),created_at:o.created_at,updated_at:o.updated_at},d=await it({key:`/${t}/${n}`,record:c,updateTimestamps:!0}),l=performance.now();return y({msg:`[update][done] ${t}`,duration:l-i,level:"info"}),d},$t=({data:t,type:e})=>{const a=new CustomEvent(e,{detail:t});document.dispatchEvent(a)},Dt=async({key:t,ids:e})=>{const i=w();if(!i)throw new Error("No internet identity to get the count of interactions");const{actor:{listInteractions:n}}=await a({identity:i}),r=`/${t}/`,s=await n(e.map((t=>`${r}${t}`)));return(await Promise.all(s.map((t=>(async t=>{const{countLikes:e,like:a,countComments:i}=t[1],n=o(a),s={countLikes:e,like:void 0!==n?await Ot(n):void 0,countComments:i};return{[t[0].replace(r,"")]:s}})(t))))).reduce(((t,e)=>Object.assign(Object.assign({},t),e)),{})},Ot=async t=>{const e=await l(t.data);return{id:t.id,data:e,created_at:t.created_at,updated_at:t.updated_at,author_id:t.author.toText()}},jt=async({like:t,identity:e,key:a,id:i})=>{const n=new Date,r=void 0===t?{id:pt(),data:{like:!0,created_at:n,updated_at:n},author_id:e.getPrincipal().toText()}:Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{like:!t.data.like})}),{id:o,data:s,created_at:d,updated_at:l}=r;return{putKey:It({key:a,id:i,identity:e}),putInteraction:{id:o,data:await u(s),author:e.getPrincipal(),created_at:c(d),updated_at:c(l)}}},It=({key:t,id:e,identity:a})=>`/${t}/${e}/likes/${a.getPrincipal().toText()}`,Ut=async({key:t,id:e,interaction:i})=>{const n=w();if(!n)throw new Error("No internet identity to save the interaction");const{actor:{putInteraction:r}}=await a({identity:n}),{putKey:o,putInteraction:s}=await jt({key:t,id:e,like:i,identity:n}),c=await r(o,s);return Ot(c)},Ct=({identity:t,canisterId:e})=>m({canisterId:e,idlFactory:h,identity:t}),Et=async({key:t,id:e,canisterId:a})=>{const i=w(),{countLikes:n}=await Ct({identity:i,canisterId:a});return n(`/${t}/${e}`)},xt=async({key:t,id:e,canisterId:a})=>{const i=w();if(!i)return;const{getLike:n}=await Ct({identity:i,canisterId:a}),r=o(await n(It({key:t,id:e,identity:i})));return r?Ot(r):void 0},At=async({key:t,id:e,like:a,canisterId:i})=>{const n=w();if(!n)throw new Error("No internet identity to record the like");const{putInteraction:r}=await Ct({identity:n,canisterId:i}),{putKey:o,putInteraction:s}=await jt({key:t,id:e,like:a,identity:n}),c=await r(o,s);return Ot(c)},Pt=async({data:t,filename:e,folder:a,storageActor:i,headers:n,token:r,fullPath:o,log:s,sha256:d})=>{s({msg:`[upload][start] ${e}`,level:"info"});const l=performance.now(),u=o||`/${a}/${e}`,{batch_id:m}=await i.initUpload({name:e,full_path:u,token:c(r),folder:a,sha256:c(d)}),p=performance.now();s({msg:`[upload][create batch] ${e}`,duration:p-l,level:"info"});const g=7e5,h=[],w=new Blob([await t.arrayBuffer()]);for(let t=0;t<w.size;t+=g){const e=w.slice(t,t+g);h.push(await Nt({batchId:m,chunk:e,storageActor:i}))}const y=performance.now();s({msg:`[upload][chunks] ${e}`,duration:y-p,level:"info"}),await i.commitUpload({batch_id:m,chunk_ids:h.map((({chunk_id:t})=>t)),headers:[["Content-Type",t.type],["accept-ranges","bytes"],...n]});const f=performance.now();return s({msg:`[upload][commit batch] ${e}`,duration:f-y,level:"info"}),s({msg:`[upload][done] ${e}`,duration:f-l,level:"info"}),{fullPath:u,filename:e,token:r}},Nt=async({batchId:t,chunk:e,storageActor:a})=>a.uploadChunk({batch_id:t,content:[...new Uint8Array(await e.arrayBuffer())]}),Tt=t=>encodeURI(t.toLowerCase().replace(/\s/g,"-")),Ft=async()=>{const t=w();if(!t)throw new Error("No internet identity.");const e=await n({identity:t}),{actor:a,bucketId:i}=e;if(!a)throw new Error("No actor initialized.");if(!i)throw new Error("No bucket principal defined");return e},Kt=t=>{const e=(new TextEncoder).encode(t);return crypto.subtle.digest("SHA-256",e)},St=t=>btoa([...t].map((t=>String.fromCharCode(t))).join("")),Lt=({social_image_link:t})=>void 0!==t&&t.includes("unsplash.com"),Gt=async({storageUpload:t,publishData:e})=>{const{social_image_name:a,social_image_value:i}=e;if(Lt(e))return;if(!i)return;const{actor:n}=t;await Pt({data:i,filename:`${a}.png`,folder:"meta",storageActor:n,headers:[["Cache-Control","max-age=3600"]],log:y})},zt=async({template:t,data:e,ids:a})=>{const i=[...Object.entries(e),...Object.entries(a)].reduce(((t,[e,a])=>t.replaceAll(`{{DECKDECKGO_${e.toUpperCase()}}}`,a||"").replaceAll(`%%DECKDECKGO_${e.toUpperCase()}%%`,a||"").replaceAll(`\x3c!-- DECKDECKGO_${e.toUpperCase()} --\x3e`,a||"")),t),{data_canister_id:n,storage_canister_id:r}=a,{data_id:o}=a,s=`window.data_canister_id = "${n}";window.storage_canister_id = "${r}";window.data_id = "${null!=o?o:""}";`,c=i.replaceAll("\x3c!-- DECKDECKGO_IDS_SCRIPT --\x3e",`<script>${s}<\/script>`),d=St(new Uint8Array(await Kt(s)));return c.replaceAll("{{DECKDECKGO_IDS_SHAS}}",`'sha256-${d}'`)},Rt=async({indexHTML:t,folder:e,meta:a})=>{const{html:i,publishData:n}=t,{bucketId:r,actor:o}=await Ft(),{filename:s,pathname:c}=Mt({publishData:n,meta:a,folder:e}),d=`https://${r.toText()}.raw.icp0.io`,l=`${d}${c}`;let u=i.replace("{{DECKDECKGO_URL}}",l);return u=(({html:t,data:e,bucketUrl:a})=>{const{social_image_name:i}=e;if(Lt(e)){const{social_image_link:a}=e;return t.replaceAll("{{DECKDECKGO_SOCIAL_IMAGE}}",a)}return t.replaceAll("{{DECKDECKGO_SOCIAL_IMAGE}}",`${a}/meta/${i}.png`)})({html:u,data:n,bucketUrl:d}),{storageUpload:{html:u,actor:o,filename:s,pathname:c,fullUrl:l,bucketUrl:d,folder:e},publishData:n}},Mt=({publishData:t,meta:e,folder:a})=>{if(null==e?void 0:e.pathname){const{pathname:t}=e;return{filename:t.replace(`/${a}/`,""),pathname:t}}const i=Tt(t.title);return{filename:i,pathname:`/${a}/${i}`}},Bt=async({publishData:t,ids:e,updateTemplateContent:a,sourceFolder:i})=>{const n=await Ht(i),r=await zt({template:n,data:t,ids:e}),{attributes:o}=t;return{html:a({attr:o?Object.entries(o).reduce(((t,[e,a])=>`${e}="${a}"; ${t}`),"").trim():void 0,template:r})}},Ht=async t=>(await fetch(`${p.getInstance().get().kitPath}/${t}/index.html`)).text(),Wt=({data:t,storageUpload:e,meta:a,name:i})=>{var n;const{pathname:r}=e,o=new Date;return Object.assign(Object.assign({},t),{meta:Object.assign(Object.assign({},a||{title:i}),{pathname:r,published:!0,published_at:null!==(n=a.published_at)&&void 0!==n?n:o,updated_at:o})})},qt=async({filename:t,html:e,actor:a,folder:i})=>{await Pt({data:new Blob([e],{type:"text/html"}),filename:t,folder:i,storageActor:a,headers:[["Cache-Control","max-age=3600"]],log:y})},Jt=()=>p.getInstance().get().author;const Qt=({content:t,bucketUrl:e,metas:a,selector:i})=>{const n=a.map((({dataId:t,meta:a})=>Vt({dataId:t,meta:a,bucketUrl:e})));return t.replace(i,n.join(""))},Vt=({dataId:t,bucketUrl:e,meta:a})=>{var i,n;const{title:r,pathname:o}=a,s=`${e}${o}`,c=null!=(null==a?void 0:a.description)&&""!==(null==a?void 0:a.description)?`<p class="description">${a.description}</p>`:"",{format:d}=new Intl.DateTimeFormat("en",{year:"numeric",month:"short",day:"2-digit",hour:"numeric",minute:"numeric",second:"numeric"});return`<a data-id="${t}" href="${s}" rel="noopener noreferrer"><article><div><h3>${r}</h3>${c}</div><div><p>Published: ${d(null!==(i=J(null==a?void 0:a.published_at))&&void 0!==i?i:new Date)}</p><p>Edited: ${d(null!==(n=J(null==a?void 0:a.updated_at))&&void 0!==n?n:new Date)}</p></div></article></a>`},Xt=t=>`<url>\n  <loc>${t}</loc>\n  <changefreq>daily</changefreq>\n  <priority>0.7</priority>\n</url>`,Yt=t=>t.filter((({data:t})=>{var e;return!0===(null===(e=t.meta)||void 0===e?void 0:e.published)})).sort((({data:{meta:{published_at:t}}},{data:{meta:{published_at:e}}})=>{var a,i;return((null===(a=J(e))||void 0===a?void 0:a.getTime())||0)-((null===(i=J(t))||void 0===i?void 0:i.getTime())||0)})).map((({id:t,data:{meta:e}})=>({dataId:t,meta:e}))),Zt=async({storageUpload:t,publishData:e,entries:a,canisterIds:i})=>{const n=Yt(a),r=[ae({storageUpload:t,publishData:e,metas:n,canisterIds:i}),ee({storageUpload:t,metas:n}),te({storageUpload:t,metas:n,publishData:e})];await Promise.all(r)},te=async({storageUpload:t,metas:e,publishData:a})=>{const{bucketUrl:i,actor:n}=t,{author:r}=a,o=(({bucketUrl:t,metas:e,author:a})=>(({items:t,author:e,bucketUrl:a})=>`<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" version="2.0">\n    <channel>\n        <title><![CDATA[${e} blog]]></title>\n        <description><![CDATA[The latest blog posts of ${e}]]></description>\n        <link>${a}</link>\n        <lastBuildDate>${(new Date).toUTCString()}</lastBuildDate>\n        \n        ${t}\n    </channel>\n</rss>`)({bucketUrl:t,items:(({metas:t,bucketUrl:e})=>t.map((({meta:{title:t,description:a,pathname:i,published_at:n}})=>{var r;return`\n  <item>\n    <title><![CDATA[${t}]]></title>\n    <description><![CDATA[${null!=a?a:t}]]></description>\n    <link>${e}${i}</link>\n    <pubDate>${(null!==(r=J(n))&&void 0!==r?r:new Date).toUTCString()}</pubDate>\n  </item>\n`})))({metas:e,bucketUrl:t}).join(""),author:a}))({bucketUrl:i,metas:e,author:r||Jt()});await re({rss:o,actor:n})},ee=async({storageUpload:t,metas:e})=>{const{bucketUrl:a,actor:i}=t,n=(({bucketUrl:t,metas:e})=>`<?xml version="1.0" encoding="UTF-8" ?>\n  <urlset\n    xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"\n    xmlns:news="http://www.google.com/schemas/sitemap-news/0.9"\n    xmlns:xhtml="http://www.w3.org/1999/xhtml"\n    xmlns:image="http://www.google.com/schemas/sitemap-image/1.1"\n    xmlns:video="http://www.google.com/schemas/sitemap-video/1.1"\n  >\n    ${[Xt(t),...e.map((({meta:{pathname:e}})=>Xt(`${t}${e}`)))].join("")}\n</urlset>`)({bucketUrl:a,metas:e});await ne({sitemap:n,actor:i})},ae=async({storageUpload:t,publishData:e,metas:a,canisterIds:i})=>{const{bucketUrl:n,actor:r}=t,o=await(async({bucketUrl:t,publishData:e,metas:a,canisterIds:i})=>{const n=await(async()=>(await fetch(`${p.getInstance().get().kitPath}/index.html`)).text())(),{photo_url:r}=e,o=function(t,e){var a={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(a[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(t,i[n])&&(a[i[n]]=t[i[n]])}return a}(e,["photo_url"]);let s=await zt({template:n,data:o,ids:i});return s=(({photo_url:t,html:e})=>t?e.replace("\x3c!-- DECKDECKGO_PHOTO_URL --\x3e",`<img role="presentation" alt="" loading="lazy" src="${t}" />`):e)({html:s,photo_url:r}),s=Qt({content:s,bucketUrl:t,metas:a,selector:/<!-- DECKDECKGO_DATA -->/}),s})({bucketUrl:n,publishData:e,metas:a,canisterIds:i});await ie({html:o,actor:r})},ie=async({html:t,actor:e})=>oe({actor:e,content:t,mimeType:"text/html",fullPath:"/",filename:"index.html"}),ne=async({sitemap:t,actor:e})=>oe({actor:e,content:t,mimeType:"application/xml",fullPath:"/sitemap.xml",filename:"sitemap.xml",maxAge:3600}),re=async({rss:t,actor:e})=>oe({actor:e,content:t,mimeType:"application/xml",fullPath:"/rss.xml",filename:"rss.xml",maxAge:3600}),oe=async({content:t,actor:e,mimeType:a,filename:i,fullPath:n,maxAge:r=0})=>{await Pt({data:new Blob([t],{type:a}),filename:i,folder:"resources",storageActor:e,headers:[["Cache-Control",`max-age=${r}`]],fullPath:n,log:y})},se=async({bucketUrl:t,identity:e})=>{const a=await ct(e.getPrincipal().toText()),i=Yt(a),n=await(async({metas:t,bucketUrl:e})=>{const a=await(async t=>{const e=await fetch(t);if(e.ok)return e.text()})(e);if(!a)return;const i=[...a.matchAll(/<section id="posts"[\s\S]*?>([\s\S]*?)<\/section>/gm)];return i.length<1&&i[0].length<2?void 0:Qt({content:a,metas:t,bucketUrl:e,selector:i[0][1]})})({bucketUrl:t,metas:i});if(!n)return;const{actor:r}=await Ft();await ie({html:n,actor:r})},ce=()=>p.getInstance().get().kitPath,de=async({meta:t,ids:e})=>{const{actor:a}=await Ft(),i=await a.list(c("resources")),n=(await ge()).map((n=>ue({kit:n,actor:a,meta:t,ids:e,assetKeys:i})));await Promise.all(n)},le=({src:t,sha256:e,assetKeys:a})=>{var i;const n=t.replace(ce(),""),r=a.find((({full_path:t})=>n===t)),s=St(new Uint8Array(null!==(i=o(null==r?void 0:r.sha256))&&void 0!==i?i:[]));return void 0===r||void 0===e||e!==s},ue=async({kit:t,actor:e,meta:a,ids:i,assetKeys:n})=>{const{updateContent:r}=t;if(void 0!==r)return void await(async({kit:t,actor:e,meta:a,ids:i,assetKeys:n})=>{const{src:r,filename:o,mimeType:s,updateContent:c,headers:d}=t,l=c({content:await pe(r),meta:a,ids:i}),u=St(new Uint8Array(await Kt(l)));le({src:r,sha256:u,assetKeys:n})&&await me({filename:o,content:l,actor:e,mimeType:s,headers:d,fullPath:r.replace(ce(),"")})})({kit:t,actor:e,meta:a,ids:i,assetKeys:n});const{src:o,filename:s,mimeType:c,headers:d,sha256:l}=t;if(!le({src:o,sha256:l,assetKeys:n}))return;const u=await pe(o),m=r?r({content:u,meta:a,ids:i}):u;await me({filename:s,content:m,actor:e,mimeType:c,headers:d,fullPath:o.replace(ce(),"")})},me=async({filename:t,fullPath:e,content:a,actor:i,mimeType:n,headers:r})=>{const o=[...new Uint8Array(await Kt(a))];await Pt({data:new Blob([a],{type:n}),filename:t,folder:"resources",storageActor:i,fullPath:e,headers:r,log:y,sha256:o})},pe=async t=>(await fetch(t)).text(),ge=async()=>{const t=ce();return(await(await fetch(`${t}/build.json`)).json()).map((e=>(e=>{const a="string"==typeof e?`${t}/${e}`:`${t}/${e.fullPath}`,i="string"==typeof e?void 0:e.sha256;return a.includes("hoisted.js")?{src:a,mimeType:"text/javascript",sha256:i,updateContent:({content:t,ids:{data_canister_id:e,data_id:a,storage_canister_id:i}})=>t.replace("{{DECKDECKGO_DATA_CANISTER_ID}}",e).replace("{{DECKDECKGO_STORAGE_CANISTER_ID}}",i).replace("{{DECKDECKGO_DATA_ID}}",a)}:a.includes(".js")?{src:a,mimeType:"text/javascript",sha256:i}:a.includes(".css")?{src:a,mimeType:"text/css",sha256:i}:a.includes(".webmanifest")?{src:a,mimeType:"application/manifest+json",sha256:i,updateContent:({content:t,meta:e})=>{var a;return t.replace("{{DECKDECKGO_AUTHOR}}",(null===(a=null==e?void 0:e.author)||void 0===a?void 0:a.name)||Jt())}}:{src:a,mimeType:"text/plain",sha256:i}})(e))).map((t=>{const{pathname:e}=new URL(t.src);return Object.assign(Object.assign({},t),{filename:e.split("/").pop(),headers:[["Cache-Control","max-age=31536000"]]})}))},he=async({deck:t})=>{const e=await ye();await de({meta:t.data.meta,ids:Object.assign(Object.assign({},e),{data_id:t.id})});const{storageUpload:a,publishData:i,deck:n}=await(async({deck:t,canisterIds:e})=>{const{id:a,data:i}=t,{meta:n}=i,r=await(async({deck:t,canisterIds:e})=>{const a=await(async({deck:t,fallbackAuthor:e})=>{let{data:a}=t,{meta:i,background:n,footer:r,header:o}=a??{};return{...await L({meta:i,selector:F,fallbackName:a?.name??"",fallbackAuthor:e}),slides:M(),background:n?`<div slot="background">${n}</div>`:void 0,header:n?`<div slot="header">${o}</div>`:void 0,footer:n?`<div slot="footer">${r}</div>`:void 0}})({deck:t,fallbackAuthor:p.getInstance().get().author}),{slides:i}=a,{html:n}=await Bt({publishData:a,ids:Object.assign(Object.assign({},e),{data_id:t.id}),updateTemplateContent:({attr:t,template:e})=>e.replace("\x3c!-- DECKDECKGO_DECK --\x3e",`<deckgo-deck id="slider" embedded="true" ${t||""}>${i.join("")}</deckgo-deck>`),sourceFolder:"p"});return{html:n,publishData:a}})({deck:t,canisterIds:e}),{storageUpload:o,publishData:s}=await Rt({indexHTML:r,folder:"p",meta:n}),c=Wt({data:i,meta:i.meta,name:i.name,storageUpload:o});await $(`/decks/${a}`,(t=>Object.assign(Object.assign({},t),{data:c})));const d=await D(`/decks/${a}`),l=await it({key:`/decks/${a}`,record:d,updateTimestamps:!0});return await qt(o),await Gt({storageUpload:o,publishData:s}),{storageUpload:o,publishData:s,deck:l}})({deck:t,canisterIds:e});return await(async({storageUpload:t,publishData:e,canisterIds:a})=>{y({msg:"[list][start] decks",level:"info"});const i=await rt();y({msg:"[list][start] end",level:"info"}),await Zt({storageUpload:t,publishData:e,entries:i,canisterIds:a})})({storageUpload:a,publishData:i,owner_id:t.data.owner_id,canisterIds:e}),(t=>{const{id:e,data:a}=t,i={id:e,data:Object.assign(Object.assign({},a),{deploy:{api:{status:"successful",updated_at:new Date}}})},n=new CustomEvent("deckPublished",{detail:i});document.dispatchEvent(n)})(n),n},we=async({doc:t,config:e})=>{const a=await ye();await de({meta:t.data.meta,ids:Object.assign(Object.assign({},a),{data_id:t.id})});const{storageUpload:i,publishData:n,doc:r}=await(async({doc:t,config:e,canisterIds:a})=>{const{id:i,data:n}=t,{meta:r}=n,o=await(async({doc:t,config:e,canisterIds:a})=>{const{theme:i,socialImgPath:n}=e,r=await(async({doc:t,fallbackAuthor:e,theme:a,socialImgPath:i})=>{let{data:n}=t,{meta:r}=n??{};return{...await L({meta:r,selector:K,fallbackName:n?.name??"",fallbackAuthor:e,socialImgPath:i}),paragraphs:B(),theme:a,social_image_link:q({selector:K})}})({doc:t,fallbackAuthor:p.getInstance().get().author,theme:i,socialImgPath:n}),{paragraphs:o}=r,{html:s}=await Bt({publishData:r,ids:Object.assign(Object.assign({},a),{data_id:t.id}),updateTemplateContent:({attr:t,template:e})=>e.replace("\x3c!-- DECKDECKGO_DOC --\x3e",`<article ${t||""} class="deckgo-doc">${o.join("")}</article>`),sourceFolder:"d"});return{html:s,publishData:r}})({doc:t,config:e,canisterIds:a}),{storageUpload:s,publishData:c}=await Rt({indexHTML:o,folder:"d",meta:r}),d=Wt({data:n,meta:n.meta,name:n.name,storageUpload:s});await $(`/docs/${i}`,(t=>Object.assign(Object.assign({},t),{data:d})));const l=await D(`/docs/${i}`),u=await it({key:`/docs/${i}`,record:l,updateTimestamps:!0});return await qt(s),await Gt({storageUpload:s,publishData:c}),{storageUpload:s,publishData:c,doc:u}})({doc:t,config:e,canisterIds:a});return await(async({storageUpload:t,publishData:e,canisterIds:a})=>{y({msg:"[list][start] docs",level:"info"});const i=await ct();y({msg:"[list][end] docs",level:"info"}),await Zt({storageUpload:t,publishData:e,entries:i,canisterIds:a})})({storageUpload:i,publishData:n,owner_id:t.data.owner_id,canisterIds:a}),(t=>{const{id:e,data:a}=t,i={id:e,data:Object.assign(Object.assign({},a),{deploy:{api:{status:"successful",updated_at:new Date}}})},n=new CustomEvent("docPublished",{detail:i});document.dispatchEvent(n)})(r),r},ye=async()=>{const[{bucketId:t},{bucketId:e}]=await Promise.all([et(),Ft()]);return{data_canister_id:t.toText(),storage_canister_id:e.toText()}},fe=async()=>{const{bucketId:t}=await Ft();return p.getInstance().localIdentity()?`http://${t.toText()}.localhost:8000`:`https://${t.toText()}.raw.icp0.io`},be=async()=>{const t=w();if(!t)throw new Error("No internet identity provided to list the entries that should be listed on the landing page");const e=await fe();await se({bucketUrl:e,identity:t})},ke=async({data:t,folder:e,maxSize:a})=>{const i=w();return _e({data:t,folder:e,maxSize:a,identity:i,log:y})},_e=async({data:t,maxSize:e,folder:a,identity:i,storageBucket:r,log:o})=>{if(!t||!t.name)throw new Error("File not valid.");if(t.size>e)throw new Error(`File is too big (max. ${e/1048576} Mb)`);const{actor:s,bucketId:c}=r||await n({identity:i});if(!s||!c)throw new Error("Storage bucket is not initialized.");const{fullPath:d,filename:l,token:u}=await Pt({data:t,filename:Tt(t.name),folder:a,storageActor:s,token:pt(),headers:[["cache-control","private, max-age=0"]],log:o});return{downloadUrl:`https://${c.toText()}.raw.icp0.io${d}?token=${u}`,fullPath:d,name:l}},ve=async({folder:t})=>{const{actor:e,bucketId:a}=await Ft(),i=await e.list(c(t)),n=`https://${a.toText()}.raw.icp0.io`;return{items:i.map((({name:t,full_path:e,token:a})=>({downloadUrl:`${n}${e}?token=${a}`,fullPath:e,name:t}))),nextPageToken:null}},$e=async({downloadUrl:t,fullPath:e})=>{const{actor:a}=await Ft();let i=null;if(t){const{searchParams:e}=new URL(t);i=e.get("token")}return a.del({full_path:e,token:c(i||void 0)})},De=({data:t,storageFile:e,src:a})=>{const{downloadUrl:i,name:n}=e;let r=t.replaceAll(`img-src="${a}"`,`img-src="${i}"`);return r=r.replaceAll(`img-alt="${a}"`,`img-alt="${n}"`),r=r.replaceAll(`data-src="${a}"`,`data-src="${i}"`),r},Oe=async({selector:t,storageFile:e,folder:a,src:i})=>{const n=document.querySelector(t);if("deckgo-lazy-img"===(null==n?void 0:n.nodeName.toLowerCase()))return void await je({images:[n],storageFile:e,folder:a,src:i});const r=null==n?void 0:n.querySelectorAll("deckgo-lazy-img");await je({images:Array.from(r),storageFile:e,folder:a,src:i})},je=async({storageFile:t,folder:e="images",images:a,src:i})=>{const n=a.filter((t=>"data"===e?t.getAttribute("data-src")===i:t.imgSrc===i));if(!n||n.length<=0)return;const r=Array.from(n).map((a=>"data"===e?(async e=>{const{downloadUrl:a}=t;e.setAttribute("data-src",a)})(a):(async e=>{const{downloadUrl:a,name:i}=t;e.imgSrc=a,e.imgAlt=i})(a)));await Promise.all(r)},Ie=async({storageFile:t,src:e,key:a})=>{const i=(({paragraph:t,files:e})=>{if(!e)return Object.assign({},t);const a=e.filter((({src:t,storageFile:e})=>void 0!==t&&void 0!==e));let{children:i,nodeName:n,attributes:r}=t.data;return"deckgo-lazy-img"===n&&r&&a.forEach((({src:t,storageFile:e})=>{r=(({attributes:t,storageFile:e,src:a})=>{const{downloadUrl:i}=e;return Object.keys(t).reduce(((e,n)=>(e[n]=t[n]===a?i:t[n],e)),{})})({attributes:r,storageFile:e,src:t})})),i=null==i?void 0:i.map((t=>(a.forEach((({src:e,storageFile:a})=>{t=De({data:t,storageFile:a,src:e})})),t))),Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,children:i,attributes:r})})})({paragraph:await Ue({key:a}),files:[{src:e,storageFile:t}]});await Ce({key:a,data:i})},Ue=async({key:t})=>{const e=await D(t);if(!e)throw new Error("Data not found and that is really weird here.");return e},Ce=async({key:t,data:e})=>O(t,e),Ee=_(import("./p-afcaf059.js").then((t=>t.worker)),"stencil.sync.ic.worker","uploadWorker"),xe=async({msg:t,data:e})=>{"deckdeckgo_sync_deck_background"===t&&await(async t=>{(({storageFile:t})=>{const e=document.querySelector(`${F} > *[slot="background"]`),a=null==e?void 0:e.querySelector("deckgo-lazy-img");if(!a)return;const{downloadUrl:i,name:n}=t;a.imgSrc=i,a.imgAlt=n})(t),await(async({storageFile:t,src:e})=>{const a=document.querySelectorAll(`${F} .deckgo-slide-container:not([custom-background]) *[slot="background"] deckgo-lazy-img`);await je({images:Array.from(a),storageFile:t,src:e})})(t),await(async({storageFile:t,src:e,key:a})=>{const i=(({deck:t,storageFile:e,imgSrc:a})=>e&&a?Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,background:De({data:t.data.background,src:a,storageFile:e})})}):Object.assign({},t))({deck:await Ue({key:a}),imgSrc:e,storageFile:t});await Ce({key:a,data:i})})(t)})(e),"deckdeckgo_sync_slide_image"===t&&await(async t=>{const{selector:e}=t;e&&(await Oe(t),await(async({storageFile:t,src:e,key:a})=>{const i=(({slide:t,images:e})=>{if(!e)return Object.assign({},t);const a=e.filter((({src:t,storageFile:e})=>void 0!==t&&void 0!==e));let{content:i}=t.data;return a.forEach((({src:t,storageFile:e})=>{i=De({data:i,storageFile:e,src:t})})),Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,content:i})})})({slide:await Ue({key:a}),images:[{src:e,storageFile:t}]});await Ce({key:a,data:i})})(t))})(e),"deckdeckgo_sync_slide_chart"===t&&await(async t=>{const{selector:e}=t;e&&((({selector:t,storageFile:e})=>{const a=document.querySelector(t);if(!a||!a.nodeName||"deckgo-slide-chart"!==a.nodeName.toLowerCase())return;const{downloadUrl:i}=e;a.src=i})(t),await(async({storageFile:t,src:e,key:a})=>{const i=(({slide:t,chart:e})=>{if(!e)return Object.assign({},t);const{src:a,storageFile:i}=e;if(!a||!i)return Object.assign({},t);const{attributes:n}=t.data;if(!n)return Object.assign({},t);const{downloadUrl:r}=i;return Object.assign(Object.assign({},t),{data:Object.assign(Object.assign({},t.data),{updated_at:new Date,attributes:Object.assign(Object.assign({},n),{src:r})})})})({slide:await Ue({key:a}),chart:{src:e,storageFile:t}});await Ce({key:a,data:i})})(t))})(e),"deckdeckgo_sync_paragraph_image"===t&&await(async t=>{const{selector:e}=t;e&&(await Oe(t),await Ie(t))})(e)},Ae=async({syncData:t,clean:e})=>{const a=w(),[i,n]=await(async()=>{const t=j("auth-client-db","ic-keyval"),[e,a]=await I([f,k],t);return[a,e]})();if(!a||!n)throw y({msg:"[identity] no internet identity to sync data. Please login again.",level:"error"}),new Error("No internet identity to sync data. Please login again.");if(!0!==await v())throw y({msg:"[identity] internet identity has expired. Please login again.",level:"error"}),new Error("Internet identity has expired. Please login again.");if(!U(C.fromJSON(i)))throw y({msg:"[identity] delegation has expired. Please login again.",level:"error"}),new Error("Delegation has expired. Please login again.");await Ee({syncData:t,env:p.getInstance().get()},xe,y),await e(t)};export{X as addCanistersController,Q as canistersBalance,V as canistersControllers,Et as countLikes,ht as createTemplate,rt as deckEntries,he as deckPublish,kt as deckSubmitFeed,ot as deleteDeck,dt as deleteDoc,$e as deleteFile,ct as docEntries,we as docPublish,bt as docSubmitFeed,ve as getFiles,xt as getLike,ut as getParagraph,mt as getSlide,gt as getUserTemplates,jt as initLikePut,At as likeDislike,It as likeKey,Dt as listInteractions,fe as publishUrl,Ut as putInteraction,st as snapshotDeck,lt as snapshotDoc,Ae as sync,Ot as toInteraction,be as updateLanding,wt as updateTemplate,yt as updateUser,ke as uploadFile,_e as uploadFileIC}